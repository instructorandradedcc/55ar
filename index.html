<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visor AR Arquitectura por Geolocalización</title>
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- A-Frame y AR.js - Cargar en orden correcto -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
            }
        }
    </script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }
        
        .page {
            display: none;
            height: 100%;
            width: 100%;
            position: relative;
        }
        
        .page.active {
            display: block;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .control-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .control-button:hover {
            background-color: #45a049;
        }
        
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        
        #message-box.show {
            opacity: 1;
        }
        
        /* Estilos específicos para AR.js */
        .arjs-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            z-index: 10000;
            text-align: center;
        }
        
        .arjs-loader div {
            margin-bottom: 20px;
        }
        
        .arjs-loader p {
            margin: 0;
            padding: 0;
        }
        
        /* Controles AR */
        .ar-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            gap: 10px;
        }
        
        .ar-info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9998;
            min-width: 200px;
        }
        
        .ar-scale-control {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            z-index: 9998;
        }
        
        /* Mapa */
        #map-container {
            position: absolute;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        #map-canvas {
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        #model-preview-canvas {
            position: absolute;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            pointer-events: none;
            z-index: 401;
            display: block;
        }
        
        .map-ui-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 300px;
        }
        
        #map-controls {
            position: fixed;
            top: 70px; 
            right: 20px; 
            z-index: 402; 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
        }
        
        #map-crosshair {
            position: absolute; 
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px; 
            height: 30px; 
            border: 2px solid white;
            border-radius: 50%; 
            box-shadow: 0 0 10px black;
            pointer-events: none; 
            z-index: 402;
        }
        
        #coords-jumpto {
            position: fixed; 
            top: 20px; 
            left: 20px; 
            z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px; 
            border-radius: 8px; 
            display: flex; 
            gap: 5px; 
            align-items: center;
        }
        
        /* Estilos para inputs de escala */
        .scale-input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        
        .scale-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .scale-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .scale-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        /* Indicador de GPS */
        .gps-indicator {
            position: fixed;
            top: 80px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9998;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .gps-indicator.active {
            background-color: rgba(76, 175, 80, 0.8);
        }
        
        .gps-indicator.error {
            background-color: rgba(244, 67, 54, 0.8);
        }
        
        .gps-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #4CAF50;
            animation: gps-pulse 2s infinite;
        }
        
        @keyframes gps-pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        /* Panel de coordenadas del modelo */
        .model-coords-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9998;
            min-width: 200px;
        }
        
        .coord-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .coord-label {
            font-weight: bold;
            color: #4CAF50;
        }
        
        .coord-value {
            font-family: monospace;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            #map-controls {
                top: 120px !important;
                right: 10px !important;
            }
            .map-ui-container {
                width: 280px !important;
                bottom: 10px !important;
            }
            #coords-jumpto {
                top: 70px !important;
                left: 10px !important;
            }
        }
    </style>
</head>
<body>
    <!-- PÁGINA 1: Carga de Archivos y Coordenadas -->
    <div id="upload-page" class="page active">
        <div class="flex items-center justify-center h-full bg-gray-100">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Configuración de Escena AR<span id="version-display" class="text-sm align-middle font-normal text-gray-400 ml-2"></span></h1>
                <div id="upload-section" class="space-y-4">
                    <div>
                        <label for="model-upload" class="block mb-2 text-sm font-medium text-gray-700">1. Subir Modelo 3D (.glb)</label>
                        <input type="file" id="model-upload" accept=".glb" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="latitude-input" class="block mb-2 text-sm font-medium text-gray-700">2. Latitud</label>
                            <input type="number" id="latitude-input" placeholder="Ej: 4.0950" step="any" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label for="longitude-input" class="block mb-2 text-sm font-medium text-gray-700">3. Longitud</label>
                            <input type="number" id="longitude-input" placeholder="Ej: -76.1950" step="any" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    <button id="use-location-btn" class="w-full text-sm text-blue-500 hover:underline text-left pt-1">Usar mi ubicación actual</button>
                </div>
                <div id="status-section" class="mt-6 text-center hidden">
                    <p id="status-text" class="text-lg font-semibold text-green-600">Modelo y ubicación cargados desde caché.</p>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap:4">
                    <button id="load-data-btn" class="control-button bg-green-500 hover:bg-green-600 w-full sm:w-auto">Cargar y Guardar</button>
                    <button id="goto-map-btn" class="control-button bg-indigo-500 hover:bg-indigo-600 w-full sm:w-auto" disabled>Ver en Mapa</button>
                </div>
                <div class="mt-4 text-center">
                    <button id="clear-cache-btn" class="text-sm text-red-500 hover:underline">Limpiar Caché y Recargar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PÁGINA 2: Vista de Mapa -->
    <div id="map-page" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <div id="map-crosshair"></div>
            <canvas id="model-preview-canvas"></canvas>
        </div>
        <div id="coords-jumpto">
            <input type="number" id="jumpto-lat" placeholder="Latitud" class="w-24 p-1 border rounded text-sm">
            <input type="number" id="jumpto-lon" placeholder="Longitud" class="w-24 p-1 border rounded text-sm">
            <button id="jumpto-btn" class="control-button bg-blue-500 hover:bg-blue-600 p-2 text-sm">Ir</button>
        </div>
        <div id="map-controls">
            <button id="back-to-setup-from-map-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver</button>
            <button id="apply-coords-btn" class="control-button bg-orange-500 hover:bg-orange-600">Aplicar Coordenadas</button>
            <button id="goto-scale-btn" class="control-button bg-purple-500 hover:bg-purple-600">Configurar Escala</button>
        </div>
        <div class="map-ui-container">
            <div class="slider-container">
                <label for="map-zoom-slider" class="block text-sm font-medium text-gray-700">Zoom del Mapa</label>
                <input id="map-zoom-slider" type="range" min="1" max="22" value="18" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="slider-container">
                <label for="map-scale-slider" class="block text-sm font-medium text-gray-700">Escala del Modelo</label>
                <input id="map-scale-slider" type="range" min="1" max="200" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
    </div>

    <!-- PÁGINA 3: Configuración de Escala -->
    <div id="scale-page" class="page">
        <div class="flex items-center justify-center h-full bg-gray-100">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Configuración de Escala Real</h1>
                <div class="space-y-4">
                    <div class="scale-input-group">
                        <label class="scale-label">Ancho real (m):</label>
                        <input type="number" id="real-width-input" class="scale-input" placeholder="10.0" step="0.1" min="0.1">
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Largo real (m):</label>
                        <input type="number" id="real-length-input" class="scale-input" placeholder="15.0" step="0.1" min="0.1">
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Alto real (m):</label>
                        <input type="number" id="real-height-input" class="scale-input" placeholder="3.0" step="0.1" min="0.1">
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Altura sobre terreno (m):</label>
                        <input type="number" id="ground-height-input" class="scale-input" placeholder="0.0" step="0.1">
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Escala Visual Inicial:</label>
                        <input type="range" id="initial-ar-scale-slider" min="0.1" max="5" step="0.1" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="initial-scale-value" class="text-sm text-gray-600">1.0x</span>
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Distancia de Visualización (m):</label>
                        <input type="range" id="ar-distance-slider" min="5" max="100" step="5" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="distance-value" class="text-sm text-gray-600">20m</span>
                    </div>
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-800">
                            <strong>Nota:</strong> "Distancia de Visualización" ajusta a qué distancia aparecerá el modelo 3D en la vista AR.
                        </p>
                    </div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap:4">
                    <button id="back-to-map-from-scale-btn" class="control-button bg-gray-500 hover:bg-gray-600 w-full sm:w-auto">Volver al Mapa</button>
                    <button id="goto-ar-from-scale-btn" class="control-button bg-green-500 hover:bg-green-600 w-full sm:w-auto">Iniciar AR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PÁGINA 4: Vista de Realidad Aumentada -->
    <div id="ar-page" class="page">
        <!-- Loader de AR.js -->
        <div class="arjs-loader">
            <div class="loader"></div>
            <p>Preparando realidad aumentada...</p>
        </div>
        
        <!-- Escena AR con configuración correcta -->
        <a-scene 
            id="ar-scene"
            vr-mode-ui="enabled: false"
            renderer="logarithmicDepthBuffer: true;"
            embedded
            arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best; detectionMode: mono_and_matrix;">
            
            <!-- Assets para el modelo -->
            <a-assets>
                <a-asset-item id="model-asset" src=""></a-asset-item>
            </a-assets>
            
            <!-- Cámara con GPS -->
            <a-camera 
                id="ar-camera"
                gps-camera="minDistance: 5; alert: true;"
                rotation-reader>
            </a-camera>
            
            <!-- Modelo 3D con geolocalización -->
            <a-entity
                id="arch-model"
                gltf-model="#model-asset"
                gps-entity-place="latitude: 4.104867; longitude: -76.207892;"
                scale="1 1 1"
                position="0 0 0"
                animation-mixer
                visible="false">
            </a-entity>
            
            <!-- Luces -->
            <a-light type="ambient" color="#BBB" intensity="1.5"></a-light>
            <a-light type="directional" color="#FFF" intensity="0.8" position="-0.5 1 1"></a-light>
        </a-scene>
        
        <!-- Controles AR -->
        <div class="ar-controls">
            <button id="back-to-scale-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver</button>
            <button id="reset-position-btn" class="control-button bg-blue-500 hover:bg-blue-600">Resetear</button>
        </div>
        
        <!-- Panel de información -->
        <div class="ar-info-panel">
            <div><strong>GPS:</strong> <span id="gps-status">Buscando...</span></div>
            <div><strong>Precisión:</strong> <span id="gps-accuracy" style="font-weight: bold;">--</span>m</div>
            <div><strong>Escala:</strong> <span id="current-scale">1.0</span>x</div>
            <div><strong>Distancia:</strong> <span id="current-distance">--</span>m</div>
        </div>
        
        <div class="ar-scale-control">
            <label for="ar-scale-slider" class="text-sm">Escala</label>
            <input id="ar-scale-slider" type="range" min="0.1" max="5" step="0.1" value="1" class="ar-scale-slider">
        </div>
        
        <!-- Panel de coordenadas del modelo -->
        <div class="model-coords-panel">
            <h3 style="margin-bottom: 10px; text-align: center; color: #4CAF50;">Georreferencia del Modelo</h3>
            <div class="coord-item">
                <span class="coord-label">Latitud:</span>
                <span class="coord-value" id="model-lat">--</span>
            </div>
            <div class="coord-item">
                <span class="coord-label">Longitud:</span>
                <span class="coord-value" id="model-lon">--</span>
            </div>
            <div class="coord-item">
                <span class="coord-label">Altura:</span>
                <span class="coord-value" id="model-height">--</span>
            </div>
            <div class="coord-item">
                <span class="coord-label">Distancia:</span>
                <span class="coord-value" id="model-distance">--</span>
            </div>
        </div>
        
        <!-- Indicador de GPS -->
        <div id="gps-indicator" class="gps-indicator">
            <div class="gps-dot"></div>
            <span id="gps-indicator-text">GPS: Buscando...</span>
        </div>
    </div>

    <div id="message-box"></div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        /*
         * =================================================================================
         * SISTEMA DE VERSIONES - REGLA OBLIGATORIA
         * =================================================================================
         */
        const APP_VERSION = '0.06'; // VERSIÓN COMPLETAMENTE CORREGIDA Y FUNCIONAL
        const CACHE_NAME = `geo-ar-cache-v${APP_VERSION.replace('.', '')}`;
        
        let appState = {
            modelURL: null,
            coords: null,
            arTargetCoords: null,
            currentGPSLocation: null,
            realDimensions: { width: 10.0, length: 15.0, height: 3.0, groundHeight: 0.0 },
            initialARScale: 1.0,
            arDistance: 20.0,
            modelBounds: null,
            mapScale: 50,
            explorationMode: false,
            videoStarted: false,
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent)
        };
        
        let map, modelPreview = {
            renderer: null,
            scene: null,
            camera: null,
            model: null,
            animationFrameId: null,
            isRotating: false,
            isTwoFingerRotating: false,
            previousMousePosition: { x: 0, y: 0 },
            previousTouchAngle: 0,
            maxSize: 1
        };

        // Variables para el control de la escena AR
        let arScene = null;
        let arCamera = null;
        let arModel = null;
        let gpsWatchId = null;
        let modelLoaded = false;
        let gpsInitialized = false;
        let currentLocationMarker = null;
        let modelLocationMarker = null;

        const pages = {
            upload: document.getElementById('upload-page'),
            map: document.getElementById('map-page'),
            scale: document.getElementById('scale-page'),
            ar: document.getElementById('ar-page')
        };
        
        const messageBox = document.getElementById('message-box');
        const arLoader = document.querySelector('.arjs-loader');
        const gpsIndicator = document.getElementById('gps-indicator');
        const gpsIndicatorText = document.getElementById('gps-indicator-text');

        function showMessage(msg, duration = 3000) {
            messageBox.textContent = msg;
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), duration);
        }

        function navigateTo(pageName) {
            Object.values(pages).forEach(p => p.classList.remove('active'));
            pages[pageName].classList.add('active');

            if (pageName === 'map') {
                setTimeout(() => {
                    initMapAndPreview();
                    setTimeout(() => {
                        if (map) {
                            map.invalidateSize();
                        }
                    }, 100);
                }, 100);
            } else if (pageName === 'scale') {
                loadScaleSettings();
            } else if (pageName === 'ar') {
                initializeAR();
            } else {
                if (map) {
                    map.remove();
                    map = null;
                }
                if (modelPreview.animationFrameId) {
                    cancelAnimationFrame(modelPreview.animationFrameId);
                    modelPreview.animationFrameId = null;
                }
            }
        }

        /*
         * =================================================================================
         * CORRECCIÓN CRÍTICA: Inicialización AR correcta
         * =================================================================================
         * Siguiendo los ejemplos oficiales de AR.js para geolocalización
         * =================================================================================
         */
        function initializeAR() {
            console.log('Iniciando AR...');
            
            // Configurar el asset del modelo
            const modelAsset = document.querySelector('#model-asset');
            if (modelAsset && appState.modelURL) {
                modelAsset.setAttribute('src', appState.modelURL);
            }
            
            // Ocultar loader cuando la escena esté lista
            const scene = document.querySelector('#ar-scene');
            const camera = document.querySelector('#ar-camera');
            const model = document.querySelector('#arch-model');
            
            if (!scene || !camera || !model) {
                console.error('Elementos AR no encontrados');
                showMessage('Error: Elementos AR no encontrados', 5000);
                return;
            }
            
            // Configurar coordenadas del modelo
            const targetCoords = appState.arTargetCoords || appState.coords;
            if (targetCoords) {
                model.setAttribute('gps-entity-place', `latitude: ${targetCoords.latitude}; longitude: ${targetCoords.longitude};`);
                document.getElementById('model-lat').textContent = targetCoords.latitude.toFixed(6);
                document.getElementById('model-lon').textContent = targetCoords.longitude.toFixed(6);
                document.getElementById('model-height').textContent = appState.realDimensions.groundHeight.toFixed(2) + 'm';
            }
            
            // Eventos de AR.js
            scene.addEventListener('loaded', () => {
                console.log('Escena AR cargada');
                arLoader.style.display = 'none';
                startGPSWatch();
                setupAREvents();
            });
            
            scene.addEventListener('error', (event) => {
                console.error('Error en escena AR:', event.detail);
                arLoader.style.display = 'none';
                showMessage('Error al cargar la escena AR', 5000);
            });
        }

        function setupAREvents() {
            const camera = document.querySelector('#ar-camera');
            const model = document.querySelector('#arch-model');
            
            // Eventos de GPS
            window.addEventListener('gps-camera-update-position', (event) => {
                console.log('GPS actualizado:', event.detail);
                const pos = event.detail.position;
                
                appState.currentGPSLocation = {
                    latitude: pos.latitude,
                    longitude: pos.longitude,
                    accuracy: pos.accuracy
                };
                
                document.getElementById('gps-status').textContent = 'Activo';
                document.getElementById('gps-accuracy').textContent = pos.accuracy.toFixed(1);
                
                gpsIndicator.classList.add('active');
                gpsIndicator.classList.remove('error');
                gpsIndicatorText.textContent = `GPS: Activo (${pos.accuracy.toFixed(1)}m)`;
                
                // Actualizar distancia
                if (appState.arTargetCoords) {
                    const distance = calculateDistance(
                        pos.latitude, pos.longitude,
                        appState.arTargetCoords.latitude, appState.arTargetCoords.longitude
                    );
                    document.getElementById('current-distance').textContent = distance.toFixed(0);
                    document.getElementById('model-distance').textContent = distance.toFixed(2) + 'm';
                }
            });
            
            window.addEventListener('gps-camera-error', (event) => {
                console.error('Error GPS:', event.detail);
                document.getElementById('gps-status').textContent = 'Error';
                gpsIndicator.classList.add('error');
                gpsIndicator.classList.remove('active');
                gpsIndicatorText.textContent = 'GPS: Error';
                showMessage('Error de GPS: ' + event.detail.message, 5000);
            });
            
            // Eventos del modelo
            model.addEventListener('model-loaded', () => {
                console.log('Modelo cargado');
                modelLoaded = true;
                model.setAttribute('visible', 'true');
                adjustModelScale();
            });
            
            model.addEventListener('model-error', (event) => {
                console.error('Error al cargar modelo:', event.detail);
                showMessage('Error al cargar el modelo 3D', 5000);
            });
        }

        function startGPSWatch() {
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
            }
            
            gpsWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    console.log('Posición GPS:', position.coords);
                },
                (error) => {
                    console.error('Error GPS:', error);
                    showMessage('Error de GPS: ' + error.message, 5000);
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 10000, 
                    maximumAge: 0
                }
            );
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function adjustModelScale() {
            const model = document.querySelector('#arch-model');
            if (!model || !appState.modelURL) return;
            
            // Cargar el modelo para calcular sus dimensiones
            const loader = new GLTFLoader();
            loader.load(appState.modelURL, (gltf) => {
                const box = new THREE.Box3().setFromObject(gltf.scene);
                const size = new THREE.Vector3();
                box.getSize(size);

                const baseScaleX = appState.realDimensions.width / size.x;
                const baseScaleY = appState.realDimensions.height / size.y;
                const baseScaleZ = appState.realDimensions.length / size.z;
                
                const finalScaleX = baseScaleX * appState.initialARScale;
                const finalScaleY = baseScaleY * appState.initialARScale;
                const finalScaleZ = baseScaleZ * appState.initialARScale;
                
                model.setAttribute('scale', `${finalScaleX} ${finalScaleY} ${finalScaleZ}`);
                model.setAttribute('position', `0 ${appState.realDimensions.groundHeight} 0`);
                
                document.getElementById('current-scale').textContent = appState.initialARScale.toFixed(1);
            });
        }

        function stopAR() {
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
            
            navigateTo('scale');
        }

        // Funciones para manejo de caché
        async function clearCacheAndReload() {
            await caches.delete(CACHE_NAME);
            showMessage('Caché limpiado.');
            setTimeout(() => window.location.reload(), 1000);
        }

        async function loadDataFromCache() {
            try {
                const cache = await caches.open(CACHE_NAME);
                const [modelRes, coordsRes, arTargetRes] = await Promise.all([
                    cache.match('cached-model.glb'),
                    cache.match('cached-coords.json'),
                    cache.match('cached-ar-target-coords.json')
                ]);

                if (!modelRes || !coordsRes) throw new Error("Datos no encontrados en caché.");

                appState.coords = await coordsRes.json();
                appState.modelURL = URL.createObjectURL(await modelRes.blob());
                
                if (arTargetRes) {
                    appState.arTargetCoords = await arTargetRes.json();
                }

                document.getElementById('upload-section').classList.add('hidden');
                document.getElementById('load-data-btn').classList.add('hidden');
                document.getElementById('status-section').classList.remove('hidden');
                document.getElementById('goto-map-btn').disabled = false;
                showMessage('Datos cargados desde el caché.');
                return true;
            } catch (error) {
                console.error('Error al cargar desde caché:', error);
                return false;
            }
        }

        async function saveDataToCache() {
            const modelFile = document.getElementById('model-upload').files[0];
            const lat = parseFloat(document.getElementById('latitude-input').value);
            const lon = parseFloat(document.getElementById('longitude-input').value);

            if (!modelFile) {
                showMessage('Error: Debes seleccionar un archivo de modelo 3D (.glb).', 5000);
                return;
            }
            if (!modelFile.name.toLowerCase().endsWith('.glb')) {
                showMessage('Error: El formato del archivo debe ser .glb', 5000);
                return;
            }
            if (isNaN(lat) || isNaN(lon)) {
                showMessage('Error: Debes introducir valores válidos para latitud y longitud.', 5000);
                return;
            }

            showMessage('Guardando datos en caché...');
            appState.coords = { latitude: lat, longitude: lon };

            try {
                const cache = await caches.open(CACHE_NAME);
                await Promise.all([
                    cache.put('cached-model.glb', new Response(modelFile)),
                    cache.put('cached-coords.json', new Response(new Blob([JSON.stringify(appState.coords)], {type : 'application/json'})))
                ]);
                
                await loadDataFromCache(); 
                showMessage('¡Datos guardados y cargados exitosamente!', 3000);

            } catch (error) {
                console.error('Error al guardar en caché:', error);
                showMessage('Error al guardar datos. Inténtalo de nuevo.', 5000);
            }
        }

        async function updateCoordsInCache(coords) {
            appState.coords = coords;
            try {
                const cache = await caches.open(CACHE_NAME);
                await cache.put('cached-coords.json', new Response(new Blob([JSON.stringify(appState.coords)], {type : 'application/json'})));
            } catch (error) {
                console.error('Failed to update coordinates in cache:', error);
            }
        }
        
        async function applyCoordsToAR() {
            if (!map) {
                showMessage('El mapa no está inicializado.', 2000);
                return;
            }
            
            const center = map.getCenter();
            appState.arTargetCoords = { latitude: center.lat, longitude: center.lng };
            
            try {
                const cache = await caches.open(CACHE_NAME);
                await cache.put('cached-ar-target-coords.json', new Response(new Blob([JSON.stringify(appState.arTargetCoords)], {type : 'application/json'})));
                showMessage(`Coordenadas aplicadas: ${center.lat.toFixed(6)}, ${center.lng.toFixed(6)}`, 3000);
            } catch (error) {
                console.error('Failed to save AR target coordinates in cache:', error);
                showMessage('Error al guardar coordenadas para AR.', 3000);
            }
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) {
                showMessage("Geolocalización no es soportada.");
                return;
            }

            showMessage("Obteniendo ubicación...");
            navigator.geolocation.getCurrentPosition(
                position => {
                    document.getElementById('latitude-input').value = position.coords.latitude.toFixed(6);
                    document.getElementById('longitude-input').value = position.coords.longitude.toFixed(6);
                    showMessage("Ubicación obtenida.");
                },
                error => {
                    console.error('Error al obtener ubicación:', error);
                    showMessage("No se pudo obtener la ubicación. Revisa los permisos.");
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function initMapAndPreview() {
            if (!appState.coords) {
                navigateTo('upload');
                return;
            }

            if (map) {
                map.remove();
                map = null;
            }

            const mapContainer = document.getElementById('map-canvas');
            map = L.map(mapContainer, {
                zoomControl: false,
                preferCanvas: true
            }).setView([appState.coords.latitude, appState.coords.longitude], 18);

            const osmTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            });

            const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: 'Imagery ©2025 Google'
            });

            googleSat.addTo(map);

            const baseMaps = {
                "OpenStreetMap": osmTiles,
                "Google Satélite": googleSat
            };

            L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

            const initialMarker = L.marker([appState.coords.latitude, appState.coords.longitude], {
                draggable: true,
                autoPan: true
            }).addTo(map)
            .bindPopup('Ubicación Inicial (Arrástrame)')
            .openPopup();

            initialMarker.on('dragend', function(event) {
                const newPosition = event.target.getLatLng();
                appState.coords = { latitude: newPosition.lat, longitude: newPosition.lng };
                updateCoordsInCache(appState.coords);
                document.getElementById('jumpto-lat').value = newPosition.lat.toFixed(6);
                document.getElementById('jumpto-lon').value = newPosition.lng.toFixed(6);
                showMessage('Ubicación inicial actualizada.', 3000);
            });
            
            if (appState.arTargetCoords) {
                modelLocationMarker = L.marker([appState.arTargetCoords.latitude, appState.arTargetCoords.longitude])
                    .addTo(map)
                    .bindPopup('Ubicación del Modelo 3D')
                    .setIcon(L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', 
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', 
                        iconSize: [25, 41], 
                        iconAnchor: [12, 41], 
                        popupAnchor: [1, -34], 
                        shadowSize: [41, 41]
                    }));
            }

            map.on('moveend', () => {
                const newCoords = map.getCenter();
                updateCoordsInCache({ latitude: newCoords.lat, longitude: newCoords.lng });
                document.getElementById('jumpto-lat').value = newCoords.lat.toFixed(6);
                document.getElementById('jumpto-lon').value = newCoords.lng.toFixed(6);
            });

            document.getElementById('jumpto-lat').value = appState.coords.latitude.toFixed(6);
            document.getElementById('jumpto-lon').value = appState.coords.longitude.toFixed(6);

            initModelPreview();
        }

        async function initModelPreview() {
            const canvas = document.getElementById('model-preview-canvas');
            const container = document.getElementById('map-container');

            if (!container) return;

            canvas.style.display = 'block';
            canvas.style.zIndex = '401';
            
            modelPreview.renderer = new THREE.WebGLRenderer({
                canvas,
                alpha: true,
                antialias: true,
                logarithmicDepthBuffer: true
            });

            modelPreview.renderer.setSize(container.clientWidth, container.clientHeight);
            modelPreview.renderer.setPixelRatio(window.devicePixelRatio);
            modelPreview.renderer.setClearColor(0x000000, 0);
            
            modelPreview.scene = new THREE.Scene();
            modelPreview.camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            modelPreview.camera.position.set(0, 40, 30);
            modelPreview.camera.lookAt(0, 0, 0);

            modelPreview.scene.add(new THREE.AmbientLight(0xffffff, 1.8));

            const dirLight = new THREE.DirectionalLight(0xffffff, 2.5);
            dirLight.position.set(5, 10, 7.5);
            modelPreview.scene.add(dirLight);

            if (modelPreview.model) {
                modelPreview.scene.remove(modelPreview.model);
            }

            try {
                const loader = new GLTFLoader();
                const gltf = await loader.loadAsync(appState.modelURL);
                modelPreview.model = gltf.scene;

                modelPreview.model.traverse((node) => {
                    if (node.isMesh && node.material) {
                        node.material.transparent = false;
                        node.material.depthWrite = true;
                        node.material.needsUpdate = true;
                    }
                });

                const box = new THREE.Box3().setFromObject(modelPreview.model);
                const size = new THREE.Vector3();
                box.getSize(size);
                modelPreview.maxSize = Math.max(size.x, size.y, size.z) || 1;

                appState.modelBounds = {
                    width: size.x,
                    length: size.z,
                    height: size.y
                };

                modelPreview.model.position.sub(box.getCenter(new THREE.Vector3()));
                modelPreview.scene.add(modelPreview.model);
                
                animateModelPreview();
            } catch (error) {
                console.error("Error cargando modelo para vista previa:", error);
                showMessage("Error al cargar el modelo 3D para vista previa.");
            }
        }

        function animateModelPreview() {
            modelPreview.animationFrameId = requestAnimationFrame(animateModelPreview);

            if (modelPreview.model) {
                const scale = (appState.mapScale * 0.5) / modelPreview.maxSize;
                modelPreview.model.scale.set(scale, scale, scale);
            }

            if (modelPreview.renderer && modelPreview.scene && modelPreview.camera) {
                modelPreview.renderer.clearDepth();
                modelPreview.renderer.render(modelPreview.scene, modelPreview.camera);
            }
        }

        function jumpToCoords() {
            const lat = parseFloat(document.getElementById('jumpto-lat').value);
            const lon = parseFloat(document.getElementById('jumpto-lon').value);
            if (isNaN(lat) || isNaN(lon) || !map) return;
            map.setView([lat, lon], map.getZoom());
        }

        function onWindowResize() {
            if (pages.map.classList.contains('active') && modelPreview.renderer) {
                const container = document.getElementById('map-container');
                if (!container) return;
                const width = container.clientWidth;
                const height = container.clientHeight;

                modelPreview.camera.aspect = width / height;
                modelPreview.camera.updateProjectionMatrix();
                modelPreview.renderer.setSize(width, height);
            }

            if (pages.map.classList.contains('active') && map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        }

        function loadScaleSettings() {
            document.getElementById('real-width-input').value = appState.realDimensions.width;
            document.getElementById('real-length-input').value = appState.realDimensions.length;
            document.getElementById('real-height-input').value = appState.realDimensions.height;
            document.getElementById('ground-height-input').value = appState.realDimensions.groundHeight;
            
            document.getElementById('initial-ar-scale-slider').value = appState.initialARScale;
            document.getElementById('initial-scale-value').textContent = appState.initialARScale.toFixed(1) + 'x';
            
            document.getElementById('ar-distance-slider').value = appState.arDistance;
            document.getElementById('distance-value').textContent = appState.arDistance.toFixed(0) + 'm';
        }

        function saveScaleSettings() {
            appState.realDimensions.width = parseFloat(document.getElementById('real-width-input').value) || 10.0;
            appState.realDimensions.length = parseFloat(document.getElementById('real-length-input').value) || 15.0;
            appState.realDimensions.height = parseFloat(document.getElementById('real-height-input').value) || 3.0;
            appState.realDimensions.groundHeight = parseFloat(document.getElementById('ground-height-input').value) || 0.0;
            
            appState.initialARScale = parseFloat(document.getElementById('initial-ar-scale-slider').value);
            appState.arDistance = parseFloat(document.getElementById('ar-distance-slider').value);

            showMessage('Configuración de escala guardada', 2000);
        }

        // --- Event Listeners ---
        window.addEventListener('resize', onWindowResize, false);
        document.getElementById('load-data-btn').addEventListener('click', saveDataToCache);
        document.getElementById('clear-cache-btn').addEventListener('click', clearCacheAndReload);
        document.getElementById('goto-map-btn').addEventListener('click', () => navigateTo('map'));
        document.getElementById('use-location-btn').addEventListener('click', useCurrentLocation);
        document.getElementById('back-to-setup-from-map-btn').addEventListener('click', () => navigateTo('upload'));
        document.getElementById('goto-scale-btn').addEventListener('click', () => navigateTo('scale'));
        document.getElementById('back-to-map-from-scale-btn').addEventListener('click', () => navigateTo('map'));
        document.getElementById('goto-ar-from-scale-btn').addEventListener('click', () => {
            saveScaleSettings();
            navigateTo('ar');
        });
        document.getElementById('back-to-scale-btn').addEventListener('click', stopAR);
        document.getElementById('map-scale-slider').addEventListener('input', (e) => {
            appState.mapScale = parseFloat(e.target.value);
        });
        document.getElementById('map-zoom-slider').addEventListener('input', (e) => {
            if (map) map.setZoom(parseFloat(e.target.value));
        });
        document.getElementById('jumpto-btn').addEventListener('click', jumpToCoords);
        
        document.getElementById('apply-coords-btn').addEventListener('click', applyCoordsToAR);
        
        document.getElementById('initial-ar-scale-slider').addEventListener('input', (e) => {
            const scaleValue = parseFloat(e.target.value);
            document.getElementById('initial-scale-value').textContent = scaleValue.toFixed(1) + 'x';
        });
        
        document.getElementById('ar-distance-slider').addEventListener('input', (e) => {
            const distanceValue = parseFloat(e.target.value);
            document.getElementById('distance-value').textContent = distanceValue.toFixed(0) + 'm';
        });

        document.getElementById('ar-scale-slider').addEventListener('input', (e) => {
            const scaleValue = parseFloat(e.target.value);
            document.getElementById('current-scale').textContent = scaleValue.toFixed(1);
            
            const model = document.querySelector('#arch-model');
            if (model && model.object3D) {
                const currentScale = model.getAttribute('scale');
                const baseScale = currentScale.split(' ').map(parseFloat);
                const dynamicScale = scaleValue / appState.initialARScale;
                model.setAttribute('scale', `${baseScale[0] * dynamicScale} ${baseScale[1] * dynamicScale} ${baseScale[2] * dynamicScale}`);
            }
        });

        document.getElementById('reset-position-btn').addEventListener('click', () => {
            const camera = document.querySelector('#ar-camera');
            if (camera && camera.components['gps-camera']) {
                camera.components['gps-camera'].resetPosition();
                showMessage('Posición reiniciada', 2000);
            }
        });

        function initializeApp() {
            document.getElementById('version-display').textContent = `v${APP_VERSION}`;
            
            appState.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            loadDataFromCache().then(successfullyLoaded => {
                if (successfullyLoaded) {
                    console.log("Aplicación iniciada con datos desde la caché.");
                } else {
                    document.getElementById('goto-map-btn').disabled = true;
                    console.log("Aplicación iniciada sin datos en caché.");
                }
            });
        }

        initializeApp();
    </script>
</body>
</html>
