<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR Pro Cloud</title>
    <link rel="icon" type="image/png" href="https://github.com/instructorandradedcc/55ar/raw/main/favicon3dAR.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet (Mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Three.js & Model Viewer -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
                "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
            }
        }
    </script>
    <!-- Model Viewer para Surface Mode -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        /* Reset y Estilos Base */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #111; user-select: none; -webkit-user-select: none; }
        .page { display: none; height: 100%; width: 100%; position: relative; background: #f5f5f5; flex-direction: column; }
        .page.active { display: flex; }

        /* UI Components */
        .control-btn { background: #2563eb; color: white; padding: 12px; border-radius: 12px; font-weight: 600; text-align: center; width: 100%; transition: 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .control-btn:active { transform: scale(0.98); }
        .control-btn.secondary { background: white; color: #333; border: 1px solid #ddd; }
        
        /* Mapa */
        #map-canvas { width: 100%; flex: 1; z-index: 1; }
        .map-ui { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 500; background: rgba(255,255,255,0.95); padding: 16px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); backdrop-filter: blur(10px); }

        /* A-Frame (AR GPS) */
        a-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* Model Viewer (Interior) */
        model-viewer { width: 100%; height: 100%; background-color: #222; --poster-color: transparent; }
        
        /* Bot√≥n Activar C√°mara (Estilo Apple) */
        .ar-button {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 0 24px; height: 50px; border-radius: 25px;
            display: flex; align-items: center; gap: 10px;
            font-weight: 600; color: #000; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 100; border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.2s;
        }
        .ar-button:active { transform: translateX(-50%) scale(0.95); }

        /* Panel Calibraci√≥n Flotante */
        .calibration-hud {
            position: fixed; bottom: 100px; right: 16px; z-index: 1000;
            display: flex; flex-direction: column; gap: 8px;
            background: rgba(0,0,0,0.6); padding: 12px; border-radius: 16px;
            backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.1);
            transform: translateX(120%); transition: transform 0.3s ease;
        }
        .calibration-hud.visible { transform: translateX(0); }

        .pad-btn {
            width: 48px; height: 48px; background: rgba(255,255,255,0.15); border: none;
            border-radius: 12px; color: white; font-size: 20px; display: grid; place-items: center;
        }
        .pad-btn:active { background: #2563eb; }

        /* Loading Overlay */
        .loader-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: opacity 0.5s;
        }
        .loader-overlay.hidden { opacity: 0; pointer-events: none; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast Notification */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #333; color: white; padding: 12px 24px; border-radius: 50px;
            font-size: 14px; z-index: 10002; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <!-- Notifications -->
    <div id="toast" class="toast">
        <span id="toast-icon">‚ÑπÔ∏è</span>
        <span id="toast-msg">Mensaje del sistema</span>
    </div>

    <!-- Loading Screen -->
    <div id="loader" class="loader-overlay">
        <div class="spinner mb-4"></div>
        <h2 class="text-lg font-bold tracking-widest">CARGANDO SISTEMA</h2>
        <p class="text-sm text-gray-400 mt-2" id="loader-text">Iniciando Firebase...</p>
    </div>

    <!-- PAGINA 1: INICIO / FIREBASE -->
    <div id="page-home" class="page active justify-center items-center p-6 bg-gray-50">
        <div class="w-full max-w-md bg-white p-8 rounded-3xl shadow-xl">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl">üèóÔ∏è</div>
                <h1 class="text-2xl font-bold text-gray-900">AR Constructor Cloud</h1>
                <p class="text-sm text-gray-500">Gesti√≥n de Anclajes Espaciales</p>
            </div>

            <div class="space-y-4">
                <!-- Input Proyecto ID -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ID de Proyecto (Sala)</label>
                    <div class="flex gap-2">
                        <input type="text" id="project-id" value="demo-proyecto-1" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="load-cloud-btn" class="bg-blue-600 text-white px-4 rounded-xl font-bold shadow-md hover:bg-blue-700">
                            ‚òÅÔ∏è Cargar
                        </button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">Usa el mismo ID para compartir la ubicaci√≥n con otros.</p>
                </div>

                <div class="h-px bg-gray-100 my-4"></div>

                <!-- Carga Local -->
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition relative cursor-pointer">
                    <input type="file" id="file-input" accept=".glb,.gltf" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
                    <div class="text-3xl mb-2">üìÇ</div>
                    <p class="text-sm font-medium text-gray-600">Toca para cargar modelo (.glb)</p>
                    <p class="text-xs text-gray-400 mt-1" id="filename">Ning√∫n archivo seleccionado</p>
                </div>

                <button id="start-btn" class="control-btn bg-gray-900 text-white mt-4" disabled>
                    Configurar Ubicaci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- PAGINA 2: MAPA SATELITAL -->
    <div id="page-map" class="page">
        <div id="map-canvas"></div>
        
        <div class="map-ui">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-gray-800">Geolocalizaci√≥n</h3>
                <span class="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded-full">S√ÅTELITE</span>
            </div>
            <p class="text-xs text-gray-500 mb-4">Arrastra el marcador al punto exacto de construcci√≥n.</p>
            
            <div class="grid grid-cols-2 gap-2 mb-3">
                <div class="bg-gray-50 p-2 rounded-lg">
                    <span class="text-[9px] text-gray-400 font-bold block">LATITUD</span>
                    <span id="disp-lat" class="text-xs font-mono font-bold text-gray-700">0.000000</span>
                </div>
                <div class="bg-gray-50 p-2 rounded-lg">
                    <span class="text-[9px] text-gray-400 font-bold block">LONGITUD</span>
                    <span id="disp-lon" class="text-xs font-mono font-bold text-gray-700">0.000000</span>
                </div>
            </div>

            <button onclick="app.setMode('ar')" class="control-btn">Confirmar y Ver en AR</button>
            <button onclick="app.setMode('surface')" class="control-btn secondary mt-2">Ver solo Modelo (Interior)</button>
        </div>
    </div>

    <!-- PAGINA 3: AR GPS (EXTERIOR) -->
    <div id="page-ar" class="page bg-black">
        <div id="ar-container"></div> <!-- A-Frame se inyecta aqu√≠ -->
        
        <!-- HUD GPS -->
        <div class="absolute top-4 left-4 bg-black/60 backdrop-blur text-white px-3 py-1 rounded-full border border-white/10 pointer-events-none z-50">
            <span class="text-xs font-mono">GPS: <span id="gps-stat">Buscando...</span></span>
        </div>

        <!-- Botones AR -->
        <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-3 z-50 w-full px-4 max-w-md">
            <button onclick="window.location.reload()" class="bg-red-500/90 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-xl">‚úï</button>
            <button onclick="app.toggleCalibration()" class="flex-1 bg-white/90 backdrop-blur text-black font-bold py-3 rounded-full shadow-lg">üõ†Ô∏è Calibrar</button>
            <button onclick="app.saveToCloud()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-full shadow-lg flex items-center justify-center gap-2">
                <span>‚òÅÔ∏è</span> Guardar
            </button>
        </div>

        <!-- Panel Calibraci√≥n -->
        <div id="cal-hud" class="calibration-hud">
            <div class="text-white text-[10px] font-bold text-center mb-1 opacity-50">POSICI√ìN</div>
            <div class="grid grid-cols-3 gap-1">
                <div></div> <button class="pad-btn" onmousedown="app.adjust('z', -0.5)">‚¨ÜÔ∏è</button> <div></div>
                <button class="pad-btn" onmousedown="app.adjust('x', -0.5)">‚¨ÖÔ∏è</button>
                <button class="pad-btn" onmousedown="app.adjust('z', 0.5)">‚¨áÔ∏è</button>
                <button class="pad-btn" onmousedown="app.adjust('x', 0.5)">‚û°Ô∏è</button>
            </div>
            <div class="text-white text-[10px] font-bold text-center mt-2 opacity-50">ALTURA / GIRO</div>
            <div class="flex justify-center gap-2">
                <button class="pad-btn text-sm" onmousedown="app.adjust('y', 0.5)">‚è´</button>
                <button class="pad-btn text-sm" onmousedown="app.adjust('y', -0.5)">‚è¨</button>
                <button class="pad-btn text-sm" onmousedown="app.adjust('r', -5)">‚Ü∫</button>
                <button class="pad-btn text-sm" onmousedown="app.adjust('r', 5)">‚Üª</button>
            </div>
        </div>
    </div>

    <!-- PAGINA 4: SURFACE MODE (INTERIOR) -->
    <div id="page-surface" class="page bg-gray-900">
        <button onclick="app.setMode('map')" class="absolute top-4 left-4 z-50 bg-white/20 text-white w-10 h-10 rounded-full backdrop-blur flex items-center justify-center">‚Üê</button>
        
        <model-viewer 
            id="viewer"
            src=""
            ar 
            ar-modes="webxr scene-viewer quick-look" 
            camera-controls 
            shadow-intensity="1" 
            auto-rotate
            touch-action="pan-y"
            ar-scale="fixed"
            ar-placement="floor">
            
            <button slot="ar-button" class="ar-button">
                <span>üì∑ ABRIR C√ÅMARA</span>
            </button>

            <div class="absolute top-20 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-4 py-2 rounded-full text-xs backdrop-blur pointer-events-none text-center w-max">
                üëã 1 dedo: Girar ‚Ä¢ 2 dedos: Mover/Zoom
            </div>
        </model-viewer>
    </div>

    <!-- L√ìGICA DE LA APLICACI√ìN -->
    <script type="module">
        // --- 1. IMPORTACIONES ---
        import { initializeApp } from 'firebase/app';
        import { getFirestore, doc, getDoc, setDoc } from 'firebase/firestore';

        // --- 2. CONFIGURACI√ìN FIREBASE (¬°PON TUS DATOS AQU√ç!) ---
        const firebaseConfig = {
             // ‚ö†Ô∏è REEMPLAZA ESTO CON TU CONFIGURACI√ìN DE LA CONSOLA DE FIREBASE ‚ö†Ô∏è
            apiKey: "TU_API_KEY_AQUI",
            authDomain: "tu-proyecto.firebaseapp.com",
            projectId: "tu-proyecto",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abc123456"
        };

        // --- 3. ESTADO GLOBAL ---
        const state = {
            modelUrl: null,
            coords: { lat: 0, lon: 0 },
            calibration: { x: 0, y: 0, z: 0, rotation: 0, scale: 1.0 },
            projectId: 'demo-1',
            db: null
        };

        // --- 4. CLASE PRINCIPAL ---
        class ARApp {
            constructor() {
                this.initFirebase();
                this.initUI();
            }

            initFirebase() {
                try {
                    const app = initializeApp(firebaseConfig);
                    state.db = getFirestore(app);
                    console.log("Firebase conectado");
                } catch (e) {
                    console.warn("Firebase no configurado (Modo Offline)", e);
                    this.toast("‚ö†Ô∏è Firebase no configurado. Modo Local.", "error");
                }
                document.getElementById('loader').classList.add('hidden');
            }

            initUI() {
                // Input Archivo
                document.getElementById('file-input').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        state.modelUrl = URL.createObjectURL(file);
                        document.getElementById('filename').textContent = file.name;
                        document.getElementById('start-btn').disabled = false;
                        document.getElementById('start-btn').classList.replace('bg-gray-900', 'bg-blue-600');
                    }
                });

                // Bot√≥n Cargar Nube
                document.getElementById('load-cloud-btn').addEventListener('click', () => this.loadFromCloud());

                // Bot√≥n Iniciar
                document.getElementById('start-btn').addEventListener('click', () => {
                    this.setMode('map');
                    this.initMap();
                });
            }

            // --- NUBE (FIREBASE) ---
            async loadFromCloud() {
                if (!state.db) return;
                
                const pid = document.getElementById('project-id').value;
                this.showLoader(true, "Buscando proyecto...");

                try {
                    const docRef = doc(state.db, "ar_projects", pid);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        state.coords = data.coords;
                        state.calibration = data.calibration;
                        this.toast(`‚úÖ Proyecto "${pid}" cargado`);
                        
                        // Si hay modelo cargado localmente, usar las coords de la nube
                        if(state.modelUrl) {
                            this.setMode('map');
                            this.initMap(); // Refrescar mapa con coords nuevas
                        }
                    } else {
                        this.toast("‚ùå Proyecto no encontrado", "error");
                    }
                } catch (e) {
                    console.error(e);
                    this.toast("Error de conexi√≥n", "error");
                }
                this.showLoader(false);
            }

            async saveToCloud() {
                if (!state.db) return this.toast("Configura Firebase primero");
                
                const pid = document.getElementById('project-id').value;
                this.showLoader(true, "Guardando anclaje...");

                try {
                    await setDoc(doc(state.db, "ar_projects", pid), {
                        coords: state.coords,
                        calibration: state.calibration,
                        timestamp: new Date().toISOString()
                    });
                    this.toast("‚òÅÔ∏è Posici√≥n Guardada Exitosamente");
                } catch (e) {
                    console.error(e);
                    this.toast("Error al guardar: Revisa Permisos", "error");
                }
                this.showLoader(false);
            }

            // --- MAPA ---
            initMap() {
                const mapDiv = document.getElementById('map-canvas');
                // Prevenir men√∫ contextual al mantener pulsado
                mapDiv.addEventListener('contextmenu', e => e.preventDefault());

                if (this.map) this.map.remove();

                // Google H√≠brido
                const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    maxZoom: 21, maxNativeZoom: 19
                });

                // Ubicaci√≥n inicial (o guardada)
                const startLat = state.coords.lat || 4.6097; // Default
                const startLon = state.coords.lon || -74.0817;

                this.map = L.map(mapDiv, {
                    zoomControl: false,
                    layers: [googleHybrid],
                    center: [startLat, startLon],
                    zoom: 19,
                    tap: false // Fix iOS
                });

                const marker = L.marker([startLat, startLon], { draggable: true }).addTo(this.map);

                // Actualizar coords al mover
                const updateCoords = (e) => {
                    const ll = e.target.getLatLng();
                    state.coords = { lat: ll.lat, lon: ll.lng };
                    document.getElementById('disp-lat').textContent = ll.lat.toFixed(6);
                    document.getElementById('disp-lon').textContent = ll.lng.toFixed(6);
                };

                marker.on('drag', updateCoords);
                marker.on('dragend', updateCoords);
                updateCoords({ target: marker }); // Init

                // Geolocalizar usuario
                if (state.coords.lat === 0) {
                    this.toast("üìç Buscando tu ubicaci√≥n...");
                    this.map.locate({ setView: true, maxZoom: 19 });
                    this.map.on('locationfound', e => {
                        marker.setLatLng(e.latlng);
                        updateCoords({ target: marker });
                    });
                }
            }

            // --- AR GPS ---
            startAR() {
                const container = document.getElementById('ar-container');
                
                // Inyectar A-Frame din√°micamente
                if (!window.AFRAME) {
                    this.loadScript('https://aframe.io/releases/1.3.0/aframe.min.js')
                        .then(() => this.loadScript('https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'))
                        .then(() => this.renderScene());
                } else {
                    this.renderScene();
                }
            }

            renderScene() {
                const t = state.coords;
                const c = state.calibration;
                
                document.getElementById('ar-container').innerHTML = `
                    <a-scene embedded vr-mode-ui="enabled: false"
                        renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true;"
                        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
                        
                        <a-camera gps-camera="minDistance: 1;" rotation-reader></a-camera>
                        
                        <a-entity id="geo-anchor" gps-entity-place="latitude: ${t.lat}; longitude: ${t.lon};">
                            <a-entity id="model-wrapper" 
                                position="${c.x} ${c.y} ${c.z}" 
                                rotation="0 ${c.rotation} 0"
                                scale="${c.scale} ${c.scale} ${c.scale}">
                                <a-entity gltf-model="${state.modelUrl}"></a-entity>
                            </a-entity>
                        </a-entity>

                        <a-light type="ambient" intensity="1.2"></a-light>
                        <a-light type="directional" position="-1 1 0" intensity="1.5"></a-light>
                    </a-scene>
                `;

                // Monitor GPS Accuracy
                window.addEventListener('gps-camera-update-position', e => {
                    document.getElementById('gps-stat').textContent = `¬± ${e.detail.position.accuracy.toFixed(0)}m`;
                });
            }

            // --- CALIBRACI√ìN ---
            adjust(axis, val) {
                if (axis === 'r') state.calibration.rotation += val;
                else state.calibration[axis] += val;
                
                // Aplicar visualmente
                const el = document.getElementById('model-wrapper');
                if (el) {
                    const c = state.calibration;
                    el.setAttribute('position', `${c.x} ${c.y} ${c.z}`);
                    el.setAttribute('rotation', `0 ${c.rotation} 0`);
                    this.toast(`Pos: ${c.x.toFixed(1)}, ${c.y.toFixed(1)}, ${c.z.toFixed(1)}`);
                }
            }

            toggleCalibration() {
                document.getElementById('cal-hud').classList.toggle('visible');
            }

            // --- UTILIDADES ---
            setMode(modeId) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                
                if (modeId === 'ar') {
                    document.getElementById('page-ar').classList.add('active');
                    this.startAR();
                } else if (modeId === 'surface') {
                    document.getElementById('page-surface').classList.add('active');
                    const v = document.getElementById('viewer');
                    v.src = state.modelUrl;
                } else if (modeId === 'map') {
                    document.getElementById('page-map').classList.add('active');
                    setTimeout(() => this.map.invalidateSize(), 100);
                } else {
                    document.getElementById('page-home').classList.add('active');
                }
            }

            toast(msg, type = 'info') {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').textContent = msg;
                document.getElementById('toast-icon').textContent = type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }

            showLoader(show, text) {
                const l = document.getElementById('loader');
                if(show) {
                    document.getElementById('loader-text').textContent = text;
                    l.classList.remove('hidden');
                } else {
                    l.classList.add('hidden');
                }
            }

            loadScript(src) {
                return new Promise(resolve => {
                    const s = document.createElement('script');
                    s.src = src;
                    s.onload = resolve;
                    document.head.appendChild(s);
                });
            }
        }

        // Iniciar App
        window.app = new ARApp();
    </script>
</body>
</html>
