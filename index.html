<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>AR Constructor Pro v1.3</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://github.com/instructorandradedcc/55ar/raw/main/favicon3dAR.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet (Mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* ESTILOS GLOBALES */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f3f4f6; font-family: system-ui, -apple-system, sans-serif; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        
        /* SISTEMA DE P√ÅGINAS */
        .page { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; overflow-y: auto; z-index: 10; background: #f3f4f6; }
        .page.active { display: flex; flex-direction: column; }
        
        /* PANTALLA DE PERMISOS (Inicio) */
        #permission-screen {
            position: fixed; inset: 0; z-index: 9999; background: #0f172a;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center; color: white;
        }
        
        /* SLIDERS */
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; margin: 10px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #ffffff; border: 2px solid #2563eb; margin-top: -10px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        
        /* LOGS DE DEPURACI√ìN (Visible para usuario) */
        #debug-log {
            position: fixed; bottom: 0; left: 0; width: 100%; max-height: 100px;
            background: rgba(0,0,0,0.8); color: #00ff00; font-family: monospace; font-size: 10px;
            overflow-y: auto; padding: 5px; z-index: 20000; pointer-events: none; display: none;
        }

        /* VIDEO AR FIX */
        video { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; object-fit: cover !important; z-index: -2 !important; }
    </style>

    <!-- CARGA MOTOR AR -->
    <script>
        let arLibLoaded = false;
        function loadARLibs() {
            if(arLibLoaded) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const s1 = document.createElement('script'); s1.src = 'https://aframe.io/releases/1.3.0/aframe.min.js';
                s1.onload = () => {
                    const s2 = document.createElement('script'); s2.src = 'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js';
                    s2.onload = () => { arLibLoaded = true; resolve(); };
                    s2.onerror = reject; document.head.appendChild(s2);
                };
                s1.onerror = reject; document.head.appendChild(s1);
            });
        }
    </script>
</head>
<body>

    <!-- CONSOLA DE ESTADO -->
    <div id="debug-log">Sistema iniciado...</div>

    <!-- 0. PANTALLA DE PERMISOS (Landing Page) -->
    <div id="permission-screen">
        <div class="text-6xl mb-6">üì°</div>
        <h1 class="text-2xl font-bold mb-2">AR Constructor Pro</h1>
        <p class="text-gray-400 mb-8 max-w-xs">Para colocar modelos 3D en el mundo real, necesitamos acceso a tu GPS y C√°mara.</p>
        
        <div class="space-y-4 w-full max-w-xs">
            <div id="perm-status-gps" class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700">
                <span>üìç GPS</span> <span class="text-yellow-500 font-bold">Pendiente</span>
            </div>
            <div id="perm-status-cam" class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700">
                <span>üì∏ C√°mara</span> <span class="text-yellow-500 font-bold">Pendiente</span>
            </div>
            
            <button id="btn-start-app" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl text-lg shadow-lg transition transform active:scale-95 mt-4">
                CONCEDER Y CONTINUAR
            </button>
        </div>
        <p class="text-[10px] text-gray-600 mt-8">v1.3 - Build Secure</p>
    </div>

    <!-- 1. P√ÅGINA DE CARGA (UPLOAD) -->
    <div id="upload-page" class="page items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative z-10">
            <div class="bg-slate-50 p-6 text-center border-b border-slate-100">
                <img src="https://github.com/instructorandradedcc/55ar/raw/main/logofundaciontrasparencia.png" class="h-14 mx-auto mb-2 object-contain">
                <h2 class="text-lg font-bold text-slate-800">Configuraci√≥n</h2>
            </div>

            <div class="p-6 space-y-6">
                <!-- ARCHIVO -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">1. Modelo 3D (.glb)</label>
                    <!-- Input oculto real -->
                    <input type="file" id="real-file-input" accept=".glb" style="display: none;">
                    
                    <!-- Bot√≥n disparador visible -->
                    <button id="btn-select-file" class="w-full border-2 border-dashed border-slate-300 rounded-xl p-5 text-center bg-slate-50 hover:bg-blue-50 hover:border-blue-400 transition group">
                        <div class="text-3xl mb-2">üìÇ</div>
                        <p id="file-name-display" class="text-sm font-bold text-slate-600 truncate">Toca para buscar archivo</p>
                    </button>
                </div>

                <!-- UBICACI√ìN -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase">2. Ubicaci√≥n</label>
                        <button id="btn-get-gps" class="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full font-bold hover:bg-blue-200 active:scale-95 transition">
                            üìç Detectar mi ubicaci√≥n
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="in-lat" placeholder="Latitud" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none">
                        <input type="number" id="in-lng" placeholder="Longitud" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <!-- ACCIONES -->
                <button id="btn-save" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-emerald-700 active:scale-95 transition">
                    üíæ Guardar Proyecto
                </button>
                
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="app.nav('map')" id="nav-map" class="bg-white border border-slate-200 text-slate-700 py-3 rounded-xl font-bold text-sm hover:bg-slate-50 disabled:opacity-50" disabled>üó∫Ô∏è Mapa</button>
                    <button onclick="app.nav('scale')" class="bg-white border border-slate-200 text-slate-700 py-3 rounded-xl font-bold text-sm hover:bg-slate-50">üìè Escala</button>
                </div>
                
                <div class="text-center">
                     <button id="btn-reset" class="text-xs text-red-400 underline">Resetear App</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. P√ÅGINA MAPA -->
    <div id="map-page" class="page">
        <div id="map-c" class="w-full h-full z-0"></div>
        <div class="absolute top-4 left-4 z-20"><button onclick="app.nav('upload')" class="bg-white/90 backdrop-blur px-4 py-2 rounded-lg shadow font-bold text-xs text-slate-700">‚Üê Volver</button></div>
        <div class="absolute bottom-8 left-0 w-full px-6 z-20 pointer-events-none">
            <div class="bg-white/95 backdrop-blur p-4 rounded-2xl shadow-2xl pointer-events-auto text-center max-w-sm mx-auto">
                <p class="text-xs text-slate-500 mb-3 font-medium">Mueve el mapa para ajustar</p>
                <div class="flex gap-2">
                    <button id="btn-map-fix" class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold text-xs shadow">FIJAR AQU√ç</button>
                    <button onclick="app.startAR()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold text-xs shadow">INICIAR AR üöÄ</button>
                </div>
            </div>
        </div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none z-10"><div class="w-8 h-8 border-2 border-white rounded-full shadow-lg"></div><div class="w-1 h-1 bg-red-500 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 rounded-full"></div></div>
    </div>

    <!-- 3. P√ÅGINA ESCALA -->
    <div id="scale-page" class="page items-center justify-center p-4 bg-white">
        <div class="w-full max-w-md space-y-5">
            <h2 class="text-xl font-bold text-center text-slate-800">Dimensiones Reales</h2>
            <div class="space-y-3">
                <div><label class="text-[10px] font-bold text-slate-400">ANCHO (X)</label><input id="dim-w" type="number" class="w-full bg-slate-50 border p-3 rounded-xl font-mono font-bold" value="10"></div>
                <div><label class="text-[10px] font-bold text-slate-400">ALTO (Y)</label><input id="dim-h" type="number" class="w-full bg-slate-50 border p-3 rounded-xl font-mono font-bold" value="3"></div>
                <div><label class="text-[10px] font-bold text-slate-400">FONDO (Z)</label><input id="dim-d" type="number" class="w-full bg-slate-50 border p-3 rounded-xl font-mono font-bold" value="10"></div>
            </div>
            <div class="flex gap-2"><button onclick="app.nav('upload')" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">Cancelar</button><button onclick="app.nav('upload'); app.log('Escala guardada')" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow">Guardar</button></div>
        </div>
    </div>

    <!-- 4. P√ÅGINA AR -->
    <div id="ar-page" class="page bg-black">
        <div id="ar-c"></div>
        <div class="absolute inset-0 pointer-events-none z-50 flex flex-col justify-between p-4">
            <div class="flex justify-between items-start pointer-events-auto">
                <div class="bg-black/60 backdrop-blur text-white px-3 py-1 rounded-full text-xs font-mono border border-white/10 shadow-lg">GPS: <span id="ar-gps-stat" class="text-yellow-400">...</span></div>
                <button onclick="document.getElementById('adj-panel').classList.toggle('hidden')" class="bg-black/60 backdrop-blur p-2 rounded-lg text-white border border-white/10 shadow-lg">‚öôÔ∏è</button>
            </div>
            
            <!-- PANEL AJUSTES -->
            <div id="adj-panel" class="absolute top-14 right-4 w-64 bg-black/80 backdrop-blur p-4 rounded-2xl border border-white/10 text-white pointer-events-auto hidden">
                <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-3 border-b border-white/10 pb-2">Calibraci√≥n</h4>
                <div class="space-y-4">
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Altura</span><span id="val-h" class="text-blue-400">0m</span></div><input type="range" id="sl-h" min="-10" max="10" step="0.5" value="0"></div>
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Escala</span><span id="val-s" class="text-blue-400">1.0x</span></div><input type="range" id="sl-s" min="0.1" max="3" step="0.1" value="1"></div>
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Rotaci√≥n</span><span id="val-r" class="text-blue-400">0¬∞</span></div><input type="range" id="sl-r" min="0" max="360" step="5" value="0"></div>
                </div>
            </div>

            <div class="flex justify-center pointer-events-auto pb-8">
                <button onclick="location.reload()" class="bg-red-500/90 backdrop-blur text-white px-8 py-3 rounded-full font-bold shadow-xl hover:bg-red-600 text-sm">‚ùå SALIR</button>
            </div>
        </div>
        <div id="ar-loader" class="absolute inset-0 bg-slate-900 z-[60] flex flex-col items-center justify-center text-white hidden">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="font-bold">Iniciando AR...</p>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        
        // --- UTILIDADES ---
        const $ = id => document.getElementById(id);
        const CACHE_NAME = 'geo-ar-cache-v1';

        // --- ESTADO GLOBAL ---
        const st = {
            url: null,
            lat: 0,
            lng: 0,
            adj: { h: 0, s: 1, r: 0 }
        };

        let map, mk, arEnt, selectedFile;

        // --- L√ìGICA PRINCIPAL ---
        const app = {
            log: (msg) => {
                console.log(msg);
                const d = $('debug-log');
                d.style.display = 'block';
                d.textContent = `> ${msg}`;
                setTimeout(() => d.style.display = 'none', 4000);
            },

            // 1. PANTALLA DE PERMISOS (CR√çTICO)
            checkPermissions: async () => {
                const btn = $('btn-start-app');
                btn.innerHTML = "‚è≥ Solicitando...";
                btn.disabled = true;

                try {
                    // A. GPS
                    await new Promise((res, rej) => {
                        navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true });
                    });
                    $('perm-status-gps').querySelector('span:last-child').textContent = "‚úÖ OK";
                    $('perm-status-gps').querySelector('span:last-child').className = "text-emerald-400 font-bold";

                    // B. C√ÅMARA
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(t => t.stop()); // Cerrar stream
                    $('perm-status-cam').querySelector('span:last-child').textContent = "‚úÖ OK";
                    $('perm-status-cam').querySelector('span:last-child').className = "text-emerald-400 font-bold";

                    // √âxito
                    setTimeout(() => {
                        $('permission-screen').style.display = 'none';
                        $('upload-page').style.display = 'flex'; // Mostrar p√°gina carga
                        app.loadCache(); // Intentar cargar datos previos
                    }, 800);

                } catch (e) {
                    alert("‚ùå ERROR CR√çTICO: Debes conceder permisos de GPS y C√°mara. " + e.message);
                    btn.innerHTML = "REINTENTAR";
                    btn.disabled = false;
                }
            },

            // 2. CARGA DE ARCHIVO (M√âTODO CL√ÅSICO)
            selectFile: () => {
                $('real-file-input').click(); // Simular clic en el input oculto
            },

            handleFileSelect: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                selectedFile = file;
                st.url = URL.createObjectURL(file);
                
                // Feedback Visual
                $('file-name-display').textContent = "‚úÖ " + file.name;
                $('file-name-display').className = "text-sm font-bold text-emerald-600 truncate";
                $('btn-select-file').classList.add('border-emerald-500', 'bg-emerald-50');
                app.log("Archivo seleccionado correctamente");
            },

            // 3. GPS MANUAL
            getCurrentLocation: () => {
                const btn = $('btn-get-gps');
                btn.textContent = "‚è≥...";
                
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        $('in-lat').value = pos.coords.latitude.toFixed(6);
                        $('in-lng').value = pos.coords.longitude.toFixed(6);
                        btn.textContent = "‚úÖ Detectado";
                        app.log("GPS detectado con √©xito");
                        setTimeout(() => btn.textContent = "üìç Detectar mi ubicaci√≥n", 2000);
                    },
                    (err) => {
                        alert("Error GPS: " + err.message);
                        btn.textContent = "‚ùå Error";
                    },
                    { enableHighAccuracy: true }
                );
            },

            // 4. GUARDADO (CACHE API REAL)
            saveData: async () => {
                st.lat = parseFloat($('in-lat').value);
                st.lng = parseFloat($('in-lng').value);

                if (isNaN(st.lat) || isNaN(st.lng)) return alert("Faltan coordenadas");
                if (!selectedFile && !st.url) return alert("Falta archivo 3D");

                app.log("Guardando en cach√©...");
                
                try {
                    const cache = await caches.open(CACHE_NAME);
                    
                    // Si hay archivo nuevo, guardarlo. Si no, usamos el existente.
                    if (selectedFile) {
                        await cache.put('model.glb', new Response(selectedFile));
                    }

                    // Guardar JSON de coordenadas
                    const data = { lat: st.lat, lng: st.lng };
                    await cache.put('data.json', new Response(JSON.stringify(data)));

                    // Habilitar Mapa
                    $('nav-map').disabled = false;
                    alert("‚úÖ Proyecto Guardado Correctamente");
                    
                } catch (e) {
                    console.error(e);
                    alert("Error guardando: " + e.message);
                }
            },

            loadCache: async () => {
                try {
                    const cache = await caches.open(CACHE_NAME);
                    const modelRes = await cache.match('model.glb');
                    const dataRes = await cache.match('data.json');

                    if (modelRes && dataRes) {
                        const blob = await modelRes.blob();
                        st.url = URL.createObjectURL(blob);
                        selectedFile = null; // Ya tenemos blobUrl

                        const data = await dataRes.json();
                        st.lat = data.lat;
                        st.lng = data.lng;

                        // Llenar UI
                        $('in-lat').value = st.lat;
                        $('in-lng').value = st.lng;
                        $('file-name-display').textContent = "‚úÖ Modelo Cargado de Memoria";
                        $('file-name-display').className = "text-sm font-bold text-blue-600 truncate";
                        $('nav-map').disabled = false;
                        app.log("Datos restaurados de cach√©");
                    }
                } catch (e) {
                    console.log("No hay cach√©");
                }
            },

            // 5. NAVEGACI√ìN
            nav: (p) => {
                document.querySelectorAll('.page').forEach(x => {
                    x.classList.remove('active');
                    x.style.display = 'none';
                });
                const target = $(p + '-page');
                target.classList.add('active');
                target.style.display = 'flex'; // Forzar flex para centrado

                if (p === 'map') setTimeout(initMap, 200);
            },

            startAR: async () => {
                if (!st.url) return alert("Error: Modelo no cargado");
                app.nav('ar');
                $('ar-loader').classList.remove('hidden');
                
                try {
                    await loadARLibs();
                    initScene();
                } catch(e) {
                    alert("Error cargando AR: " + e);
                    location.reload();
                }
            }
        };

        // --- MAPA ---
        function initMap() {
            if (!map) {
                map = L.map('map-c').setView([st.lat, st.lng], 18);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Esri'}).addTo(map);
            } else {
                map.invalidateSize();
                map.setView([st.lat, st.lng], 18);
            }

            if (mk) mk.setLatLng([st.lat, st.lng]);
            else mk = L.marker([st.lat, st.lng]).addTo(map);
        }

        // --- ESCENA AR ---
        function initScene() {
            $('ar-c').innerHTML = '';
            const html = `
                <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;" renderer="logarithmicDepthBuffer: true; colorManagement: true;">
                    <a-camera gps-camera="minDistance: 2;" rotation-reader near="0.1" far="10000"></a-camera>
                    <a-light type="ambient" intensity="1"></a-light>
                    <a-light type="directional" intensity="1.5" position="-1 1 0"></a-light>
                    <a-entity id="ent" gps-entity-place="latitude: ${st.lat}; longitude: ${st.lng};" position="0 0 0" scale="1 1 1" gltf-model="${st.url}" visible="false"></a-entity>
                </a-scene>
            `;
            $('ar-c').innerHTML = html;
            
            const el = document.querySelector('#ent');
            arEnt = el;

            el.addEventListener('model-loaded', () => {
                // Fix doble cara
                const mesh = el.getObject3D('mesh');
                if (mesh) mesh.traverse(n => { if (n.isMesh) { n.material.side = THREE.DoubleSide; n.material.transparent = true; } });
                
                el.setAttribute('visible', 'true');
                $('ar-loader').classList.add('hidden');
                app.log("Modelo AR Visible");
            });

            window.addEventListener('gps-camera-update-position', e => {
                const acc = Math.round(e.detail.position.accuracy);
                $('ar-gps-stat').textContent = `¬±${acc}m`;
            });
        }

        // --- EVENTOS ---
        window.addEventListener('DOMContentLoaded', () => {
            // Inicio
            $('btn-start-app').addEventListener('click', app.checkPermissions);
            
            // Archivos
            $('btn-select-file').addEventListener('click', app.selectFile);
            $('real-file-input').addEventListener('change', app.handleFileSelect);
            
            // GPS & Guardado
            $('btn-get-gps').addEventListener('click', app.getCurrentLocation);
            $('btn-save').addEventListener('click', app.saveData);
            
            // Mapa Set
            $('btn-map-fix').addEventListener('click', () => {
                const c = map.getCenter();
                st.lat = c.lat; st.lng = c.lng;
                $('in-lat').value = st.lat.toFixed(6);
                $('in-lng').value = st.lng.toFixed(6);
                mk.setLatLng(c);
                app.log("Ubicaci√≥n fijada desde mapa");
            });

            // Reset
            $('btn-reset').addEventListener('click', async () => {
                if (confirm("¬øBorrar todo?")) {
                    await caches.delete(CACHE_NAME);
                    location.reload();
                }
            });

            // Sliders AR
            const upd = () => {
                if (!arEnt) return;
                arEnt.setAttribute('position', `0 ${st.adj.h} 0`);
                arEnt.setAttribute('scale', `${st.adj.s} ${st.adj.s} ${st.adj.s}`);
                arEnt.setAttribute('rotation', `0 ${st.adj.r} 0`);
            };
            $('sl-h').oninput = e => { st.adj.h = parseFloat(e.target.value); $('val-h').textContent=st.adj.h+'m'; upd(); };
            $('sl-s').oninput = e => { st.adj.s = parseFloat(e.target.value); $('val-s').textContent=st.adj.s+'x'; upd(); };
            $('sl-r').oninput = e => { st.adj.r = parseFloat(e.target.value); $('val-r').textContent=st.adj.r+'¬∞'; upd(); };
        });
    </script>
</body>
</html>

