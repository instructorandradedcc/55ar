<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visor AR Arquitectura por Geolocalización</title>
    <!-- Favicon Actualizado -->
    <link rel="icon" type="image/png" href="https://github.com/instructorandradedcc/55ar/raw/main/favicon3dAR.png">
    <!-- PWA Manifest (Inlined) -->
    <link rel="manifest"
        href='data:application/manifest+json,{"name":"AR Constructor Pro","short_name":"AR Pro","start_url":"./index.html","display":"standalone","background_color":"#000000","theme_color":"#4CAF50","icons":[{"src":"https://github.com/instructorandradedcc/55ar/raw/main/favicon3dAR.png","sizes":"192x192","type":"image/png"},{"src":"https://github.com/instructorandradedcc/55ar/raw/main/favicon3dAR.png","sizes":"512x512","type":"image/png"}]}'>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame y AR.js se cargarán dinámicamente -->
    <script>
        const APP_VERSION = '0.06';
        // Variable global para controlar cuándo cargar A-Frame y AR.js
        let arLibrariesLoaded = false;

        // Función para cargar las bibliotecas de AR dinámicamente
        function loadARLibraries() {
            if (arLibrariesLoaded) return Promise.resolve();

            return new Promise((resolve) => {
                const aframeScript = document.createElement('script');
                aframeScript.src = 'https://aframe.io/releases/1.3.0/aframe.min.js';  // Revertido a 1.3.0 para compatibilidad con AR.js
                document.head.appendChild(aframeScript);

                aframeScript.onload = () => {
                    const arjsScript = document.createElement('script');
                    arjsScript.src = 'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js';
                    document.head.appendChild(arjsScript);

                    arjsScript.onload = () => {
                        arLibrariesLoaded = true;
                        resolve();
                    };
                };
            });
        }
    </script>
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
            }
        }
    </script>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: transparent !important;
        }

        .page {
            display: none;
            height: 100%;
            width: 100%;
            position: relative;
        }

        .page.active {
            display: block;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .control-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .control-button:hover {
            background-color: #45a049;
        }

        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }

        #message-box.show {
            opacity: 1;
        }

        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #map-canvas {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #model-preview-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 401;
            display: block;
        }

        .map-ui-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 300px;
        }

        #map-controls {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 402;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #map-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px black;
            pointer-events: none;
            z-index: 402;
        }

        #coords-jumpto {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            gap: 5px;
            align-items: center;
        }

        a-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1 !important;
            background: transparent !important;
        }

        .arjs-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            z-index: 10000;
            text-align: center;
        }

        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .permission-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            text-align: center;
        }

        .permission-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }

        #ar-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            gap: 10px;
        }

        .ar-info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9998;
        }

        .ar-scale-control {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            z-index: 9998;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #map-controls {
                top: 120px !important;
                right: 10px !important;
            }

            .map-ui-container {
                width: 280px !important;
                bottom: 10px !important;
            }

            #coords-jumpto {
                top: 70px !important;
                left: 10px !important;
            }
        }

        /* Estilos para la página de carga interactiva */
        .ar-loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #2a5298);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10002;
        }

        .ar-loading-screen.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            max-width: 80%;
        }

        .loading-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .loading-progress {
            width: 80%;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin: 20px auto;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            width: 0%;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .loading-steps {
            margin-top: 30px;
            text-align: left;
        }

        .loading-step {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }

        .step-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .step-icon.completed {
            color: #4CAF50;
        }

        .step-icon.active {
            color: #FFC107;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .ar-debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 5px;
            font-size: 10px;
            z-index: 10003;
            display: none;
        }

        /* * =================================================================================
         * CORRECCIÓN CRÍTICA: Forzar la visualización del video de la cámara AR
         * =================================================================================
         * Estilos agresivos para asegurar que el video de la cámara sea visible
         * como fondo en todos los dispositivos, especialmente iOS y Android.
         * =================================================================================
         */
        video {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            z-index: -1 !important;
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            /* Atributos críticos para iOS y móviles */
            autoplay: true !important;
            playsinline: true !important;
            webkit-playsinline: true !important;
            muted: true !important;
        }

        .arjs-video {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            z-index: -1 !important;
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            autoplay: true !important;
            playsinline: true !important;
            webkit-playsinline: true !important;
            muted: true !important;
        }

        .a-canvas {
            z-index: 1 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }

        /*
         * =================================================================================
         * CORRECCIÓN CRÍTICA: Forzar transparencia completa en el canvas de A-Frame
         * =================================================================================
         */
        #ar-scene {
            background: transparent !important;
            background-color: transparent !important;
        }

        #ar-scene .a-canvas {
            background: transparent !important;
            background-color: rgba(0, 0, 0, 0) !important;
        }

        canvas {
            background: transparent !important;
            background-color: rgba(0, 0, 0, 0) !important;
        }

        /* Estilos para los inputs de escala */
        .scale-input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .scale-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }

        .scale-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .scale-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        /* Estilos para el indicador de GPS */
        .gps-indicator {
            position: fixed;
            top: 80px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9998;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gps-indicator.active {
            background-color: rgba(76, 175, 80, 0.8);
        }

        .gps-indicator.error {
            background-color: rgba(244, 67, 54, 0.8);
        }

        .gps-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #4CAF50;
            animation: gps-pulse 2s infinite;
        }

        @keyframes gps-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        /* Estilos para el panel de coordenadas del modelo */
        .model-coords-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9998;
            min-width: 200px;
        }

        .coord-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .coord-label {
            font-weight: bold;
            color: #4CAF50;
        }

        .coord-value {
            font-family: monospace;
        }

        /* Estilos para los indicadores de ubicación en AR */
        .location-indicator {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 9997;
            display: flex;
            align-items: center;
            gap: 5px;
            pointer-events: none;
        }

        .current-location-indicator {
            bottom: 100px;
            left: 20px;
            background-color: rgba(76, 175, 80, 0.9);
            border: 2px solid #4CAF50;
        }

        .model-location-indicator {
            bottom: 100px;
            right: 20px;
            background-color: rgba(255, 152, 0, 0.9);
            border: 2px solid #FF9800;
        }

        .location-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
        }

        /* Estilos para la línea de conexión */
        .connection-line {
            position: fixed;
            background: linear-gradient(90deg, #4CAF50, #FF9800);
            height: 3px;
            transform-origin: left center;
            z-index: 9996;
            pointer-events: none;
            opacity: 0.7;
        }

        /* Estilos para el panel de distancia */
        .distance-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            z-index: 9997;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid #4CAF50;
        }

        .distance-value {
            color: #4CAF50;
            font-size: 18px;
        }

        /* Estilos para el modo de exploración */
        .exploration-mode {
            position: fixed;
            top: 140px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9998;
            display: none;
        }

        .exploration-mode.active {
            display: block;
        }

        .mode-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        /* Botón de inicio forzado para iOS */
        .ios-start-button {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #4CAF50;
            userMessage="No se encontró una cámara trasera. Asegúrate de estar en un dispositivo móvil.";
        }

        else if (error.name==="NotAllowedError" || error.name==="PermissionDeniedError") {
            userMessage="Acceso a cámara y GPS denegado. Habilítalos en los ajustes de tu navegador.";
        }

        else if (error.message) {
            userMessage=error.message;
        }

        showMessage(userMessage, 5000);
        navigateTo('scale');
        }
        }

        ;

        function initializeARScene() {
            const arSceneContainer=document.getElementById('ar-scene-container');
            arSceneContainer.innerHTML='';

            const targetCoords=appState.arTargetCoords || appState.coords;

            // Actualizar el panel de coordenadas del modelo
            document.getElementById('model-lat').textContent=targetCoords.latitude.toFixed(6);
            document.getElementById('model-lon').textContent=targetCoords.longitude.toFixed(6);
            document.getElementById('model-height').textContent=appState.realDimensions.groundHeight.toFixed(2)+'m';

            // Mostrar indicadores de ubicación en AR
            currentLocationIndicator.style.display='flex';
            modelLocationIndicator.style.display='flex';
            distancePanel.style.display='flex';

            /*
             * =================================================================================
             * CORRECCIÓN: Ajustes para resolver pantalla azul/negra y GPS no detectado
             * =================================================================================
             * - Revertir a gps-camera y gps-entity-place para compatibilidad estable.
             * - Agregar parámetros de resolución para evitar estiramiento o negro.
             * - Forzar high accuracy en GPS y agregar debug.
             * - Remover background en escena y forzar transparent.
             * =================================================================================
             */
            arSceneContainer.innerHTML=` <a-scene id="ar-scene"
            embedded vr-mode-ui="enabled: false"
            renderer="logarithmicDepthBuffer: true; antialias: true; precision: high; alpha: true;"
            style="background: transparent;"
            arjs="sourceType: webcam; videoTexture: true; sourceWidth: 640; sourceHeight: 480; displayWidth: 640; displayHeight: 480; debugUIEnabled: false;"><a-camera id="ar-camera"
            gps-camera="gpsMinDistance: 5; gpsTimeInterval: 1000;"
            rotation-reader camera="active: true; near: 0.1; far: 10000;"></a-camera><a-entity id="arch-model"
            gltf-model="url(${appState.modelURL})"
            gps-entity-place="latitude: ${targetCoords.latitude}; longitude: ${targetCoords.longitude};"
            position="0 ${appState.realDimensions.groundHeight} 0"
            scale="1 1 1"
            animation-mixer visible="false"></a-entity><a-light type="ambient" color="#BBB" intensity="1.5"></a-light><a-light type="directional" color="#FFF" intensity="0.8" position="-0.5 1 1"></a-light></a-scene>`;

            arScene=document.querySelector('#ar-scene');
            arCamera=document.querySelector('#ar-camera');
            arModel=document.querySelector('#arch-model');

            arScene.addEventListener('loaded', ()=> {
                    console.log('Escena AR cargada correctamente');
                    showDebugInfo('Escena AR cargada');

                    if (arScene.renderer) {
                        arScene.renderer.setClearColor(0x000000, 0); // Transparente
                        arScene.renderer.setPixelRatio(window.devicePixelRatio);
                        arScene.renderer.setSize(window.innerWidth, window.innerHeight);
                        const canvas=arScene.renderer.domElement;
                        canvas.style.backgroundColor='transparent';
                        canvas.style.background='transparent';
                        showDebugInfo('Renderer configurado para transparencia');
                    }

                    // Forzar la visualización del video con retardo
                    setTimeout(()=> {
                            forceVideoVisibility();
                        }

                        , 1000);

                    window.addEventListener('gps-camera-update-position', onGPSUpdate);
                    window.addEventListener('gps-camera-error', onGPSError);
                    arModel.addEventListener('model-loaded', onModelLoaded);
                    arModel.addEventListener('model-error', onModelError);

                    startGPSWatch();
                });

            arScene.addEventListener('error', (event)=> {
                    console.error('Error al cargar la escena AR:', event.detail);

                    showDebugInfo(`Error de escena: $ {
                            event.detail
                        }

                        `);
                    showMessage('Error al cargar la escena AR. Verifica la consola para más detalles.', 5000);
                });

            setTimeout(()=> {
                    if (arLoadingScreen.classList.contains('active')) {
                        console.warn('La escena AR tardó demasiado en cargar, forzando visualización');
                        showDebugInfo('Forzando visualización de la escena AR');
                        arLoadingScreen.classList.remove('active');
                        showMessage('La escena AR está cargando, puede tardar unos segundos...', 3000);
                    }
                }

                , 10000);
        }

        function forceVideoVisibility() {
            const videos=document.querySelectorAll('video');

            if (videos.length > 0) {
                videos.forEach(video=> {
                        video.style.position='fixed';
                        video.style.top='0';
                        video.style.left='0';
                        video.style.width='100%';
                        video.style.height='100%';
                        video.style.objectFit='cover';
                        video.style.zIndex='-1';
                        video.style.display='block';
                        video.style.opacity='1';
                        video.style.visibility='visible';
                        video.style.backgroundColor='transparent'; // Cambiado para evitar colores de fondo

                        video.setAttribute('autoplay', 'true');
                        video.setAttribute('playsinline', 'true');
                        video.setAttribute('webkit-playsinline', 'true');
                        video.setAttribute('muted', 'true');

                        forceVideoPlay(video);
                    });
                showDebugInfo('Video de cámara forzado a ser visible');
            }

            else {
                showDebugInfo('No se encontró el elemento video, reintentando...');
                setTimeout(forceVideoVisibility, 1000);
            }

            const canvases=document.querySelectorAll('canvas');

            if (canvases.length > 0) {
                canvases.forEach(canvas=> {
                        canvas.style.zIndex='1';
                        canvas.style.position='fixed';
                        canvas.style.top='0';
                        canvas.style.left='0';
                        canvas.style.width='100%';
                        canvas.style.height='100%';
                        canvas.style.pointerEvents='none';
                        canvas.style.backgroundColor='transparent';
                        canvas.style.background='transparent';
                    });
                showDebugInfo('Canvas configurado para transparencia');
            }
        }

        function forceVideoPlay(video) {
            if ( !video) return;

            const playPromise=video.play();

            if (playPromise !==undefined) {
                playPromise.then(()=> {
                        console.log('Video reproduciéndose correctamente');
                        appState.videoStarted=true;
                        showDebugInfo('Video iniciado correctamente');

                        if (appState.isIOS && iosStartButton.classList.contains('show')) {
                            iosStartButton.classList.remove('show');
                        }

                    }).catch(error=> {
                        console.error('Error al reproducir video:', error);

                        showDebugInfo(`Error al reproducir video: $ {
                                error.message
                            }

                            `);

                        if (appState.isIOS && !iosStartButton.classList.contains('show')) {
                            iosStartButton.classList.add('show');
                            showDebugInfo('Mostrando botón de inicio para iOS');
                        }
                    });
            }

            else {
                appState.videoStarted=true;
                showDebugInfo('Video iniciado (método legacy)');
            }
        }

        function startVideoWithUserInteraction() {
            const videos=document.querySelectorAll('video');

            if (videos.length > 0) {
                videos.forEach(video=> {
                        forceVideoPlay(video);
                    });
            }

            iosStartButton.classList.remove('show');

            showMessage('Cámara AR iniciada', 2000);
        }

        iosStartButton.addEventListener('click', startVideoWithUserInteraction);

        document.addEventListener('touchstart', function () {
                if ( !appState.videoStarted && pages.ar.classList.contains('active')) {
                    startVideoWithUserInteraction();
                }
            }

            , {
            once: true
        });

        document.addEventListener('click', function () {
                if ( !appState.videoStarted && pages.ar.classList.contains('active')) {
                    startVideoWithUserInteraction();
                }
            }

            , {
            once: true
        });

        function updateLocationIndicators() {
            if ( !appState.currentGPSLocation || !appState.arTargetCoords) return;

            const currentLocText=`TÚ: $ {
                appState.currentGPSLocation.latitude.toFixed(6)
            }

            ,
            $ {
                appState.currentGPSLocation.longitude.toFixed(6)
            }

            `;
            currentLocationIndicator.querySelector('span').textContent=currentLocText;

            const modelLocText=`MODELO: $ {
                appState.arTargetCoords.latitude.toFixed(6)
            }

            ,
            $ {
                appState.arTargetCoords.longitude.toFixed(6)
            }

            `;
            modelLocationIndicator.querySelector('span').textContent=modelLocText;

            const distance=calculateDistance(appState.currentGPSLocation.latitude,
                appState.currentGPSLocation.longitude,
                appState.arTargetCoords.latitude,
                appState.arTargetCoords.longitude);

            arDistanceValue.textContent=`$ {
                distance.toFixed(1)
            }

            m`;

            document.getElementById('model-distance').textContent=`$ {
                distance.toFixed(2)
            }

            m`;
            document.getElementById('current-distance').textContent=distance.toFixed(0);
        }

        function startGPSWatch() {
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
            }

            const MIN_DISTANCE_UPDATE=2; // Mínimo 2 metros de cambio para actualizar

            gpsWatchId=navigator.geolocation.watchPosition((position)=> {
                    const newLocation= {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    }

                    ;

                    // Si no hay ubicación previa, la establecemos
                    if ( !appState.currentGPSLocation) {
                        appState.currentGPSLocation=newLocation;
                    }

                    else {
                        // Calculamos la distancia desde la última ubicación conocida
                        const distanceMoved=calculateDistance(appState.currentGPSLocation.latitude,
                            appState.currentGPSLocation.longitude,
                            newLocation.latitude,
                            newLocation.longitude);

                        // Solo actualizamos si el movimiento es significativo
                        if (distanceMoved > MIN_DISTANCE_UPDATE) {
                            appState.currentGPSLocation=newLocation;

                            showDebugInfo(`GPS actualizado (movió $ {
                                        distanceMoved.toFixed(2)
                                    }

                                    m)`);
                        }

                        else {
                            // Si el movimiento es pequeño, actualizamos solo la precisión para el panel
                            appState.currentGPSLocation.accuracy=newLocation.accuracy;
                        }
                    }

                    console.log('Posición GPS recibida:', newLocation);

                    showDebugInfo(`GPS: $ {
                            newLocation.latitude
                        }

                        , $ {
                            newLocation.longitude
                        }

                        (Precisión: $ {
                                newLocation.accuracy.toFixed(1)
                            }

                            m)`);

                    gpsIndicator.classList.add('active');
                    gpsIndicator.classList.remove('error');

                    gpsIndicatorText.textContent=`GPS: Activo ($ {
                            newLocation.accuracy.toFixed(1)
                        }

                        m)`;

                    document.getElementById('gps-status').textContent='Activo';
                    document.getElementById('gps-accuracy').textContent=newLocation.accuracy.toFixed(1);

                    updateLocationIndicators();

                    gpsInitialized=true;

                    if (modelLoaded) {
                        adjustModelScale();
                    }
                }

                ,
                (error)=> {
                    console.error('Error al obtener la posición GPS:', error);

                    showDebugInfo(`Error de GPS: $ {
                            error.message
                        }

                        `);

                    gpsIndicator.classList.add('error');
                    gpsIndicator.classList.remove('active');
                    gpsIndicatorText.textContent='GPS: Error';

                    document.getElementById('gps-status').textContent='Error';

                    let errorMessage='Error de GPS desconocido';

                    switch (error.code) {
                        case error.PERMISSION_DENIED: errorMessage='Permiso de GPS denegado';
                        break;
                        case error.POSITION_UNAVAILABLE: errorMessage='Información de GPS no disponible';
                        break;
                        case error.TIMEOUT: errorMessage='Tiempo de espera agotado para obtener GPS';
                        break;
                    }

                    showMessage(`Error de GPS: $ {
                            errorMessage
                        }

                        `, 5000);
                }

                ,
                {
                enableHighAccuracy: true,
                timeout: 5000, // Reducido para respuestas más rápidas
                maximumAge: 0
            });
        }

        // **CORRECCIÓN: Esta función ya no es necesaria y puede causar conflictos**
        // AR.js con gps-entity-place maneja el posicionamiento del modelo.
        // La comentamos para evitar interferencias.
        /*
        function updateModelPosition() {
            // ... código anterior ...
        }
        */

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1=lat1 * Math.PI / 180;
            const φ2=lat2 * Math.PI / 180;
            const Δλ=(lon2 - lon1) * Math.PI / 180;

            const y=Math.sin(Δλ) * Math.cos(φ2);
            const x=Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);

            const θ=Math.atan2(y, x);
            const bearing=(θ * 180 / Math.PI + 360) % 360;

            return bearing;
        }

        function updateConnectionLine() {
            if ( !appState.currentGPSLocation || !appState.arTargetCoords) return;

            connectionLine.style.display='block';

            const currentLoc=currentLocationIndicator.getBoundingClientRect();
            const modelLoc=modelLocationIndicator.getBoundingClientRect();

            const deltaX=modelLoc.left - currentLoc.left;
            const deltaY=modelLoc.top - currentLoc.top;
            const distance=Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const angle=Math.atan2(deltaY, deltaX) * 180 / Math.PI;

            connectionLine.style.width=distance+'px';
            connectionLine.style.left=currentLoc.right+'px';
            connectionLine.style.top=(currentLoc.top + currentLoc.height / 2)+'px';

            connectionLine.style.transform=`rotate($ {
                    angle
                }

                deg)`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R=6371e3; // Radio de la Tierra en metros
            const φ1=lat1 * Math.PI / 180;
            const φ2=lat2 * Math.PI / 180;
            const Δφ=(lat2 - lat1) * Math.PI / 180;
            const Δλ=(lon2 - lon1) * Math.PI / 180;

            const a=Math.sin(Δφ / 2) * Math.sin(Δφ / 2)+Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c=2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distancia en metros
        }

        function onGPSUpdate(event) {
            console.log('Evento de actualización GPS:', event.detail);
            showDebugInfo('Evento de actualización GPS recibido');

            const pos=event.detail.position;
            document.getElementById('gps-status').textContent='Activo';
            document.getElementById('gps-accuracy').textContent=pos.accuracy.toFixed(1);

            const accuracyElement=document.getElementById('gps-accuracy');

            if (pos.accuracy < 5) {
                accuracyElement.style.color='#4CAF50';
            }

            else if (pos.accuracy < 10) {
                accuracyElement.style.color='#FFC107';
            }

            else {
                accuracyElement.style.color='#F44336';
            }

            if (arLoadingScreen.classList.contains('active')) {
                arLoadingScreen.classList.remove('active');
            }

            showMessage(`GPS activado. Precisión: $ {
                    pos.accuracy.toFixed(2)
                }

                m. Para mejor precisión, asegúrate de tener vista clara del cielo.`, 4000);

            if (modelLoaded) {
                adjustModelScale();
            }
        }

        function onGPSError(event) {
            console.error('Error de GPS:', event.detail);

            showDebugInfo(`Error de GPS: $ {
                    event.detail.message
                }

                showDebugInfo(`Error al cargar modelo: $ {
                        event.detail
                    }

                    `);
                showMessage('Error al cargar el modelo 3D. Verifica que el archivo sea válido.', 5000);
            }

            function setupModelInteraction() {
                if ( !arModel || !arModel.object3D) return;

                arModel.setAttribute('class', 'intersectable');

                arScene.addEventListener('click', (event)=> {
                        if ( !appState.explorationMode) return;

                        mouse.x=(event.detail.clientX / window.innerWidth) * 2 - 1;
                        mouse.y=-(event.detail.clientY / window.innerHeight) * 2 + 1;

                        raycaster.setFromCamera(mouse, arCamera.components.camera.camera);

                        const intersects=raycaster.intersectObject(arModel.object3D, true);

                        if (intersects.length > 0) {
                            const intersection=intersects[0];

                            showDebugInfo(`Intersección en: $ {
                                    intersection.point.x.toFixed(2)
                                }

                                , $ {
                                    intersection.point.y.toFixed(2)
                                }

                                , $ {
                                    intersection.point.z.toFixed(2)
                                }

                                `);

                            if (intersection.object.material) {
                                intersection.object.material.color.set(0xff0000);

                                setTimeout(()=> {
                                        intersection.object.material.color.set(0xffffff);
                                    }

                                    , 500);

                                , $ {
                                    finalScaleZ.toFixed(2)
                                }

                                `);

                            document.getElementById('current-scale').textContent=appState.initialARScale.toFixed(1);

                            // **CORRECCIÓN: Ya no llamamos a updateModelPosition aquí**
                            // AR.js se encarga de posicionar el modelo.
                        }

                        , undefined, (error)=> {
                            console.error('Error al cargar el modelo para ajustar escala:', error);

                            showDebugInfo(`Error al ajustar escala: $ {
                                    error.message
                                }

                                `);
                        });
                }

                function stopAR() {
                    if (gpsWatchId) {
                        navigator.geolocation.clearWatch(gpsWatchId);
                        gpsWatchId=null;
                    }

                    if (arScene) {
                        arScene.pause();
                        arScene.parentNode.removeChild(arScene);
                        arScene=null;
                        arCamera=null;
                        arModel=null;
                    }

                    currentLocationIndicator.style.display='none';
                    modelLocationIndicator.style.display='none';
                    connectionLine.style.display='none';
                    distancePanel.style.display='none';
                    explorationMode.classList.remove('active');
                    iosStartButton.classList.remove('show');

                    modelLoaded=false;
                    gpsInitialized=false;
                    appState.videoStarted=false;

                    if (arDebugInfo) {
                        arDebugInfo.style.display='none';
                    }

                    navigateTo('scale');
                }

                // Funciones para manejo de caché
                async function clearCacheAndReload() {
                    await caches.delete(CACHE_NAME);
                    showMessage('Caché limpiado.');
                    setTimeout(()=> window.location.reload(), 1000);
                }

                async function loadDataFromCache() {
                    try {
                        const cache=await caches.open(CACHE_NAME);
                        const [modelRes,
                        coordsRes,
                        arTargetRes]=await Promise.all([ cache.match('cached-model.glb'),
                            cache.match('cached-coords.json'),
                            cache.match('cached-ar-target-coords.json')]);

                        if ( !modelRes || !coordsRes) throw new Error("Datos no encontrados en caché.");

                        appState.coords=await coordsRes.json();
                        appState.modelURL=URL.createObjectURL(await modelRes.blob());

                        if (arTargetRes) {
                            appState.arTargetCoords=await arTargetRes.json();
                        }

                        document.getElementById('upload-section').classList.add('hidden');
                        document.getElementById('load-data-btn').classList.add('hidden');
                        document.getElementById('status-section').classList.remove('hidden');
                        document.getElementById('goto-map-btn').disabled=false;
                        showMessage('Datos cargados desde el caché.');
                        return true;
                    }

                    catch (error) {
                        console.error('Error al cargar desde caché:', error);
                        return false;
                    }
                }

                async function saveDataToCache() {
                    const modelFile=document.getElementById('model-upload').files[0];
                    const lat=parseFloat(document.getElementById('latitude-input').value);
                    const lon=parseFloat(document.getElementById('longitude-input').value);

                    if ( !modelFile) {
                        showMessage('Error: Debes seleccionar un archivo de modelo 3D (.glb).', 5000);
                        return;
                    }

                    if ( !modelFile.name.toLowerCase().endsWith ('.glb')) {
                        showMessage('Error: El formato del archivo debe ser .glb', 5000);
                        return;
                    }

                    if (isNaN(lat) || isNaN(lon)) {
                        showMessage('Error: Debes introducir valores válidos para latitud y longitud.', 5000);
                        return;
                    }

                    showMessage('Guardando datos en caché...');

                    appState.coords= {
                        latitude: lat, longitude: lon
                    }

                    ;

                    try {
                        const cache=await caches.open(CACHE_NAME);

                        await Promise.all([ cache.put('cached-model.glb', new Response(modelFile)),
                            cache.put('cached-coords.json', new Response(new Blob([JSON.stringify(appState.coords)], {
                                        type: 'application/json'
                                    })))]);

                    await loadDataFromCache();
                    showMessage('¡Datos guardados y cargados exitosamente!', 3000);

                }

                catch (error) {
                    console.error('Error al guardar en caché:', error);
                    showMessage('Error al guardar datos. Inténtalo de nuevo.', 5000);
                }
            }

            async function updateCoordsInCache(coords) {
                appState.coords=coords;

                try {
                    const cache=await caches.open(CACHE_NAME);

                    await cache.put('cached-coords.json', new Response(new Blob([JSON.stringify(appState.coords)], {
                                type: 'application/json'
                            })));
            }

            catch (error) {
                console.error('Failed to update coordinates in cache:', error);
            }
        }

        async function applyCoordsToAR() {
            if ( !map) {
                showMessage('El mapa no está inicializado.', 2000);
                return;
            }

            const center=map.getCenter();

            appState.arTargetCoords= {
                latitude: center.lat, longitude: center.lng
            }

            ;

            try {
                const cache=await caches.open(CACHE_NAME);

                await cache.put('cached-ar-target-coords.json', new Response(new Blob([JSON.stringify(appState.arTargetCoords)], {
                            type: 'application/json'
                        })));

            showMessage(`Coordenadas aplicadas: $ {
                    center.lat.toFixed(6)
                }

                , $ {
                    center.lng.toFixed(6)
                }

                `, 3000);
        }

        catch (error) {
            console.error('Failed to save AR target coordinates in cache:', error);
            showMessage('Error al guardar coordenadas para AR.', 3000);
        }
        }

        function useCurrentLocation() {
            if ( !navigator.geolocation) {
                showMessage("Geolocalización no es soportada.");
                return;
            }

            showMessage("Obteniendo ubicación...");

            navigator.geolocation.getCurrentPosition(position=> {
                    document.getElementById('latitude-input').value=position.coords.latitude.toFixed(6);
                    document.getElementById('longitude-input').value=position.coords.longitude.toFixed(6);
                    showMessage("Ubicación obtenida.");
                }

                ,
                error=> {
                    console.error('Error al obtener ubicación:', error);
                    showMessage("No se pudo obtener la ubicación. Revisa los permisos.");
                }

                ,
                {
                enableHighAccuracy: true, timeout: 10000, maximumAge: 0
            });
        }

        function initMapAndPreview() {
            if ( !appState.coords) {
                navigateTo('upload');
                return;
            }

            if (map) {
                map.remove();
                map=null;
            }

            const mapContainer=document.getElementById('map-canvas');

            map=L.map(mapContainer, {
                zoomControl: false,
                preferCanvas: true
            }).setView([appState.coords.latitude, appState.coords.longitude], 18);

        const osmTiles=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });

        const googleSat=L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: 'Imagery &copy;2025 Google'
        });

        const googleHybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: 'Imagery &copy;2025 Google, Map data &copy;2025 Google'
        });

        googleSat.addTo(map);

        const baseMaps= {
            "OpenStreetMap": osmTiles,
                "Google Satélite": googleSat,
                "Google Híbrido": googleHybrid
        }

        ;

        L.control.layers(baseMaps, null, {
            position: 'topright'
        }).addTo(map);

        const initialMarker=L.marker([appState.coords.latitude, appState.coords.longitude], {
            draggable: true,
            autoPan: true
        }).addTo(map) .bindPopup('Ubicación Inicial (Arrástrame)') .openPopup();

        initialMarker.on('dragend', function (event) {
                const newPosition=event.target.getLatLng();

                appState.coords= {
                    latitude: newPosition.lat, longitude: newPosition.lng
                }

                ;
                updateCoordsInCache(appState.coords);
                document.getElementById('jumpto-lat').value=newPosition.lat.toFixed(6);
                document.getElementById('jumpto-lon').value=newPosition.lng.toFixed(6);
                showMessage('Ubicación inicial actualizada.', 3000);
            });

        if (appState.arTargetCoords) {
            modelLocationMarker=L.marker([appState.arTargetCoords.latitude, appState.arTargetCoords.longitude]) .addTo(map) .bindPopup('Ubicación del Modelo 3D') .setIcon(L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                }));
        }

        if (appState.currentGPSLocation) {
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }

            currentLocationMarker=L.marker([appState.currentGPSLocation.latitude, appState.currentGPSLocation.longitude]) .addTo(map) .bindPopup('Tu ubicación actual (GPS)') .setIcon(L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                }));
        }

        map.on('moveend', ()=> {
                const newCoords=map.getCenter();

                updateCoordsInCache({
                    latitude: newCoords.lat, longitude: newCoords.lng
                });
            document.getElementById('jumpto-lat').value=newCoords.lat.toFixed(6);
            document.getElementById('jumpto-lon').value=newCoords.lng.toFixed(6);
        });

        document.getElementById('jumpto-lat').value=appState.coords.latitude.toFixed(6);
        document.getElementById('jumpto-lon').value=appState.coords.longitude.toFixed(6);

        initModelPreview();

        setTimeout(()=> {
                showMessage("1 dedo: inclinar. 2 dedos: girar.", 5000);
            }

            , 500);
        }

        async function initModelPreview() {
            const canvas=document.getElementById('model-preview-canvas');
            const container=document.getElementById('map-container');

            if ( !container) return;

            canvas.style.display='block';
            canvas.style.zIndex='401';

            modelPreview.renderer=new THREE.WebGLRenderer({
                canvas,
                alpha: true,
                antialias: true,
                logarithmicDepthBuffer: true
            });

        modelPreview.renderer.setSize(container.clientWidth, container.clientHeight);
        modelPreview.renderer.setPixelRatio(window.devicePixelRatio);
        modelPreview.renderer.setClearColor(0x000000, 0);

        modelPreview.scene=new THREE.Scene();
        modelPreview.camera=new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        modelPreview.camera.position.set(0, 40, 30);
        modelPreview.camera.lookAt(0, 0, 0);

        modelPreview.scene.add(new THREE.AmbientLight(0xffffff, 1.8));

        const dirLight=new THREE.DirectionalLight(0xffffff, 2.5);
        dirLight.position.set(5, 10, 7.5);
        modelPreview.scene.add(dirLight);

        if (modelPreview.model) {
            modelPreview.scene.remove(modelPreview.model);
        }

        try {
            const loader=new GLTFLoader();
            const gltf=await loader.loadAsync(appState.modelURL);
            modelPreview.model=gltf.scene;

            modelPreview.model.traverse((node)=> {
                    if (node.isMesh && node.material) {
                        node.material.transparent=false;
                        node.material.depthWrite=true;
                        node.material.needsUpdate=true;
                    }
                });

            const box=new THREE.Box3().setFromObject(modelPreview.model);
            const size=new THREE.Vector3();
            box.getSize(size);
            modelPreview.maxSize=Math.max(size.x, size.y, size.z) || 1;

            appState.modelBounds= {
                width: size.x,
                    length: size.z,
                    height: size.y
            }

            ;

            modelPreview.model.position.sub(box.getCenter(new THREE.Vector3()));
            modelPreview.scene.add(modelPreview.model);

            animateModelPreview();
        }

        catch (error) {
            console.error("Error cargando modelo para vista previa:", error);
            showMessage("Error al cargar el modelo 3D para vista previa.");
        }
        }

        function animateModelPreview() {
            modelPreview.animationFrameId=requestAnimationFrame(animateModelPreview);

            if (modelPreview.model) {
                const scale=(appState.mapScale * 0.5) / modelPreview.maxSize;
                modelPreview.model.scale.set(scale, scale, scale);
            }

            if (modelPreview.renderer && modelPreview.scene && modelPreview.camera) {
                modelPreview.renderer.clearDepth();
                modelPreview.renderer.render(modelPreview.scene, modelPreview.camera);
            }
        }

        function jumpToCoords() {
            const lat=parseFloat(document.getElementById('jumpto-lat').value);
            const lon=parseFloat(document.getElementById('jumpto-lon').value);
            if (isNaN(lat) || isNaN(lon) || !map) return;
            map.setView([lat, lon], map.getZoom());
        }

        function onWindowResize() {
            if (pages.map.classList.contains('active') && modelPreview.renderer) {
                const container=document.getElementById('map-container');
                if ( !container) return;
                const width=container.clientWidth;
                const height=container.clientHeight;

                modelPreview.camera.aspect=width / height;
                modelPreview.camera.updateProjectionMatrix();
                modelPreview.renderer.setSize(width, height);
            }

            if (pages.map.classList.contains('active') && map) {
                setTimeout(()=> {
                        map.invalidateSize();
                    }

                    , 100);
            }
        }

        function loadScaleSettings() {
            document.getElementById('real-width-input').value=appState.realDimensions.width;
            document.getElementById('real-length-input').value=appState.realDimensions.length;
            document.getElementById('real-height-input').value=appState.realDimensions.height;
            document.getElementById('ground-height-input').value=appState.realDimensions.groundHeight;

            document.getElementById('initial-ar-scale-slider').value=appState.initialARScale;
            document.getElementById('initial-scale-value').textContent=appState.initialARScale.toFixed(1)+'x';

            document.getElementById('ar-distance-slider').value=appState.arDistance;
            document.getElementById('distance-value').textContent=appState.arDistance.toFixed(0)+'m';
        }

        function saveScaleSettings() {
            appState.realDimensions.width=parseFloat(document.getElementById('real-width-input').value) || 10.0;
            appState.realDimensions.length=parseFloat(document.getElementById('real-length-input').value) || 15.0;
            appState.realDimensions.height=parseFloat(document.getElementById('real-height-input').value) || 3.0;
            appState.realDimensions.groundHeight=parseFloat(document.getElementById('ground-height-input').value) || 0.0;

            appState.initialARScale=parseFloat(document.getElementById('initial-ar-scale-slider').value);
            appState.arDistance=parseFloat(document.getElementById('ar-distance-slider').value);

            showMessage('Configuración de escala guardada', 2000);
        }

        // --- Event Listeners ---
        window.addEventListener('resize', onWindowResize, false);
        document.getElementById('load-data-btn').addEventListener('click', saveDataToCache);
        document.getElementById('clear-cache-btn').addEventListener('click', clearCacheAndReload);
        document.getElementById('goto-map-btn').addEventListener('click', ()=> navigateTo('map'));
        document.getElementById('use-location-btn').addEventListener('click', useCurrentLocation);
        document.getElementById('back-to-setup-from-map-btn').addEventListener('click', ()=> navigateTo('upload'));
        document.getElementById('goto-scale-btn').addEventListener('click', ()=> navigateTo('scale'));
        document.getElementById('back-to-map-from-scale-btn').addEventListener('click', ()=> navigateTo('map'));

        document.getElementById('goto-ar-from-scale-btn').addEventListener('click', ()=> {
                saveScaleSettings();
                startARFlow();
            });
        document.getElementById('back-to-scale-btn').addEventListener('click', stopAR);

        document.getElementById('map-scale-slider').addEventListener('input', (e)=> {
                appState.mapScale=parseFloat(e.target.value);
            });

        document.getElementById('map-zoom-slider').addEventListener('input', (e)=> {
                if (map) map.setZoom(parseFloat(e.target.value));
            });
        document.getElementById('jumpto-btn').addEventListener('click', jumpToCoords);

        document.getElementById('apply-coords-btn').addEventListener('click', applyCoordsToAR);

        document.getElementById('initial-ar-scale-slider').addEventListener('input', (e)=> {
                const scaleValue=parseFloat(e.target.value);
                document.getElementById('initial-scale-value').textContent=scaleValue.toFixed(1) + 'x';
            });

        $ {
            baseScale[2] * dynamicScale
        }

        `);
        }
        });

        document.getElementById('reset-position-btn').addEventListener('click', ()=> {
                if (arCamera && arCamera.components['gps-camera']) {
                    arCamera.components['gps-camera'].resetPosition();
                    showMessage('Posición reiniciada', 2000);
                }
            });

        toggleExplorationBtn.addEventListener('click', ()=> {
                appState.explorationMode= !appState.explorationMode;

                if (appState.explorationMode) {
                    explorationMode.classList.add('active');
                    toggleExplorationBtn.textContent='Desactivar Exploración';
                    showMessage('Modo de exploración activado. Ahora puedes interactuar con el modelo.', 3000);

                    if (arModel && arModel.object3D) {
                        const currentScale=arModel.getAttribute('scale');
                        const scaleValues=currentScale.split(' ').map(parseFloat);

                        arModel.setAttribute('scale', `$ {
                                scaleValues[0] * 2
                            }

                            $ {
                                scaleValues[1] * 2
                            }

                            $ {
                                scaleValues[2] * 2
                            }

                            `);
                    }
                }

                else {
                    explorationMode.classList.remove('active');
                    toggleExplorationBtn.textContent='Activar Exploración';
                    showMessage('Modo de exploración desactivado.', 3000);

                    if (arModel && arModel.object3D) {
                        const currentScale=arModel.getAttribute('scale');
                        const scaleValues=currentScale.split(' ').map(parseFloat);

                        arModel.setAttribute('scale', `$ {
                                scaleValues[0] / 2
                            }

                            $ {
                                scaleValues[1] / 2
                            }

                            $ {
                                scaleValues[2] / 2
                            }

                            `);
                    }
                }
            });

        const mapContainer=document.getElementById('map-container');
        let longPressTimeout=null;

        const getAngle=(t1, t2)=>Math.atan2(t2.clientY - t1.clientY, t2.clientX - t1.clientX);

        mapContainer.addEventListener('contextmenu', e=> e.preventDefault());

        mapContainer.addEventListener('mousedown', (e)=> {
                if (e.button===2) {
                    modelPreview.isRotating=true;
                    if (map) map.dragging.disable();

                    modelPreview.previousMousePosition= {
                        x: e.clientX, y: e.clientY
                    }

                    ;
                }
            });

        window.addEventListener('mousemove', (e)=> {
                if (modelPreview.isRotating && e.buttons===2 && modelPreview.model) {
                    const deltaX=e.clientX - modelPreview.previousMousePosition.x;
                    const deltaY=e.clientY - modelPreview.previousMousePosition.y;
                    modelPreview.model.rotation.y +=deltaX * 0.01;
                    modelPreview.model.rotation.x +=deltaY * 0.01;

                    modelPreview.previousMousePosition= {
                        x: e.clientX, y: e.clientY
                    }

                    ;
                }
            });

        window.addEventListener('mouseup', (e)=> {
                if (e.button===2 && modelPreview.isRotating) {
                    modelPreview.isRotating=false;
                    if (map) map.dragging.enable();
                }
            });

        mapContainer.addEventListener('touchstart', (e)=> {
                clearTimeout(longPressTimeout);

                if (e.touches.length===1) {
                    modelPreview.previousMousePosition= {
                        x: e.touches[0].clientX, y: e.touches[0].clientY
                    }

                    ;

                    longPressTimeout=setTimeout(()=> {
                            modelPreview.isRotating=true;
                            if (map) map.dragging.disable();
                            showMessage('Modo Inclinación Activado', 2000);
                        }

                        , 1000);
                }

                else if (e.touches.length===2) {
                    modelPreview.isTwoFingerRotating=true;
                    if (map) map.dragging.disable();
                    modelPreview.previousTouchAngle=getAngle(e.touches[0], e.touches[1]);
                }
            }

            , {
            passive: false
        });

        mapContainer.addEventListener('touchmove', (e)=> {
                if (modelPreview.isRotating && e.touches.length===1) {
                    e.preventDefault();
                    const deltaX=e.touches[0].clientX - modelPreview.previousMousePosition.x;
                    const deltaY=e.touches[0].clientY - modelPreview.previousMousePosition.y;

                    if (modelPreview.model) {
                        modelPreview.model.rotation.y +=deltaX * 0.02;
                        modelPreview.model.rotation.x +=deltaY * 0.02;
                    }

                    modelPreview.previousMousePosition= {
                        x: e.touches[0].clientX, y: e.touches[0].clientY
                    }

                    ;
                }

                else if (modelPreview.isTwoFingerRotating && e.touches.length===2) {
                    e.preventDefault();
                    const currentAngle=getAngle(e.touches[0], e.touches[1]);
                    const deltaAngle=currentAngle - modelPreview.previousTouchAngle;

                    if (modelPreview.model) {
                        modelPreview.model.rotation.z +=deltaAngle;
                    }

                    modelPreview.previousTouchAngle=currentAngle;
                }
            });

        mapContainer.addEventListener('touchend', (e)=> {
                clearTimeout(longPressTimeout);

                if (modelPreview.isRotating || modelPreview.isTwoFingerRotating) {
                    modelPreview.isRotating=false;
                    modelPreview.isTwoFingerRotating=false;
                    if (map) map.dragging.enable();
                }
            });

        document.addEventListener('DOMContentLoaded', ()=> {
                window.addEventListener('model-error', (event)=> {
                        console.error('Error al cargar el modelo:', event.detail);
                        showMessage('Error al cargar el modelo 3D. Verifica que el archivo sea válido.', 5000);
                    });
            });

        async function checkPermissions() {
            const modal=document.querySelector('.permission-modal');
            if ( !modal) return true;

            // Verificar si ya tenemos permisos
            try {
                const stream=await navigator.mediaDevices.getUserMedia({
                    video: true
                });
            stream.getTracks().forEach(track=> track.stop());
        }

        catch (e) {
            // No tenemos permiso de cámara
        }

        return new Promise((resolve)=> {

                // Si no hay modal en el DOM, resolver true
                if ( !modal) {
                    resolve(true); return;
                }

                modal.style.display='flex';
                const btn=document.getElementById('request-permission-btn');

                if ( !btn) {
                    modal.style.display='none';
                    resolve(true);
                    return;
                }

                const cameraStatus=document.getElementById('camera-status');
                const gpsStatus=document.getElementById('gps-status-icon');

                if (cameraStatus) cameraStatus.textContent='...';
                if (gpsStatus) gpsStatus.textContent='...';

                btn.onclick=async ()=> {
                    try {
                        await navigator.mediaDevices.getUserMedia({
                            video: true
                        });

                    if (cameraStatus) {
                        cameraStatus.textContent='✅';
                        cameraStatus.style.color='#10b981';
                    }
                }

                catch (e) {
                    if (cameraStatus) {
                        cameraStatus.textContent='❌';
                        cameraStatus.style.color='#ef4444';
                    }

                    showMessage('Se requiere acceso a la cámara para AR.', 3000);
                    return;
                }

                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(()=> {
                            if (gpsStatus) {
                                gpsStatus.textContent='✅';
                                gpsStatus.style.color='#10b981';
                            }

                            modal.style.display='none';
                            resolve(true);
                        }

                        , (err)=> {
                            if (gpsStatus) {
                                gpsStatus.textContent='❌';
                                gpsStatus.style.color='#ef4444';
                            }

                            showMessage('Se requiere acceso a GPS para AR.', 3000);
                        }

                        , {
                        enableHighAccuracy: true
                    });
            }

            else {
                resolve(true);
            }
        }

        ;
        });
        }

        async function startARFlow() {

            // Load AR libraries if not loaded
            if ( !arLibrariesLoaded) {
                showMessage('Cargando librerías AR...', 2000);
                await loadARLibraries();
            }

            navigateTo('ar');

            // Initialize AR Scene
            initializeARScene();
        }

        function initializeApp() {
            if (document.getElementById('version-display')) {
                document.getElementById('version-display').textContent=`v$ {
                    APP_VERSION
                }

                `;
            }

            appState.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);

            if (appState.isIOS) {
                showDebugInfo('Dispositivo iOS detectado');
            }

            // Register Service Worker (Inline Blob approach for single-file requirement)
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', ()=> {
                        const swCode=` const CACHE_NAME='geo-ar-v1-6-final';
                        const ASSETS_TO_CACHE=[ './',
                        './index.html',
                        'https://cdn.tailwindcss.com',
                        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
                        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
                        'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js',
                        'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js',
                        'https://github.com/instructorandradedcc/55ar/raw/main/favicon3dAR.png'
                        ];

                        self.addEventListener('install', (event)=> {
                                event.waitUntil(caches.open(CACHE_NAME).then((cache)=> {
                                            return cache.addAll(ASSETS_TO_CACHE);
                                        }));
                            });

                        self.addEventListener('fetch', (event)=> {
                                event.respondWith (caches.match(event.request).then((response)=> {
                                            return response || fetch(event.request).then((response)=> {
                                                    if( !response || response.status !==200 || response.type !=='basic') {
                                                        return response;
                                                    }

                                                    const responseToCache=response.clone();

                                                    caches.open(CACHE_NAME).then((cache)=> {
                                                            cache.put(event.request, responseToCache);
                                                        });
                                                    return response;
                                                });
                                        }));
                            });

                        self.addEventListener('activate', (event)=> {
                                const cacheWhitelist=[CACHE_NAME];

                                event.waitUntil(caches.keys().then((cacheNames)=> {
                                            return Promise.all(cacheNames.map((cacheName)=> {
                                                        if (cacheWhitelist.indexOf(cacheName)===-1) {
                                                            return caches.delete(cacheName);
                                                        }
                                                    }));
                                        }));
                            });
                        `;

                        const blob=new Blob([swCode], {
                            type: 'application/javascript'
                        });
                    const swUrl=URL.createObjectURL(blob);

                    navigator.serviceWorker.register(swUrl) .then(registration=> {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);

                        }) .catch(err=> {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
        }

        loadDataFromCache().then(successfullyLoaded=> {
                if (successfullyLoaded) {
                    console.log("Aplicación iniciada con datos desde la caché.");
                }

                else {
                    if (document.getElementById('goto-map-btn')) {
                        document.getElementById('goto-map-btn').disabled=true;
                    }

                    console.log("Aplicación iniciada sin datos en caché.");
                }
            });
        }

        initializeApp();
        </script></body></html>

