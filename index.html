<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Visor AR Arquitectura por Geolocalizaci√≥n</title>
    <link rel="icon" type="image/png" href="https://github.com/instructorandradedcc/55ar/raw/main/favicon3dAR.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- Import Map para Three.js (Usado para la previsualizaci√≥n) -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
            }
        }
    </script>

    <style>
        /* Estilos Generales */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Inter', sans-serif;
            background-color: #000; /* Fondo negro por defecto */
        }

        /* Sistema de P√°ginas */
        .page { display: none; height: 100%; width: 100%; position: relative; background: white; }
        .page.active { display: flex; flex-direction: column; }

        /* Utilidades */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Botones */
        .control-button {
            background-color: #4CAF50; color: white; padding: 10px 20px;
            border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
            transition: background-color 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .control-button:hover { background-color: #45a049; }
        .control-button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Mensajes Flotantes */
        #message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8); color: white; padding: 12px 24px;
            border-radius: 8px; font-size: 1rem; z-index: 10001;
            opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none;
            text-align: center; width: 90%; max-width: 400px;
        }
        #message-box.show { opacity: 1; }

        /* Mapas y Previsualizaci√≥n */
        #map-container { position: relative; flex: 1; width: 100%; z-index: 1; }
        #map-canvas { width: 100%; height: 100%; z-index: 1; }
        #model-preview-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 401; display: none;
        }

        /* UI del Mapa */
        .map-ui-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 402; background-color: rgba(255, 255, 255, 0.95);
            padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 90%; max-width: 350px; display: flex; flex-direction: column; gap: 10px;
        }

        /* Elementos AR (A-Frame) */
        a-scene {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important; z-index: 1 !important;
            background: transparent !important;
        }
        
        /* Video de C√°mara (Estilos agresivos para forzar visibilidad) */
        video, .arjs-video {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important;
            object-fit: cover !important; z-index: -2 !important;
            display: block !important; opacity: 1 !important; visibility: visible !important;
            background-color: transparent !important;
        }

        /* Pantalla de Carga AR */
        .ar-loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #2a5298); color: white;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10002;
        }
        .ar-loading-screen.active { display: flex; }

        /* Indicadores AR (HUD) */
        .ar-hud { position: fixed; z-index: 9998; pointer-events: none; }
        
        .location-indicator {
            background-color: rgba(0, 0, 0, 0.7); color: white; padding: 6px 10px;
            border-radius: 20px; font-size: 10px; display: flex; align-items: center; gap: 5px;
        }
        .loc-dot { width: 8px; height: 8px; border-radius: 50%; }
        
        .distance-panel {
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            border: 2px solid #4CAF50; padding: 10px 20px; border-radius: 30px;
            background: rgba(0,0,0,0.6); color: #fff; font-weight: bold; font-size: 1.2rem;
        }

        /* Bot√≥n iOS Start */
        .ios-start-button {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10005; display: none;
        }
        .ios-start-button.show { display: block; }

        /* Debug Info */
        .ar-debug-info {
            position: fixed; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7);
            color: #0f0; font-family: monospace; font-size: 9px; padding: 5px;
            pointer-events: none; z-index: 10003; max-width: 150px;
        }
    </style>
</head>
<body>

    <!-- Debug Overlay -->
    <div id="ar-debug-info" class="ar-debug-info">Debug v0.06</div>

    <!-- Mensajes Globales -->
    <div id="message-box"></div>

    <!-- Modal de Permisos -->
    <div id="permission-modal" class="permission-modal fixed inset-0 bg-black bg-opacity-90 z-[10001] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-sm text-center mx-4">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Permisos Requeridos</h3>
            <p class="text-gray-600 mb-6">Esta aplicaci√≥n necesita acceso a tu C√°mara (para AR) y GPS (para ubicaci√≥n).</p>
            <div class="flex justify-around mb-6">
                <div class="flex flex-col items-center">
                    <span class="text-3xl mb-2">üì∑</span>
                    <span id="camera-status" class="text-sm font-bold text-gray-400">...</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-3xl mb-2">üìç</span>
                    <span id="gps-status-icon" class="text-sm font-bold text-gray-400">...</span>
                </div>
            </div>
            <button id="request-permission-btn" class="control-button w-full">Permitir Acceso</button>
        </div>
    </div>

    <!-- PAGINA 1: CARGA DE DATOS -->
    <div id="page-upload" class="page active p-5 items-center justify-center bg-gray-100">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">AR Constructor Pro</h1>
                <p class="text-sm text-gray-500" id="version-display">Cargando...</p>
            </div>

            <!-- Secci√≥n de Estado (Si hay cach√©) -->
            <div id="status-section" class="hidden mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-blue-800 font-semibold text-center">‚úÖ Datos recuperados</p>
                <button id="clear-cache-btn" class="text-xs text-red-500 underline w-full mt-2">Borrar datos y reiniciar</button>
            </div>

            <!-- Secci√≥n de Formulario -->
            <div id="upload-section" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">1. Modelo 3D (.glb)</label>
                    <input type="file" id="model-upload" accept=".glb" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Latitud</label>
                        <input type="number" id="latitude-input" step="0.000001" placeholder="-34.000000" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Longitud</label>
                        <input type="number" id="longitude-input" step="0.000001" placeholder="-64.000000" class="w-full p-2 border rounded">
                    </div>
                </div>
                
                <button id="use-location-btn" class="w-full py-2 text-blue-600 border border-blue-600 rounded hover:bg-blue-50 text-sm">
                    üìç Usar mi ubicaci√≥n actual
                </button>

                <button id="load-data-btn" class="control-button w-full mt-4">
                    Guardar y Continuar
                </button>
            </div>

            <button id="goto-map-btn" class="control-button w-full mt-4 bg-blue-600 hover:bg-blue-700 hidden">
                Ir al Mapa
            </button>
        </div>
    </div>

    <!-- PAGINA 2: MAPA -->
    <div id="page-map" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <canvas id="model-preview-canvas"></canvas>
        </div>

        <!-- Controles Flotantes Mapa -->
        <div class="absolute top-4 right-4 z-[402] flex flex-col gap-2">
             <button id="back-to-setup-from-map-btn" class="bg-white p-2 rounded shadow text-black">‚öôÔ∏è</button>
        </div>

        <!-- Panel Inferior Mapa -->
        <div class="map-ui-container">
            <h3 class="font-bold text-center text-gray-800">Ajuste de Ubicaci√≥n</h3>
            <p class="text-xs text-gray-500 text-center mb-2">Arrastra el marcador para mover el modelo</p>
            
            <div class="flex gap-2 mb-2">
                <input type="number" id="jumpto-lat" class="w-1/2 p-1 border rounded text-xs" placeholder="Lat">
                <input type="number" id="jumpto-lon" class="w-1/2 p-1 border rounded text-xs" placeholder="Lon">
                <button id="jumpto-btn" class="bg-gray-200 px-2 rounded">Ir</button>
            </div>
            
            <button id="apply-coords-btn" class="control-button w-full bg-orange-500 hover:bg-orange-600">
                Fijar Ubicaci√≥n Aqu√≠
            </button>
            
            <button id="goto-scale-btn" class="control-button w-full">
                Siguiente: Escala
            </button>
        </div>
    </div>

    <!-- PAGINA 3: ESCALA -->
    <div id="page-scale" class="page items-center justify-center p-5 bg-gray-100">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">Configuraci√≥n AR</h2>

            <!-- Dimensiones Reales -->
            <div class="mb-6 border-b pb-4">
                <h3 class="font-semibold text-gray-700 mb-2">Dimensiones Reales (Metros)</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs">Ancho (X)</label>
                        <input type="number" id="real-width-input" value="10" class="w-full border p-1 rounded">
                    </div>
                    <div>
                        <label class="text-xs">Largo (Z)</label>
                        <input type="number" id="real-length-input" value="15" class="w-full border p-1 rounded">
                    </div>
                    <div>
                        <label class="text-xs">Alto (Y)</label>
                        <input type="number" id="real-height-input" value="3" class="w-full border p-1 rounded">
                    </div>
                    <div>
                        <label class="text-xs">Elevaci√≥n Suelo</label>
                        <input type="number" id="ground-height-input" value="0" class="w-full border p-1 rounded">
                    </div>
                </div>
            </div>

            <!-- Escala AR -->
            <div class="mb-6">
                <h3 class="font-semibold text-gray-700 mb-2">Factor de Escala Inicial</h3>
                <div class="flex items-center gap-2">
                    <input type="range" id="initial-ar-scale-slider" min="0.1" max="5" step="0.1" value="1" class="flex-1">
                    <span id="initial-scale-value" class="text-sm font-mono">1.0x</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Ajusta si el modelo se ve muy grande/peque√±o.</p>
            </div>

            <!-- Distancia de Activaci√≥n -->
            <div class="mb-6 hidden">
                <h3 class="font-semibold text-gray-700 mb-2">Distancia (Simulaci√≥n)</h3>
                <input type="range" id="ar-distance-slider" min="0" max="100" value="0" class="w-full">
                <span id="distance-value" class="text-xs">0m</span>
            </div>

            <div class="flex flex-col gap-3 mt-4">
                <button id="goto-ar-from-scale-btn" class="control-button w-full text-lg py-3">
                    üöÄ INICIAR AR
                </button>
                <button id="back-to-map-from-scale-btn" class="text-gray-500 underline text-center py-2">
                    Volver al Mapa
                </button>
            </div>
        </div>
    </div>

    <!-- PAGINA 4: ESCENA AR -->
    <div id="page-ar" class="page bg-black">
        <!-- Contenedor donde A-Frame inyectar√° la escena -->
        <div id="ar-scene-container" class="absolute inset-0 z-0"></div>

        <!-- Loading Overlay AR -->
        <div id="ar-loading-screen" class="ar-loading-screen">
            <div class="loader"></div>
            <h2 class="text-xl font-bold">Iniciando AR...</h2>
            <p class="text-sm mt-2 opacity-80">Calibrando sensores y GPS</p>
        </div>

        <!-- Bot√≥n Inicio iOS -->
        <button id="ios-start-button" class="control-button ios-start-button shadow-2xl border-2 border-white">
            Click para Iniciar C√°mara
        </button>

        <!-- UI Overlay AR -->
        <div class="ar-hud location-indicator" style="bottom: 100px; left: 20px;" id="current-location-indicator">
            <div class="loc-dot bg-green-500"></div>
            <span class="font-mono">GPS: Buscando...</span>
        </div>

        <div class="ar-hud location-indicator" style="bottom: 100px; right: 20px;" id="model-location-indicator">
            <div class="loc-dot bg-orange-500"></div>
            <span class="font-mono">Modelo: ...</span>
        </div>

        <div class="ar-hud distance-panel" id="distance-panel" style="display:none;">
            <span id="ar-distance-value">0m</span>
        </div>

        <div class="ar-hud absolute top-4 left-4 bg-black/50 p-2 rounded text-white text-xs">
            <p>Precisi√≥n GPS: <span id="gps-accuracy" class="font-bold">--</span>m</p>
        </div>

        <!-- Controles AR Inferiores -->
        <div class="ar-hud absolute bottom-6 left-1/2 transform -translate-x-1/2 flex gap-4 pointer-events-auto">
            <button id="toggle-exploration-btn" class="bg-blue-600 text-white px-4 py-2 rounded-full shadow">
                Explorar
            </button>
            <button id="back-to-scale-btn" class="bg-red-600 text-white px-4 py-2 rounded-full shadow">
                Salir
            </button>
        </div>
        
        <!-- Elemento de l√≠nea visual -->
        <div id="connection-line" class="connection-line" style="display:none;"></div>
    </div>

    <!-- LOGICA JAVASCRIPT -->
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- Variables Globales y Estado ---
        const APP_VERSION = '0.07-Fix';
        const CACHE_NAME = 'geo-ar-v1-7';
        
        // Estado de la Aplicaci√≥n
        const appState = {
            coords: { latitude: 0, longitude: 0 }, // Coordenadas iniciales/mapa
            arTargetCoords: null,                  // Coordenadas donde se renderiza el modelo
            currentGPSLocation: null,              // Ubicaci√≥n real del usuario
            modelURL: null,
            realDimensions: { width: 10, length: 15, height: 3, groundHeight: 0 },
            initialARScale: 1.0,
            arDistance: 0,
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,
            videoStarted: false,
            explorationMode: false,
            mapScale: 1.0
        };

        // Referencias DOM
        const pages = {
            upload: document.getElementById('page-upload'),
            map: document.getElementById('page-map'),
            scale: document.getElementById('page-scale'),
            ar: document.getElementById('page-ar')
        };

        // Variables Runtime
        let map = null;
        let modelPreview = { scene: null, camera: null, renderer: null, model: null };
        let arLibrariesLoaded = false;
        let gpsWatchId = null;
        let arScene = null;
        
        // --- Funciones de Utilidad ---
        function showMessage(msg, duration = 3000) {
            const box = document.getElementById('message-box');
            box.textContent = msg;
            box.classList.add('show');
            setTimeout(() => box.classList.remove('show'), duration);
        }

        function showDebugInfo(msg) {
            const debug = document.getElementById('ar-debug-info');
            const time = new Date().toLocaleTimeString();
            debug.textContent = `[${time}] ${msg}`;
            console.log(`[DEBUG] ${msg}`);
        }

        function navigateTo(pageName) {
            Object.values(pages).forEach(p => p.classList.remove('active'));
            if (pages[pageName]) {
                pages[pageName].classList.add('active');
                if (pageName === 'map') setTimeout(onWindowResize, 100); // Fix Leaflet size
            }
        }

        // --- Carga Din√°mica de Librer√≠as AR ---
        function loadARLibraries() {
            if (arLibrariesLoaded) return Promise.resolve();
            return new Promise((resolve) => {
                // 1. Cargar A-Frame 1.3.0 (Mejor compatibilidad con AR.js viejo)
                const aframeScript = document.createElement('script');
                aframeScript.src = 'https://aframe.io/releases/1.3.0/aframe.min.js';
                document.head.appendChild(aframeScript);

                aframeScript.onload = () => {
                    // 2. Cargar AR.js
                    const arjsScript = document.createElement('script');
                    arjsScript.src = 'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js';
                    document.head.appendChild(arjsScript);

                    // 3. Cargar A-Frame Extras (Animaci√≥n, etc)
                    const extrasScript = document.createElement('script');
                    extrasScript.src = 'https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js';
                    document.head.appendChild(extrasScript);

                    extrasScript.onload = () => {
                        console.log('Librer√≠as AR Cargadas');
                        arLibrariesLoaded = true;
                        resolve();
                    };
                };
            });
        }

        // --- L√≥gica Principal AR ---
        async function startARFlow() {
            // Verificar permisos antes de cargar nada pesado
            const hasPermissions = await checkPermissions();
            if (!hasPermissions) {
                showMessage('No se otorgaron permisos. AR no funcionar√°.');
                return;
            }

            navigateTo('ar');
            document.getElementById('ar-loading-screen').classList.add('active');

            if (!arLibrariesLoaded) {
                await loadARLibraries();
            }

            initializeARScene();
        }

        function initializeARScene() {
            const container = document.getElementById('ar-scene-container');
            container.innerHTML = ''; // Limpiar anterior

            // Usar coordenadas objetivo o fallback a las iniciales
            const target = appState.arTargetCoords || appState.coords;
            
            // Construcci√≥n del HTML de A-Frame
            // Nota: gps-camera="minDistance: 5" ayuda a reducir el jitter
            const sceneHTML = `
                <a-scene
                    embedded
                    vr-mode-ui="enabled: false"
                    renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true; precision: high;"
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; displayWidth: 1280; displayHeight: 720;"
                    id="main-ar-scene">
                    
                    <a-camera 
                        gps-camera="minDistance: 5; gpsMinDistance: 5;" 
                        rotation-reader 
                        far="10000"
                        id="ar-camera">
                    </a-camera>

                    <a-entity
                        id="ar-model-entity"
                        gltf-model="${appState.modelURL}"
                        gps-entity-place="latitude: ${target.latitude}; longitude: ${target.longitude};"
                        position="0 ${appState.realDimensions.groundHeight} 0"
                        scale="${appState.initialARScale} ${appState.initialARScale} ${appState.initialARScale}"
                        animation-mixer>
                    </a-entity>

                    <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
                    <a-light type="directional" color="#ffffff" intensity="1" position="-1 1 0"></a-light>
                </a-scene>
            `;

            container.innerHTML = sceneHTML;
            arScene = document.getElementById('main-ar-scene');

            // Listeners de A-Frame
            arScene.addEventListener('loaded', () => {
                showDebugInfo('Escena AR Cargada');
                document.getElementById('ar-loading-screen').classList.remove('active');
                
                // Hack para iOS video
                setTimeout(forceVideoVisibility, 1000);
                
                // Iniciar GPS Watch
                startGPSWatch();
            });

            // Manejo de errores de carga del modelo
            const modelEntity = document.getElementById('ar-model-entity');
            modelEntity.addEventListener('model-error', (e) => {
                showDebugInfo('Error cargando modelo GLB');
                showMessage('Error: El modelo no pudo cargarse.');
            });
            modelEntity.addEventListener('model-loaded', () => {
                showDebugInfo('Modelo 3D renderizado');
            });
        }

        // Hack Cr√≠tico para iOS: Asegura que el video se vea detr√°s del canvas
        function forceVideoVisibility() {
            const video = document.querySelector('video');
            if (video) {
                video.style.position = 'fixed';
                video.style.top = '0';
                video.style.zIndex = '-2';
                video.style.display = 'block';
                video.play().catch(e => {
                    console.log("Autoplay prevenido, mostrando bot√≥n manual");
                    document.getElementById('ios-start-button').classList.add('show');
                });
                appState.videoStarted = true;
            } else {
                setTimeout(forceVideoVisibility, 500);
            }
        }

        // --- GPS Logic ---
        function startGPSWatch() {
            if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);

            gpsWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    appState.currentGPSLocation = {
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        accuracy: pos.coords.accuracy
                    };
                    
                    // Actualizar UI
                    document.getElementById('gps-accuracy').textContent = pos.coords.accuracy.toFixed(1);
                    updateHUD();
                },
                (err) => {
                    showDebugInfo(`GPS Error: ${err.message}`);
                },
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        }

        function updateHUD() {
            if (!appState.currentGPSLocation || !appState.arTargetCoords) return;

            // Distancia
            const dist = calculateDistance(
                appState.currentGPSLocation.latitude, appState.currentGPSLocation.longitude,
                appState.arTargetCoords.latitude, appState.arTargetCoords.longitude
            );

            const distPanel = document.getElementById('distance-panel');
            const distValue = document.getElementById('ar-distance-value');
            
            distPanel.style.display = 'flex';
            distValue.textContent = `${dist.toFixed(1)}m`;

            // Texto indicadores
            document.querySelector('#current-location-indicator span').textContent = 
                `GPS: ${appState.currentGPSLocation.latitude.toFixed(5)}, ${appState.currentGPSLocation.longitude.toFixed(5)}`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio Tierra metros
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // --- Mapa (Leaflet) ---
        function initMap() {
            const container = document.getElementById('map-canvas');
            if(!appState.coords.latitude) return;

            if (map) map.remove();
            map = L.map(container).setView([appState.coords.latitude, appState.coords.longitude], 18);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'OSM', maxZoom: 19
            }).addTo(map);

            const marker = L.marker([appState.coords.latitude, appState.coords.longitude], {
                draggable: true, autoPan: true
            }).addTo(map).bindPopup("Ubicaci√≥n del Modelo").openPopup();

            marker.on('dragend', (e) => {
                const ll = e.target.getLatLng();
                appState.arTargetCoords = { latitude: ll.lat, longitude: ll.lng };
                document.getElementById('jumpto-lat').value = ll.lat.toFixed(6);
                document.getElementById('jumpto-lon').value = ll.lng.toFixed(6);
            });
            
            // Inicializar target coords si no existen
            if(!appState.arTargetCoords) {
                appState.arTargetCoords = appState.coords;
            }

            // Previsualizaci√≥n 3D sobre el mapa (Three.js b√°sico)
            initModelPreview();
        }

        // --- Three.js Preview ---
        async function initModelPreview() {
            if (!appState.modelURL) return;
            
            const canvas = document.getElementById('model-preview-canvas');
            canvas.style.display = 'block';
            const container = document.getElementById('map-container');

            if(!modelPreview.renderer) {
                modelPreview.renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
                modelPreview.renderer.setSize(container.clientWidth, container.clientHeight);
                modelPreview.renderer.setClearColor(0x000000, 0);
                
                modelPreview.scene = new THREE.Scene();
                modelPreview.camera = new THREE.PerspectiveCamera(75, container.clientWidth/container.clientHeight, 0.1, 1000);
                modelPreview.camera.position.set(0, 5, 10);
                
                const light = new THREE.DirectionalLight(0xffffff, 2);
                light.position.set(1, 1, 1);
                modelPreview.scene.add(light);
                modelPreview.scene.add(new THREE.AmbientLight(0xffffff, 1));
            }

            // Cargar Modelo
            const loader = new GLTFLoader();
            try {
                const gltf = await loader.loadAsync(appState.modelURL);
                if(modelPreview.model) modelPreview.scene.remove(modelPreview.model);
                
                modelPreview.model = gltf.scene;
                // Centrar modelo
                const box = new THREE.Box3().setFromObject(modelPreview.model);
                const center = box.getCenter(new THREE.Vector3());
                modelPreview.model.position.sub(center);
                
                modelPreview.scene.add(modelPreview.model);
                animatePreview();
            } catch (e) {
                console.error("Error preview", e);
            }
        }

        function animatePreview() {
            requestAnimationFrame(animatePreview);
            if(modelPreview.model) modelPreview.model.rotation.y += 0.01;
            if(modelPreview.renderer) modelPreview.renderer.render(modelPreview.scene, modelPreview.camera);
        }

        function onWindowResize() {
            if(map) map.invalidateSize();
            if(modelPreview.renderer) {
                const container = document.getElementById('map-container');
                modelPreview.camera.aspect = container.clientWidth / container.clientHeight;
                modelPreview.camera.updateProjectionMatrix();
                modelPreview.renderer.setSize(container.clientWidth, container.clientHeight);
            }
        }

        // --- Cache & Data ---
        async function saveDataToCache() {
            const fileInput = document.getElementById('model-upload');
            const lat = parseFloat(document.getElementById('latitude-input').value);
            const lon = parseFloat(document.getElementById('longitude-input').value);

            if (!fileInput.files[0]) return showMessage("Selecciona un archivo .glb");
            if (isNaN(lat) || isNaN(lon)) return showMessage("Coordenadas inv√°lidas");

            appState.coords = { latitude: lat, longitude: lon };
            appState.modelURL = URL.createObjectURL(fileInput.files[0]);

            navigateTo('map');
            initMap();
        }

        // --- Permisos ---
        function checkPermissions() {
            return new Promise((resolve) => {
                const modal = document.getElementById('permission-modal');
                const btn = document.getElementById('request-permission-btn');
                
                // Verificar si ya tenemos acceso
                navigator.mediaDevices.getUserMedia({video: true})
                .then(stream => {
                    stream.getTracks().forEach(t => t.stop()); // Cerrar stream de prueba
                    resolve(true); // Ya tiene permisos
                })
                .catch(() => {
                    // No tiene permisos, mostrar modal
                    modal.classList.remove('hidden');
                    btn.onclick = async () => {
                        try {
                            // Pedir c√°mara
                            const stream = await navigator.mediaDevices.getUserMedia({video: true});
                            document.getElementById('camera-status').textContent = "‚úÖ";
                            stream.getTracks().forEach(t => t.stop());

                            // Pedir GPS
                            navigator.geolocation.getCurrentPosition(
                                () => {
                                    document.getElementById('gps-status-icon').textContent = "‚úÖ";
                                    setTimeout(() => {
                                        modal.classList.add('hidden');
                                        resolve(true);
                                    }, 500);
                                },
                                (err) => {
                                    showMessage("GPS requerido: " + err.message);
                                    resolve(false);
                                },
                                { enableHighAccuracy: true }
                            );
                        } catch (err) {
                            showMessage("C√°mara denegada: " + err.message);
                            resolve(false);
                        }
                    };
                });
            });
        }

        function useCurrentLocation() {
            showMessage("Obteniendo GPS...");
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('latitude-input').value = pos.coords.latitude.toFixed(6);
                document.getElementById('longitude-input').value = pos.coords.longitude.toFixed(6);
                showMessage("Ubicaci√≥n actualizada");
            }, err => {
                showMessage("Error GPS: " + err.message);
            });
        }

        // --- Inicializaci√≥n y Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('version-display').textContent = `v${APP_VERSION}`;
            
            // Listeners Botones
            document.getElementById('load-data-btn').addEventListener('click', saveDataToCache);
            document.getElementById('use-location-btn').addEventListener('click', useCurrentLocation);
            
            document.getElementById('goto-scale-btn').addEventListener('click', () => {
                navigateTo('scale');
            });
            
            document.getElementById('goto-ar-from-scale-btn').addEventListener('click', () => {
                // Guardar configuraci√≥n de escala
                appState.initialARScale = parseFloat(document.getElementById('initial-ar-scale-slider').value);
                appState.realDimensions.groundHeight = parseFloat(document.getElementById('ground-height-input').value);
                startARFlow();
            });

            document.getElementById('back-to-scale-btn').addEventListener('click', () => {
                if(arScene) {
                    // Limpiar escena para ahorrar memoria
                    document.getElementById('ar-scene-container').innerHTML = '';
                    arScene = null;
                    if(gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
                }
                navigateTo('scale');
            });

            document.getElementById('ios-start-button').addEventListener('click', () => {
                const video = document.querySelector('video');
                if(video) video.play();
                document.getElementById('ios-start-button').classList.remove('show');
            });

            // Slider Value Update
            document.getElementById('initial-ar-scale-slider').addEventListener('input', (e) => {
                document.getElementById('initial-scale-value').textContent = e.target.value + 'x';
            });

            // Window Resize
            window.addEventListener('resize', onWindowResize);

            // Service Worker Dummy (Para evitar error en consola si no existe)
            if ('serviceWorker' in navigator) {
                // Aqu√≠ ir√≠a el registro real, pero para esta demo simple lo omitimos 
                // o ponemos uno b√°sico para cumplir con PWA.
            }
        });

    </script>
</body>
</html>

