<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR Constructor Cloud - Fixed</title>
    <!-- Iconos -->
    <link rel="icon" type="image/png" href="https://github.com/instructorandradedcc/55ar/raw/main/favicon3dAR.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet (Mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Model Viewer (AR Nativo Android/iOS) -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <!-- A-Frame (AR Web Basado en GPS/C√°mara) -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>

    <!-- Firebase (M√≥dulos) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, updateDoc, onSnapshot, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js';

        // --- VARIABLES GLOBALES Y CONFIGURACI√ìN ---
        // NOTA: En tu producci√≥n real, reemplaza estas variables con tu config de Firebase.
        // Aqu√≠ usamos las variables del entorno de prueba para que funcione la demo.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ar-demo-v2';
        
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            // Fallback si no hay config del entorno (Para uso local del usuario)
            firebaseConfig = {
                apiKey: "TU_API_KEY_AQUI",
                authDomain: "tu-app.firebaseapp.com",
                projectId: "tu-app",
                storageBucket: "tu-app.appspot.com",
                messagingSenderId: "000000000",
                appId: "1:00000000:web:00000000"
            };
        }

        // Inicializaci√≥n de Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Estado de la Aplicaci√≥n
        const state = {
            user: null,
            currentProject: null,
            tempFile: null,
            calibration: { x:0, y:0, z:0, r:0 },
            map: null,
            projects: []
        };

        // --- CLASE PRINCIPAL DE LA APP ---
        class ARApp {
            constructor() {
                this.initAuthListener();
                this.checkUrlParams();
            }

            // 1. GESTI√ìN DE AUTENTICACI√ìN
            async initAuthListener() {
                // Escucha cambios de sesi√≥n
                onAuthStateChanged(auth, (user) => {
                    state.user = user;
                    if (user) {
                        this.updateUIUser(user);
                        this.navTo('dashboard');
                        this.listenToProjects();
                    } else {
                        this.navTo('auth');
                    }
                });

                // Bot√≥n de Login (Adaptado para Demo y Prod)
                const loginBtn = document.getElementById('login-btn');
                if(loginBtn) {
                    loginBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        this.loader(true, "Autenticando...");
                        try {
                            // L√≥gica de Autenticaci√≥n compatible con el entorno
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Login error:", error);
                            this.toast("Error de acceso: " + error.message, "error");
                        }
                        this.loader(false);
                    });
                }
            }

            updateUIUser(user) {
                const roleEl = document.getElementById('user-role-display');
                if(roleEl) roleEl.textContent = `USUARIO: ${user.uid.substring(0,6)}...`;
            }

            logout() {
                signOut(auth).then(() => {
                    this.toast("Sesi√≥n cerrada");
                    window.location.reload();
                });
            }

            // 2. GESTI√ìN DE DATOS (FIRESTORE)
            listenToProjects() {
                if (!state.user) return;
                const list = document.getElementById('projects-list');
                list.innerHTML = '<div class="text-center text-gray-400 mt-10 animate-pulse">Cargando proyectos...</div>';

                // Usamos una ruta segura por usuario: artifacts/{appId}/users/{userId}/projects
                const projectsRef = collection(db, 'artifacts', appId, 'users', state.user.uid, 'projects');
                
                onSnapshot(projectsRef, (snapshot) => {
                    list.innerHTML = '';
                    if (snapshot.empty) {
                        list.innerHTML = `
                            <div class="flex flex-col items-center justify-center text-gray-400 mt-10 p-6 text-center">
                                <div class="text-4xl mb-2">üìÇ</div>
                                <p>No tienes proyectos.</p>
                                <p class="text-xs mt-1">Crea uno nuevo para empezar.</p>
                            </div>`;
                        return;
                    }

                    snapshot.forEach(docSnap => {
                        const p = docSnap.data();
                        const pid = docSnap.id;
                        this.renderProjectCard(pid, p, list);
                    });
                }, (error) => {
                    console.error("Error escuchando proyectos:", error);
                    this.toast("Error de conexi√≥n BD", "error");
                });
            }

            renderProjectCard(id, data, container) {
                const card = document.createElement('div');
                card.className = 'project-card bg-white border border-gray-200 rounded-xl p-4 mb-3 shadow-sm hover:shadow-md transition-all';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">${data.name}</h3>
                            <p class="text-xs text-gray-500 font-mono">Lat: ${data.coords?.lat.toFixed(4) || 0}, Lon: ${data.coords?.lon.toFixed(4) || 0}</p>
                        </div>
                        <div class="flex gap-1">
                           <button onclick="window.app.deleteProject('${id}')" class="text-xs text-red-400 hover:text-red-600 p-2">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="window.app.openProject('${id}', 'view')" class="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-blue-200 shadow-lg transition">Ver AR</button>
                        <button onclick="window.app.openProject('${id}', 'edit')" class="flex-1 bg-gray-50 border border-gray-300 text-gray-700 py-2 rounded-lg text-sm font-bold hover:bg-gray-100">Editar</button>
                    </div>
                `;
                container.appendChild(card);
            }

            async deleteProject(id) {
                if(!confirm("¬øEst√°s seguro de borrar este proyecto?")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'projects', id));
                    this.toast("Proyecto eliminado");
                } catch (e) {
                    this.toast("Error al borrar", "error");
                }
            }

            // 3. CREACI√ìN Y EDICI√ìN
            newProject() {
                state.currentProject = null;
                state.tempFile = null;
                document.getElementById('project-name').value = "";
                document.getElementById('file-name').textContent = "M√°x 50MB (.glb)";
                document.getElementById('upload-overlay').classList.remove('hidden');
                this.navTo('editor');
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    if(!file.name.endsWith('.glb') && !file.name.endsWith('.gltf')) {
                        this.toast("Solo archivos .glb o .gltf", "error");
                        return;
                    }
                    state.tempFile = file;
                    document.getElementById('file-name').textContent = file.name;
                }
            }

            async uploadAndStart() {
                const name = document.getElementById('project-name').value;
                if (!name) return this.toast("Escribe un nombre para el proyecto", "error");
                
                // NOTA: En esta demo, si no hay archivo, usaremos un modelo por defecto
                // En producci√≥n, subir√≠amos a Firebase Storage.
                
                this.loader(true, "Creando proyecto...");
                
                let modelUrl = "https://modelviewer.dev/shared-assets/models/Astronaut.glb"; // Default
                
                try {
                    if (state.tempFile) {
                        // Intento de subida (Fallar√° si Storage no est√° configurado en el entorno demo)
                        try {
                            const storageRef = ref(storage, `users/${state.user.uid}/models/${Date.now()}_${state.tempFile.name}`);
                            const snap = await uploadBytes(storageRef, state.tempFile);
                            modelUrl = await getDownloadURL(snap.ref);
                        } catch (storageErr) {
                            console.warn("Storage upload failed (expected in demo env), using default model or local blob");
                            // Fallback para demo local: Blob URL
                            // modelUrl = URL.createObjectURL(state.tempFile); 
                            // Nota: Blob URLs no persisten. Usaremos el default para asegurar persistencia en la demo.
                            this.toast("Modo Demo: Usando modelo de prueba (Storage limitado)", "warning");
                        }
                    }

                    const newDocRef = doc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'projects'));
                    const projData = {
                        name: name,
                        modelUrl: modelUrl,
                        ownerId: state.user.uid,
                        coords: { lat: 4.6097, lon: -74.0817 }, // Default Bogot√°
                        calibration: { x:0, y:0, z:0, r:0 },
                        createdAt: new Date().toISOString()
                    };
                    
                    await setDoc(newDocRef, projData);
                    state.currentProject = { id: newDocRef.id, data: projData };
                    
                    document.getElementById('upload-overlay').classList.add('hidden');
                    this.initMap(projData.coords.lat, projData.coords.lon);
                    this.toast("Proyecto creado con √©xito");

                } catch (e) {
                    console.error(e);
                    this.toast("Error creando proyecto: " + e.message, "error");
                }
                this.loader(false);
            }

            async saveProjectData() {
                if (!state.currentProject || !state.map) return;
                const ll = state.map.getCenter();
                this.loader(true, "Guardando ubicaci√≥n...");
                try {
                    const projRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'projects', state.currentProject.id);
                    await updateDoc(projRef, {
                        "coords.lat": ll.lat,
                        "coords.lon": ll.lng
                    });
                    this.toast("¬°Ubicaci√≥n actualizada!");
                    this.navTo('dashboard');
                } catch (e) { 
                    console.error(e);
                    this.toast("Error guardando", "error"); 
                }
                this.loader(false);
            }

            // 4. MAPAS Y GEOLOCALIZACI√ìN
            initMap(lat, lon) {
                const container = document.getElementById('map-canvas');
                // Limpiar mapa previo si existe
                if (state.map) {
                    state.map.off();
                    state.map.remove();
                    state.map = null;
                }
                
                // Resetear contenedor
                container.innerHTML = "";

                const center = [lat || 4.6097, lon || -74.0817];
                
                state.map = L.map(container, {
                    zoomControl: false 
                }).setView(center, 18);

                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 19
                }).addTo(state.map);

                const icon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });

                const marker = L.marker(center, { draggable: true, icon: icon }).addTo(state.map);

                // Eventos
                const updateUI = (e) => {
                    const ll = e.target.getLatLng();
                    document.getElementById('editor-lat').textContent = ll.lat.toFixed(6);
                    document.getElementById('editor-lon').textContent = ll.lng.toFixed(6);
                };
                
                marker.on('drag', updateUI);
                // Trigger inicial
                updateUI({ target: marker });
                
                setTimeout(() => { state.map.invalidateSize(); }, 500);
            }

            useGPS() {
                this.loader(true, "Obteniendo GPS...");
                if (!navigator.geolocation) {
                    this.toast("GPS no soportado", "error");
                    this.loader(false);
                    return;
                }
                navigator.geolocation.getCurrentPosition(pos => {
                    if(state.map) {
                        const ll = [pos.coords.latitude, pos.coords.longitude];
                        state.map.setView(ll, 19);
                        state.map.eachLayer((layer) => { 
                            if(layer instanceof L.Marker) {
                                layer.setLatLng(ll); 
                                // Actualizar UI manual
                                document.getElementById('editor-lat').textContent = ll[0].toFixed(6);
                                document.getElementById('editor-lon').textContent = ll[1].toFixed(6);
                            }
                        });
                        this.toast("Ubicaci√≥n GPS encontrada");
                    }
                    this.loader(false);
                }, (err) => {
                    this.toast("Error GPS: " + err.message, "error");
                    this.loader(false);
                });
            }

            // 5. REALIDAD AUMENTADA (AR)
            async openProject(id, mode) {
                this.loader(true, "Cargando proyecto...");
                try {
                    const projRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'projects', id);
                    const docSnap = await getDoc(projRef);
                    
                    if (!docSnap.exists()) throw new Error("El proyecto no existe");
                    
                    const data = docSnap.data();
                    state.currentProject = { id, data };
                    
                    if (mode === 'edit') {
                        document.getElementById('upload-overlay').classList.add('hidden');
                        this.navTo('editor');
                        setTimeout(() => this.initMap(data.coords.lat, data.coords.lon), 100);
                    } else {
                        this.navTo('ar');
                        this.startARSession(data);
                    }
                } catch (e) {
                    console.error(e);
                    this.toast(e.message, "error");
                    this.navTo('dashboard');
                }
                this.loader(false);
            }

            startARSession(data) {
                // Limpieza previa
                const container = document.getElementById('ar-gps-container');
                container.innerHTML = '';

                const t = data.coords;
                const c = data.calibration || {x:0,y:0,z:0,r:0};
                state.calibration = c;

                // Construcci√≥n de la escena A-Frame din√°micamente
                // Usamos a-entity gps-new-entity-place para mejor precisi√≥n si usamos la librer√≠a location-only
                // Pero usaremos el est√°ndar robusto aqu√≠.
                
                const sceneHTML = `
                    <a-scene 
                        embedded 
                        vr-mode-ui="enabled: false" 
                        renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true;" 
                        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
                        
                        <a-camera gps-camera="minDistance: 5;" rotation-reader></a-camera>

                        <a-entity gps-entity-place="latitude: ${t.lat}; longitude: ${t.lon};">
                            <a-entity id="model-entity" 
                                position="${c.x} ${c.y} ${c.z}" 
                                rotation="0 ${c.r} 0" 
                                scale="1 1 1">
                                <a-entity gltf-model="${data.modelUrl}" scale="0.5 0.5 0.5"></a-entity>
                            </a-entity>
                        </a-entity>

                        <a-light type="ambient" intensity="1.5"></a-light>
                        <a-light type="directional" position="-1 1 0" intensity="2"></a-light>
                    </a-scene>
                `;
                
                container.innerHTML = sceneHTML;

                // Listeners de GPS Debug
                window.addEventListener('gps-camera-update-position', e => {
                    const acc = e.detail.position.accuracy;
                    const badge = document.getElementById('gps-acc');
                    if(badge) badge.textContent = acc ? acc.toFixed(1) : '--';
                });
            }

            // Calibraci√≥n en Tiempo Real
            adj(axis, val) {
                const c = state.calibration;
                if (axis === 'r') c.r += val; else c[axis] += val;
                
                const el = document.getElementById('model-entity');
                if (el) {
                    el.setAttribute('position', `${c.x} ${c.y} ${c.z}`);
                    el.setAttribute('rotation', `0 ${c.r} 0`);
                    this.toast(`Ajuste ${axis.toUpperCase()}: ${val > 0 ? '+' : ''}${val}`);
                }
            }

            async saveCalibration() {
                if (!state.currentProject) return;
                try {
                    const projRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'projects', state.currentProject.id);
                    await updateDoc(projRef, { calibration: state.calibration });
                    this.toast("¬°Calibraci√≥n guardada en la nube!");
                } catch (e) { 
                    this.toast("Error guardando", "error"); 
                }
            }
            
            // Surface Mode (Model Viewer)
            openSurface() {
                const v = document.getElementById('viewer');
                if(state.currentProject && state.currentProject.data.modelUrl) {
                    v.src = state.currentProject.data.modelUrl;
                    document.getElementById('ar-surface-container').classList.remove('hidden');
                } else {
                    this.toast("No hay modelo cargado", "error");
                }
            }
            
            closeSurface() { 
                document.getElementById('ar-surface-container').classList.add('hidden'); 
                // Detener c√°mara de model-viewer si est√° activa (reset simple)
                const v = document.getElementById('viewer');
                v.src = v.src; 
            }

            zoomViewer(val) {
                const viewer = document.getElementById('viewer');
                // L√≥gica simple de zoom manual si la c√°mara orbital lo permite
                // Model viewer maneja zoom nativo con pinch, esto es auxiliar
                this.toast("Usa dos dedos para hacer zoom", "info");
            }

            // 6. UTILIDADES UI
            toggleCal() { 
                document.getElementById('cal-hud').classList.toggle('active'); 
            }

            exitAR() {
               this.navTo('dashboard');
               // Limpiar A-Frame para liberar memoria/c√°mara
               document.getElementById('ar-gps-container').innerHTML = '';
               window.location.reload(); // Reset m√°s seguro para limpiar WebGL
            }

            checkUrlParams() {
                // Simulaci√≥n de deep linking
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (id && state.user) this.openProject(id, 'view');
            }

            navTo(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                const target = document.getElementById('view-' + viewId);
                if(target) target.classList.add('active');
            }

            toast(msg, type = 'info') {
                const t = document.getElementById('toast');
                const msgEl = document.getElementById('toast-msg');
                if(!t || !msgEl) return;
                
                msgEl.textContent = msg;
                
                if(type === 'error') t.className = "bg-red-600 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 transform transition-all duration-300 z-[10000]";
                else if (type === 'warning') t.className = "bg-yellow-600 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 transform transition-all duration-300 z-[10000]";
                else t.className = "bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 transform transition-all duration-300 z-[10000]";
                
                t.style.top = "20px";
                
                setTimeout(() => { t.style.top = "-100px"; }, 4000);
            }

            loader(show, text) {
                const l = document.getElementById('loader');
                if(!l) return;
                if(show) {
                    document.getElementById('loader-text').textContent = text;
                    l.classList.remove('hidden');
                } else l.classList.add('hidden');
            }
        }

        // Bootstrap
        window.addEventListener('load', () => {
            window.app = new ARApp();
            document.getElementById('model-input').addEventListener('change', (e) => window.app.handleFileSelect(e));
        });

    </script>

    <style>
        /* Estilos Base */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        
        /* Vistas SPA */
        .view-section { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; flex-direction: column; background: #fff; }
        .view-section.active { display: flex; z-index: 10; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #2563eb; transition: opacity 0.3s; }
        #loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(37,99,235,0.2); border-top-color: #2563eb; border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); transition: top 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        
        /* HUD de Calibraci√≥n */
        .cal-hud { position: fixed; bottom: 120px; right: 20px; background: rgba(0,0,0,0.85); padding: 12px; border-radius: 20px; z-index: 100; display: none; flex-direction: column; gap: 8px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); }
        .cal-hud.active { display: flex; }
        .pad-btn { width: 48px; height: 48px; background: rgba(255,255,255,0.1); color: white; border-radius: 12px; font-size: 22px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: background 0.2s; }
        .pad-btn:active { background: #3b82f6; transform: scale(0.95); }

        /* AR UI */
        .ar-controls-container { position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; gap: 10px; padding: 0 20px; z-index: 1000; pointer-events: none; }
        .ar-controls-container button { pointer-events: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <!-- NOTIFICACIONES -->
    <div id="toast" class="bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 z-[10000]">
        <span class="text-xl">‚ÑπÔ∏è</span><span id="toast-msg">Mensaje</span>
    </div>

    <!-- LOADER -->
    <div id="loader" class="hidden">
        <div class="spinner mb-4"></div>
        <p id="loader-text" class="font-bold animate-pulse">Cargando...</p>
    </div>

    <!-- VISTA 1: AUTH (LOGIN) -->
    <div id="view-auth" class="view-section justify-center items-center p-6 bg-gray-50">
        <div class="w-full max-w-sm bg-white p-8 rounded-3xl shadow-2xl relative text-center border border-gray-100">
            <div class="w-20 h-20 bg-gradient-to-tr from-blue-600 to-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-6 text-4xl shadow-lg shadow-blue-200">üèóÔ∏è</div>
            <h1 class="text-3xl font-bold text-gray-900 mb-1">AR Cloud Pro</h1>
            <p class="text-sm text-gray-500 mb-8">Gesti√≥n de Realidad Aumentada</p>

            <button id="login-btn" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black transform transition active:scale-95 flex items-center justify-center gap-3">
                <span>üöÄ</span> Entrar al Sistema
            </button>
            
            <p class="text-xs text-gray-400 mt-6">Versi√≥n 2.0 Fix ‚Ä¢ Modo Seguro</p>
        </div>
    </div>

    <!-- VISTA 2: DASHBOARD -->
    <div id="view-dashboard" class="view-section bg-gray-50">
        <!-- Header -->
        <div class="bg-white px-6 py-5 shadow-sm flex justify-between items-center z-20 sticky top-0 border-b border-gray-100">
            <div>
                <h2 class="text-xl font-bold text-gray-800">Mis Proyectos</h2>
                <p id="user-role-display" class="text-xs text-blue-600 font-bold tracking-wider mt-1">CARGANDO...</p>
            </div>
            <button onclick="app.logout()" class="bg-red-50 text-red-500 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-100 transition">Salir</button>
        </div>

        <!-- Lista de Proyectos -->
        <div class="p-4 overflow-y-auto flex-1" id="projects-list">
            <!-- Se llena din√°micamente -->
        </div>

        <!-- FAB Nuevo Proyecto -->
        <div class="p-4 bg-transparent text-center absolute bottom-4 right-4 pointer-events-none">
            <button onclick="app.newProject()" class="pointer-events-auto bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:bg-blue-700 transition transform hover:scale-110 active:scale-90">
                +
            </button>
        </div>
    </div>

    <!-- VISTA 3: EDITOR (MAPA Y SUBIDA) -->
    <div id="view-editor" class="view-section">
        <div class="absolute top-4 left-4 z-[500]">
            <button onclick="app.navTo('dashboard')" class="bg-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center font-bold text-gray-600 hover:bg-gray-50">‚Üê</button>
        </div>

        <!-- Overlay de Carga de Archivo -->
        <div id="upload-overlay" class="absolute inset-0 bg-white z-[400] flex flex-col items-center justify-center p-8">
            <div class="w-full max-w-md text-center space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">Nuevo Proyecto AR</h2>
                
                <input type="text" id="project-name" placeholder="Nombre del Proyecto" class="w-full p-4 text-center text-lg font-bold border-b-2 border-gray-200 focus:border-blue-500 outline-none bg-transparent transition">
                
                <div class="border-2 border-dashed border-blue-300 bg-blue-50 rounded-3xl p-10 cursor-pointer relative hover:bg-blue-100 transition group">
                    <input type="file" id="model-input" accept=".glb,.gltf" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-10">
                    <div class="text-5xl mb-3 group-hover:scale-110 transition">üì¶</div>
                    <p class="text-blue-600 font-bold">Toca para subir modelo 3D</p>
                    <p id="file-name" class="text-xs text-gray-400 mt-2 font-mono">Formato .glb (Recomendado)</p>
                </div>

                <button onclick="app.uploadAndStart()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition">
                    Configurar Ubicaci√≥n ‚Üí
                </button>
            </div>
        </div>

        <!-- Mapa -->
        <div id="map-canvas" class="flex-1 w-full z-1"></div>
        
        <!-- Panel Inferior Editor -->
        <div class="absolute bottom-0 left-0 w-full bg-white p-6 rounded-t-3xl shadow-2xl z-[401]">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="font-bold text-gray-900 text-lg">Geolocalizaci√≥n</h3>
                    <p class="text-xs text-gray-500">Mueve el marcador al punto exacto</p>
                </div>
                <button onclick="app.useGPS()" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 hover:bg-indigo-200 transition">
                    üì° Usar mi GPS
                </button>
            </div>
            
            <div class="flex gap-3 mb-6">
                <div class="bg-gray-50 p-3 rounded-xl w-1/2 border border-gray-100">
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Latitud</span>
                    <span id="editor-lat" class="text-sm font-mono font-bold block text-gray-800">0.000000</span>
                </div>
                <div class="bg-gray-50 p-3 rounded-xl w-1/2 border border-gray-100">
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Longitud</span>
                    <span id="editor-lon" class="text-sm font-mono font-bold block text-gray-800">0.000000</span>
                </div>
            </div>

            <button onclick="app.saveProjectData()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
                üíæ Guardar Ubicaci√≥n
            </button>
        </div>
    </div>

    <!-- VISTA 4: VISOR AR (A-FRAME + MODEL VIEWER) -->
    <div id="view-ar" class="view-section bg-black overflow-hidden">
        <!-- Capa GPS (A-Frame) -->
        <div id="ar-gps-container" class="w-full h-full absolute top-0 left-0 z-10"></div>
        
        <!-- Capa Interior (Surface AR - Model Viewer) -->
        <div id="ar-surface-container" class="w-full h-full absolute top-0 left-0 hidden bg-gray-900 z-[600]">
            <model-viewer 
                id="viewer" 
                src="" 
                ar ar-modes="webxr scene-viewer quick-look" 
                camera-controls 
                shadow-intensity="1" 
                auto-rotate 
                touch-action="pan-y" 
                class="w-full h-full">
                
                <button slot="ar-button" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 z-50 hover:scale-105 transition">
                    üì∑ VER EN MI ESPACIO
                </button>
            </model-viewer>
            
            <button onclick="app.closeSurface()" class="absolute top-6 left-6 z-50 bg-black/50 text-white w-10 h-10 rounded-full backdrop-blur flex items-center justify-center hover:bg-black/70">‚úï</button>
        </div>

        <!-- HUD Informaci√≥n GPS -->
        <div class="absolute top-4 left-4 flex gap-2 pointer-events-none z-50">
            <div class="bg-black/60 backdrop-blur text-white px-4 py-2 rounded-full border border-white/10 shadow-lg">
                <span class="text-xs font-mono font-bold flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    GPS: <span id="gps-acc" class="text-yellow-400">--</span>m
                </span>
            </div>
        </div>

        <!-- Controles Principales AR -->
        <div class="ar-controls-container">
            <button onclick="app.exitAR()" class="bg-red-500 text-white w-14 h-14 rounded-full flex items-center justify-center text-xl hover:bg-red-600 transition shadow-lg shadow-red-500/30">‚úï</button>
            
            <button onclick="app.openSurface()" class="flex-1 max-w-xs bg-white/90 backdrop-blur text-gray-900 font-bold py-3 rounded-full shadow-lg hover:bg-white flex items-center justify-center gap-2">
                <span>üè†</span> Ver Detalle
            </button>
            
            <button onclick="app.saveCalibration()" class="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center text-xl hover:bg-blue-700 transition shadow-lg shadow-blue-600/30">üíæ</button>
            
            <button onclick="app.toggleCal()" class="bg-gray-800/80 backdrop-blur text-white w-14 h-14 rounded-full flex items-center justify-center text-xl hover:bg-gray-700 border border-gray-600">üõ†Ô∏è</button>
        </div>

        <!-- Panel Calibraci√≥n -->
        <div id="cal-hud" class="cal-hud">
            <p class="text-white text-[10px] text-center font-bold uppercase opacity-50 mb-1">Ajustar Posici√≥n</p>
            <div class="grid grid-cols-3 gap-1">
                <div></div> 
                <button class="pad-btn" ontouchstart="app.adj('z', -1)" onmousedown="app.adj('z', -1)">‚¨ÜÔ∏è</button> 
                <div></div>
                
                <button class="pad-btn" ontouchstart="app.adj('x', -1)" onmousedown="app.adj('x', -1)">‚¨ÖÔ∏è</button>
                <button class="pad-btn bg-blue-600/50" onclick="app.toast('Moverse')">üìç</button>
                <button class="pad-btn" ontouchstart="app.adj('x', 1)" onmousedown="app.adj('x', 1)">‚û°Ô∏è</button>
                
                <div></div> 
                <button class="pad-btn" ontouchstart="app.adj('z', 1)" onmousedown="app.adj('z', 1)">‚¨áÔ∏è</button> 
                <div></div>
            </div>
            <div class="flex justify-between gap-2 mt-2 border-t border-white/10 pt-2">
                <button class="pad-btn text-sm w-full" ontouchstart="app.adj('r', -5)" onmousedown="app.adj('r', -5)">‚Ü∫ Rotar</button>
                <button class="pad-btn text-sm w-full" ontouchstart="app.adj('r', 5)" onmousedown="app.adj('r', 5)">Rotar ‚Üª</button>
            </div>
        </div>
    </div>

</body>
</html>

