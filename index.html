<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visor AR Arquitectura por Geolocalización</title>
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script>
        // Variable global para controlar cuándo cargar A-Frame y AR.js
        let arLibrariesLoaded = false;

        // Función para cargar las bibliotecas de AR dinámicamente
        function loadARLibraries() {
            if (arLibrariesLoaded) return Promise.resolve();
            
            return new Promise((resolve) => {
                const aframeScript = document.createElement('script');
                aframeScript.src = 'https://aframe.io/releases/1.3.0/aframe.min.js';  // Revertido a 1.3.0 para compatibilidad con AR.js
                document.head.appendChild(aframeScript);
                
                aframeScript.onload = () => {
                    const arjsScript = document.createElement('script');
                    arjsScript.src = 'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js';
                    document.head.appendChild(arjsScript);
                    
                    arjsScript.onload = () => {
                        
                        // // Lo registramos aquí para asegurarnos de que AFRAME esté cargado.
                        AFRAME.registerComponent('webxr-tick', {
                            tick: function () {
                                const appState = window.appGlobalState; // Acceder al estado global
                                if (!appState || !appState.arSession || !appState.hitTestSource || !appState.reticle) return;

                                const frame = this.el.renderer.xr.getFrame();
                                if (!frame) return;
                                
                                const hitTestResults = frame.getHitTestResults(appState.hitTestSource);
                                
                                if (hitTestResults.length > 0) {
                                    const hit = hitTestResults[0];
                                    const refSpace = this.el.renderer.xr.getReferenceSpace();
                                    const pose = hit.getPose(refSpace);
                                    
                                    appState.reticle.setAttribute('visible', 'true');
                                    appState.reticle.object3D.position.copy(pose.transform.position);
                                    appState.reticle.object3D.quaternion.copy(pose.transform.orientation);
                                    appState.reticle.object3D.matrix.decompose(
                                        appState.reticle.object3D.position,
                                        appState.reticle.object3D.quaternion,
                                        appState.reticle.object3D.scale
                                    );
                                } else {
                                    appState.reticle.setAttribute('visible', 'false');
                                }
                            }
                        });
                        // arLibrariesLoaded = true;
                        resolve();
                    };
                };
            });
        }
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
            }
        }
    </script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: transparent !important;
        }
        .page {
            display: none;
            height: 100%;
            width: 100%;
            position: relative;
        }
        .page.active {
            display: block;
        }
        /* New styles for the upload page */
        .dynamic-bg {
            background: linear-gradient(135deg, #2b32b2 0%, #1488cc 100%);
            background-image: url('https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/world-map.png');
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }
        .illustration {
            position: absolute;
            bottom: 0;
            width: 250px;
            height: auto;
            z-index: 1;
            pointer-events: none;
        }
        .illustration-left {
            left: -20px;
            content: url('https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/building-left.png');
        }
        .illustration-right {
            right: -20px;
            content: url('https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/building-right.png');
        }
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: none;
            color: white;
        }
        .icon-button i {
            font-size: 1.1em;
        }
        .icon-button.primary { background-color: #3b82f6; }
        .icon-button.primary:hover { background-color: #2563eb; }
        .icon-button.success { background-color: #22c55e; }
        .icon-button.success:hover { background-color: #16a34a; }
        .icon-button.info { background-color: #8b5cf6; }
        .icon-button.info:hover { background-color: #7c3aed; }
        
        .link-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .link-button.primary { color: #3b82f6; }
        .link-button.primary:hover { color: #2563eb; text-decoration: underline;}
        .link-button.danger { color: #ef4444; }
        .link-button.danger:hover { color: #dc2626; text-decoration: underline;}
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .control-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .control-button:hover {
            background-color: #45a049;
        }
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #message-box.show {
            opacity: 1;
        }
        #map-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }
        #map-canvas {
            width: 100%; height: 100%; z-index: 1;
        }
        #model-preview-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 401;
            display: block;
        }
        .map-ui-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 300px;
        }
        #map-controls {
            position: fixed;
            top: 70px; right: 20px; z-index: 402; display: flex; flex-direction: column; gap: 10px;
        }
        #map-crosshair {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 30px; height: 30px; border: 2px solid white;
            border-radius: 50%; box-shadow: 0 0 10px black;
            pointer-events: none; z-index: 402;
        }
        #coords-jumpto {
            position: fixed; top: 20px; left: 20px; z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px; border-radius: 8px; display: flex; gap: 5px; align-items: center;
        }
        a-scene {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important; z-index: 1 !important;
            background: transparent !important;
        }
        .arjs-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); color: white;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.5rem; z-index: 10000; text-align: center;
        }
        .permission-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; justify-content: center; align-items: center; z-index: 10001;
        }
        .permission-content {
            background-color: white; padding: 20px; border-radius: 10px;
            max-width: 80%; text-align: center;
        }
        .permission-button {
            background-color: #4CAF50; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px;
        }
        #ar-controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; display: flex; gap: 10px;
        }
        .ar-info-panel {
            position: fixed; top: 20px; left: 20px;
            background-color: rgba(0,0,0,0.7); color: white;
            padding: 10px; border-radius: 8px; font-size: 14px;
            z-index: 9998;
        }
        .ar-scale-control {
            position: fixed; top: 20px; right: 20px;
            background-color: rgba(0,0,0,0.7); color: white;
            padding: 10px; border-radius: 8px; z-index: 9998;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            #map-controls {
                top: 120px !important;
                right: 10px !important;
            }
            .map-ui-container {
                width: 280px !important;
                bottom: 10px !important;
            }
            #coords-jumpto {
                top: 70px !important;
                left: 10px !important;
            }
            .illustration {
                width: 150px;
            }
        }
        
        /* Estilos para la página de carga interactiva */
        .ar-loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #2a5298);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10002;
        }
        .ar-loading-screen.active {
            display: flex;
        }
        .loading-content {
            text-align: center;
            max-width: 80%;
        }
        .loading-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .loading-progress {
            width: 80%;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin: 20px auto;
            overflow: hidden;
        }
        .loading-progress-bar {
            height: 100%;
            width: 0%;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .loading-steps {
            margin-top: 30px;
            text-align: left;
        }
        .loading-step {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .step-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        .step-icon.completed {
            color: #4CAF50;
        }
        .step-icon.active {
            color: #FFC107;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .ar-debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            border-radius: 5px;
            font-size: 10px;
            z-index: 10003;
            display: none;
        }
        
        /* * =================================================================================
         * CORRECCIÓN CRÍTICA: Forzar la visualización del video de la cámara AR
         * =================================================================================
         */
        video {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            z-index: -1 !important;
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            autoplay: true !important;
            playsinline: true !important;
            webkit-playsinline: true !important;
            muted: true !important;
        }
        
        .arjs-video {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            z-index: -1 !important;
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            autoplay: true !important;
            playsinline: true !important;
            webkit-playsinline: true !important;
            muted: true !important;
        }
        
        .a-canvas {
            z-index: 1 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        /*
         * =================================================================================
         * CORRECCIÓN CRÍTICA: Forzar transparencia completa en el canvas de A-Frame
         * =================================================================================
         */
        #ar-scene {
            background: transparent !important;
            background-color: transparent !important;
        }
        
        #ar-scene .a-canvas {
            background: transparent !important;
            background-color: rgba(0, 0, 0, 0) !important;
        }
        
        canvas {
            background: transparent !important;
            background-color: rgba(0, 0, 0, 0) !important;
        }
        
        /* Estilos para los inputs de escala */
        .scale-input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .scale-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }
        .scale-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .scale-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        /* Estilos para el indicador de GPS */
        .gps-indicator {
            position: fixed;
            top: 80px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9998;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .gps-indicator.active {
            background-color: rgba(76, 175, 80, 0.8);
        }
        .gps-indicator.error {
            background-color: rgba(244, 67, 54, 0.8);
        }
        .gps-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #4CAF50;
            animation: gps-pulse 2s infinite;
        }
        @keyframes gps-pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        /* Estilos para el panel de coordenadas del modelo */
        .model-coords-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9998;
            min-width: 200px;
        }
        .coord-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        .coord-label {
            font-weight: bold;
            color: #4CAF50;
        }
        .coord-value {
            font-family: monospace;
        }
        
        /* Estilos para los indicadores de ubicación en AR */
        .location-indicator {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 9997;
            display: flex;
            align-items: center;
            gap: 5px;
            pointer-events: none;
        }
        .current-location-indicator {
            bottom: 100px;
            left: 20px;
            background-color: rgba(76, 175, 80, 0.9);
            border: 2px solid #4CAF50;
        }
        .model-location-indicator {
            bottom: 100px;
            right: 20px;
            background-color: rgba(255, 152, 0, 0.9);
            border: 2px solid #FF9800;
        }
        .location-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
        }
        
        /* Estilos para la línea de conexión */
        .connection-line {
            position: fixed;
            background: linear-gradient(90deg, #4CAF50, #FF9800);
            height: 3px;
            transform-origin: left center;
            z-index: 9996;
            pointer-events: none;
            opacity: 0.7;
        }
        
        /* Estilos para el panel de distancia */
        .distance-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            z-index: 9997;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid #4CAF50;
        }
        .distance-value {
            color: #4CAF50;
            font-size: 18px;
        }
        
        /* Estilos para el modo de exploración */
        .exploration-mode {
            position: fixed;
            top: 140px;
            right: 20px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9998;
            display: none;
        }
        .exploration-mode.active {
            display: block;
        }
        .mode-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        
        /* Botón de inicio forzado para iOS */
        .ios-start-button {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #4CAF50;
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            z-index: 10004;
            display: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .ios-start-button.show {
            display: block;
        }
        
        /* Nuevos estilos para guías de distancia */
        .distance-guide {
            color: red;
            font-size: 0.5rem;
        }
        
        /* Estilos para input de escala numérico */
        #scale-input {
            width: 70px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #333;
            color: white;
            text-align: center;
        }
        
        /* Estilos para slider de altura */
        .height-control {
            position: fixed;
            bottom: 120px;
            right: 20px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            z-index: 9998;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 200px;
        }
        #height-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 8px;
            height: 150px;
            background: #555;
            outline: none;
            border-radius: 4px;
        }
        #height-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4CAF50;
            cursor: pointer;
            border-radius: 50%;
        }
        #height-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4CAF50;
            cursor: pointer;
            border-radius: 50%;
        }
        #height-value {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="upload-page" class="page active dynamic-bg">
        <div class="illustration illustration-left"></div>
        <div class="illustration illustration-right"></div>
        <div class="flex items-center justify-center h-full w-full">
            <div class="bg-white/90 backdrop-blur-sm p-8 rounded-2xl shadow-2xl w-full max-w-lg mx-4 z-10">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">Configuración de Escena AR</h1>
                <p class="text-center text-gray-500 mb-6 text-sm">
                    Versión <span id="version-display" class="font-semibold"></span>
                </p>

                <div id="upload-section" class="space-y-6">
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-700">1. Subir Modelo 3D (.glb)</label>
                        <div class="flex items-center space-x-2">
                            <input type="file" id="model-upload" accept=".glb" class="hidden">
                            <button id="select-file-btn" class="icon-button primary flex-shrink-0">
                                <i class="fas fa-file-arrow-up"></i>
                                <span>Seleccionar archivo</span>
                            </button>
                            <input type="text" id="file-name-display" placeholder="Ningún archivo seleccionado" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-sm truncate">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="latitude-input" class="block mb-2 text-sm font-medium text-gray-700">2. Latitud</label>
                            <div class="relative">
                                <i class="fas fa-map-marker-alt absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="number" id="latitude-input" placeholder="Ej: 4.0950" step="any" class="w-full p-2 pl-9 border border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div>
                            <label for="longitude-input" class="block mb-2 text-sm font-medium text-gray-700">3. Longitud</label>
                            <div class="relative">
                                <i class="fas fa-map-marker-alt absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="number" id="longitude-input" placeholder="Ej: -76.1950" step="any" class="w-full p-2 pl-9 border border-gray-300 rounded-md">
                            </div>
                        </div>
                    </div>
                    <button id="use-location-btn" class="link-button primary w-full justify-start text-sm">
                        <i class="fas fa-location-crosshairs"></i>
                        <span>Usar mi ubicación actual</span>
                    </button>
                </div>
                
                <div id="status-section" class="mt-6 text-center hidden">
                    <p id="status-text" class="text-lg font-semibold text-green-600">Modelo y ubicación cargados.</p>
                </div>

                <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
                    <button id="load-data-btn" class="icon-button success w-full sm:w-auto">
                        <i class="fas fa-check"></i>
                        <span>Cargar y Guardar</span>
                    </button>
                    <button id="goto-map-btn" class="icon-button info w-full sm:w-auto" disabled>
                        <i class="fas fa-map-location-dot"></i>
                        <span>Ver en Mapa</span>
                    </button>
                </div>

                <div class="mt-6 text-center">
                    <button id="clear-cache-btn" class="link-button danger text-sm">
                        <i class="fas fa-trash-can"></i>
                        <span>Limpiar Datos y Recargar</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="map-page" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <div id="map-crosshair"></div>
            <canvas id="model-preview-canvas"></canvas>
        </div>
        <div id="coords-jumpto">
            <input type="number" id="jumpto-lat" placeholder="Latitud" class="w-24 p-1 border rounded text-sm">
            <input type="number" id="jumpto-lon" placeholder="Longitud" class="w-24 p-1 border rounded text-sm">
            <button id="jumpto-btn" class="control-button bg-blue-500 hover:bg-blue-600 p-2 text-sm">Ir</button>
        </div>
        <div id="map-controls">
            <button id="back-to-setup-from-map-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver</button>
            <button id="apply-coords-btn" class="control-button bg-orange-500 hover:bg-orange-600">Aplicar Coordenadas</button>
            <button id="goto-scale-btn" class="control-button bg-purple-500 hover:bg-purple-600">Configurar Escala</button>
        </div>
        <div class="map-ui-container">
            <div class="slider-container">
                <label for="map-zoom-slider" class="block text-sm font-medium text-gray-700">Zoom del Mapa</label>
                <input id="map-zoom-slider" type="range" min="1" max="22" value="18" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="slider-container">
                <label for="map-scale-slider" class="block text-sm font-medium text-gray-700">Escala del Modelo</label>
                <input id="map-scale-slider" type="range" min="1" max="200" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
    </div>

    <div id="scale-page" class="page">
        <div class="flex items-center justify-center h-full bg-gray-100">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Configuración de Escala Real</h1>
                <div class="space-y-4">
                    <div class="scale-input-group">
                        <label class="scale-label">Ancho real (m) - Eje X:</label>
                        <input type="number" id="real-width-input" class="scale-input" placeholder="10.0" step="0.1" min="0.1">
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Largo real (m) - Eje Z:</label>
                        <input type="number" id="real-length-input" class="scale-input" placeholder="15.0" step="0.1" min="0.1">
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Alto real (m) - Eje Y:</label>
                        <input type="number" id="real-height-input" class="scale-input" placeholder="3.0" step="0.1" min="0.1">
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Altura sobre terreno (m):</label>
                        <input type="number" id="ground-height-input" class="scale-input" placeholder="0.0" step="0.1">
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Escala Visual Inicial:</label>
                        <input type="range" id="initial-ar-scale-slider" min="0.1" max="5" step="0.1" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="initial-scale-value" class="text-sm text-gray-600">1.0x</span>
                    </div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
                    <button id="back-to-map-from-scale-btn" class="control-button bg-gray-500 hover:bg-gray-600 w-full sm:w-auto">Volver al Mapa</button>
                    <button id="goto-ar-from-scale-btn" class="control-button bg-green-500 hover:bg-green-600 w-full sm:w-auto">Iniciar AR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ar-page" class="page">
        <div id="ar-loading-screen" class="ar-loading-screen">
            <div class="loading-content">
                <div class="loading-title">Iniciando Realidad Aumentada</div>
                <div class="loading-progress">
                    <div id="loading-progress-bar" class="loading-progress-bar"></div>
                </div>
                <div id="loading-status-text">Preparando componentes...</div>
                <div class="loading-steps">
                    <div class="loading-step" id="step-libraries">
                        <span class="step-icon">⏳</span>
                        <span>Cargando bibliotecas AR</span>
                    </div>
                    <div class="loading-step" id="step-permissions">
                        <span class="step-icon">⏳</span>
                        <span>Verificando permisos</span>
                    </div>
                    <div class="loading-step" id="step-camera">
                        <span class="step-icon">⏳</span>
                        <span>Inicializando cámara</span>
                    </div>
                    <div class="loading-step" id="step-gps">
                        <span class="step-icon">⏳</span>
                        <span>Obteniendo ubicación GPS</span>
                    </div>
                    <div class="loading-step" id="step-model">
                        <span class="step-icon">⏳</span>
                        <span>Cargando modelo 3D</span>
                    </div>
                    <div class="loading-step" id="step-complete">
                        <span class="step-icon">⏳</span>
                        <span>¡Listo para explorar!</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="arjs-loader">
            <div>
                <div class="loader"></div>
                <p id="ar-loading-text">Iniciando...</p>
            </div>
        </div>
        <div id="ar-scene-container"></div>
        
        <button id="ios-start-button" class="ios-start-button">
            Toca para iniciar la cámara AR
        </button>
        
        <div id="gps-indicator" class="gps-indicator">
            <div class="gps-dot"></div>
            <span id="gps-indicator-text">GPS: Buscando...</span>
        </div>
        
        <div class="model-coords-panel">
            <h3 style="margin-bottom: 10px; text-align: center; color: #4CAF50;">Georreferencia del Modelo</h3>
            <div class="coord-item">
                <span class="coord-label">Latitud:</span>
                <span class="coord-value" id="model-lat">--</span>
            </div>
            <div class="coord-item">
                <span class="coord-label">Longitud:</span>
                <span class="coord-value" id="model-lon">--</span>
            </div>
            <div class="coord-item">
                <span class="coord-label">Altura:</span>
                <span class="coord-value" id="model-height">--</span>
            </div>
            <div class="coord-item">
                <span class="coord-label">Distancia:</span>
                <span class="coord-value" id="model-distance">--</span>
            </div>
        </div>
        
        <div class="ar-info-panel">
            <div><strong>GPS:</strong> <span id="gps-status">Buscando...</span></div>
            <div><strong>Precisión:</strong> <span id="gps-accuracy" style="font-weight: bold;">--</span>m</div>
            <div><strong>Escala:</strong> <span id="current-scale">1.0</span>x</div>
        </div>
        <div class="ar-scale-control">
            <label for="ar-scale-slider" class="text-sm">Escala</label>
            <input id="ar-scale-slider" type="range" min="0.1" max="10" step="0.1" value="1">
            <input type="number" id="scale-input" min="0.1" max="10" step="0.1" value="1.0">
        </div>
        <div class="height-control">
            <label for="height-slider" class="text-sm">Altura</label>
            <input id="height-slider" type="range" min="-20" max="20" step="0.1" value="0" orient="vertical">
            <span id="height-value">0.0m</span>
        </div>
        <div id="ar-controls">
            <button id="back-to-scale-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver</button>
            <button id="toggle-surface-mode-btn" class="control-button bg-yellow-500 hover:bg-yellow-600">Modo Superficie</button>
            <button id="toggle-guides-btn" class="control-button bg-red-500 hover:bg-red-600">Mostrar Guías</button>
        </div>
        
        <div id="ar-debug-info" class="ar-debug-info"></div>
    </div>

    <div id="permission-modal" class="permission-modal">
        <div class="permission-content">
            <h2>Permisos necesarios</h2>
            <p>Esta aplicación necesita acceso a tu cámara y ubicación para la experiencia de Realidad Aumentada.</p>
            <button id="grant-permissions-btn" class="permission-button">Conceder Permisos</button>
        </div>
    </div>

    <div id="message-box"></div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // const APP_VERSION = '0.10'; // Corregido GPS, implementado Modo Superficie y Guías
        const CACHE_NAME = `geo-ar-cache-v${APP_VERSION.replace(/\./g, '')}`;
        
        let appState = {
            modelURL: null,
            coords: null,
            arTargetCoords: null,
            currentGPSLocation: null,
            realDimensions: { width: 10.0, length: 15.0, height: 3.0, groundHeight: 0.0 },
            initialARScale: 1.0,
            modelBounds: null,
            mapScale: 50,
            explorationMode: false,
            videoStarted: false,
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
            surfaceMode: false,
            showGuides: false,
            modelHeight: 0,
            
            // arSession: null,
            hitTestSource: null,
            reticle: null,
            surfaceModel: null
        };
        // window.appGlobalState = appState;

        let map, modelPreview = {
            renderer: null,
            scene: null,
            camera: null,
            model: null,
            animationFrameId: null,
            isRotating: false,
            isTwoFingerRotating: false,
            previousMousePosition: { x: 0, y: 0 },
            previousTouchAngle: 0,
            maxSize: 1
        };

        // Variables para el control de la escena AR
        let arScene = null;
        let arCamera = null;
        let arModel = null; // Este será el modelo GPS
        let gpsWatchId = null;
        let modelLoaded = false;
        let guideEntities = [];

        const pages = {
            upload: document.getElementById('upload-page'),
            map: document.getElementById('map-page'),
            scale: document.getElementById('scale-page'),
            ar: document.getElementById('ar-page')
        };
        const messageBox = document.getElementById('message-box');
        const permissionModal = document.getElementById('permission-modal');
        const arLoadingScreen = document.getElementById('ar-loading-screen');
        const loadingProgressBar = document.getElementById('loading-progress-bar');
        const loadingStatusText = document.getElementById('loading-status-text');
        const arDebugInfo = document.getElementById('ar-debug-info');
        
        // --- Custom file input logic ---
        document.getElementById('select-file-btn').addEventListener('click', () => {
            document.getElementById('model-upload').click();
        });

        document.getElementById('model-upload').addEventListener('change', (event) => {
            const fileNameDisplay = document.getElementById('file-name-display');
            if (event.target.files && event.target.files.length > 0) {
                fileNameDisplay.value = event.target.files[0].name;
            } else {
                fileNameDisplay.value = 'Ningún archivo seleccionado';
            }
        });

        function showMessage(msg, duration = 3000) {
            messageBox.textContent = msg;
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), duration);
        }

        function navigateTo(pageName) {
            Object.values(pages).forEach(p => p.classList.remove('active'));
            pages[pageName].classList.add('active');

            if (pageName === 'map') {
                setTimeout(() => {
                    initMapAndPreview();
                    setTimeout(() => {
                        if (map) map.invalidateSize();
                    }, 100);
                }, 100);
            } else if (pageName === 'scale') {
                loadScaleSettings();
            } else if (pageName !== 'ar') {
                if (map) {
                    map.remove();
                    map = null;
                }
                if (modelPreview.animationFrameId) {
                    cancelAnimationFrame(modelPreview.animationFrameId);
                    modelPreview.animationFrameId = null;
                }
            }
        }
        
        document.getElementById('goto-ar-from-scale-btn').addEventListener('click', () => {
            saveScaleSettings();
            startARFlow();
        });
        
        async function startARFlow() {
            navigateTo('ar');
            permissionModal.style.display = 'flex';
        }

        document.getElementById('grant-permissions-btn').onclick = async () => {
            permissionModal.style.display = 'none';
            arLoadingScreen.classList.add('active');
            
            try {
                updateLoadingScreen('step-libraries', 10, 'Cargando bibliotecas AR...');
                await loadARLibraries();
                updateLoadingScreen('step-permissions', 25, 'Verificando permisos...');
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                stream.getTracks().forEach(track => track.stop());
                await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }));
                
                updateLoadingScreen('step-camera', 40, 'Inicializando cámara...');
                updateLoadingScreen('step-gps', 60, 'Obteniendo ubicación GPS...');
                updateLoadingScreen('step-model', 80, 'Cargando modelo 3D...');
                
                // appState.surfaceMode = false;
                document.getElementById('toggle-surface-mode-btn').textContent = 'Modo Superficie';
                initializeARScene(); // Inicia la escena GPS
                
                updateLoadingScreen('step-complete', 100, '¡Listo para explorar!');
                setTimeout(() => arLoadingScreen.classList.remove('active'), 1500);

            } catch (error) {
                console.error('Error al iniciar AR:', error);
                arLoadingScreen.classList.remove('active');
                showMessage('Error al iniciar AR. Revisa los permisos de cámara y ubicación.', 5000);
                navigateTo('scale');
            }
        };

        // function cleanARScene() {
            if (arScene) {
                arScene.pause();
                if(arScene.parentNode) arScene.parentNode.removeChild(arScene);
                arScene = null;
            }
            window.removeEventListener('gps-camera-update-position', onGPSUpdate);
            modelLoaded = false;
            arModel = null;
            
            // Limpiar también la sesión WebXR si existe
            if (appState.arSession) {
                try { appState.arSession.end(); } catch(e) { console.warn("Error al cerrar sesión WebXR", e); }
                appState.arSession = null;
                appState.hitTestSource = null;
            }
        }

        // function initializeARScene() {
            const arSceneContainer = document.getElementById('ar-scene-container');
            arSceneContainer.innerHTML = '';
            
            const targetCoords = appState.arTargetCoords || appState.coords;
            
            document.getElementById('model-lat').textContent = targetCoords.latitude.toFixed(6);
            document.getElementById('model-lon').textContent = targetCoords.longitude.toFixed(6);
            document.getElementById('model-height').textContent = appState.realDimensions.groundHeight.toFixed(1) + 'm';

            arSceneContainer.innerHTML = `
                <a-scene
                    id="ar-scene"
                    embedded
                    vr-mode-ui="enabled: false"
                    renderer="logarithmicDepthBuffer: true; antialias: true; precision: high; alpha: true;"
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
                    
                    <a-camera id="ar-camera" gps-camera="minDistance: 5;" rotation-reader></a-camera>

                    <a-entity
                        id="arch-model"
                        gltf-model="url(${appState.modelURL})"
                        gps-entity-place="latitude: ${targetCoords.latitude}; longitude: ${targetCoords.longitude};"
                        position="0 ${appState.realDimensions.groundHeight} 0"
                        scale="1 1 1"
                        animation-mixer
                        visible="false">
                    </a-entity>
                </a-scene>
            `;

            arScene = document.querySelector('#ar-scene');
            arCamera = document.querySelector('#ar-camera');
            arModel = document.querySelector('#arch-model'); // Este es el modelo GPS
            
            arScene.addEventListener('loaded', () => {
                window.addEventListener('gps-camera-update-position', onGPSUpdate);
                arModel.addEventListener('model-loaded', onModelLoaded);
                
                initHeightSlider();
                initScaleGestures();
            });
        }
        
        // function onGPSUpdate(event) {
            appState.currentGPSLocation = event.detail.position;
            const { latitude, longitude, accuracy } = appState.currentGPSLocation;

            document.getElementById('gps-status').textContent = 'Activo';
            document.getElementById('gps-accuracy').textContent = accuracy.toFixed(1);
            
            if (modelLoaded) {
                // Actualizar panel de distancia
                const targetCoords = appState.arTargetCoords || appState.coords;
                const distance = calculateDistance(
                    appState.currentGPSLocation.latitude, appState.currentGPSLocation.longitude,
                    targetCoords.latitude, targetCoords.longitude
                );
                document.getElementById('model-distance').textContent = `${distance.toFixed(1)}m`;
            }
        }

        // // function updateModelPosition() { ... }

        // function onModelLoaded() {
            modelLoaded = true;
            const modelObj = arModel.getObject3D('gltf');
            const bbox = new THREE.Box3().setFromObject(modelObj);
            const size = bbox.getSize(new THREE.Vector3());
            
            // Evitar división por cero si el modelo no tiene dimensiones
            if(size.x === 0) size.x = 1;
            if(size.y === 0) size.y = 1;
            if(size.z === 0) size.z = 1;
            
            appState.modelBounds = { width: size.x, height: size.y, length: size.z };
            
            updateModelScale(appState.initialARScale);
            arModel.setAttribute('visible', 'true');
        }

        // function initHeightSlider() {
            const heightSlider = document.getElementById('height-slider');
            const heightValue = document.getElementById('height-value');
            
            // Sincronizar con el valor inicial de groundHeight
            appState.modelHeight = appState.realDimensions.groundHeight;
            heightSlider.value = appState.modelHeight;
            heightValue.textContent = `${appState.modelHeight.toFixed(1)}m`;

            heightSlider.addEventListener('input', (e) => {
                appState.modelHeight = parseFloat(e.target.value);
                heightValue.textContent = `${appState.modelHeight.toFixed(1)}m`;
                
                if (arModel && !appState.surfaceMode) { // Solo afectar al modelo GPS
                    // Actualizar la posición Y del modelo directamente
                    const currentPos = arModel.getAttribute('position') || {x: 0, y: 0, z: 0};
                    arModel.setAttribute('position', { x: currentPos.x, y: appState.modelHeight, z: currentPos.z });
                }
            });
        }

        function initScaleGestures() {
            let initialDistance = 0;
            let currentScale = 1;

            arScene.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialDistance = getTouchDistance(e.touches[0], e.touches[1]);
                    // Leer escala del modelo correcto
                    const model = appState.surfaceMode ? appState.surfaceModel : arModel;
                    if(model) currentScale = model.object3D.scale.x; 
                }
            });

            arScene.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    const newDistance = getTouchDistance(e.touches[0], e.touches[1]);
                    const scaleFactor = newDistance / initialDistance;
                    // Escalar multiplicando por el factor base, no por la escala del GLB
                    updateModelScale(currentScale * scaleFactor, false); 
                }
            });

            function getTouchDistance(t1, t2) {
                const dx = t1.pageX - t2.pageX;
                const dy = t1.pageY - t2.pageY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        }

        document.getElementById('scale-input').addEventListener('input', (e) => {
            const scale = parseFloat(e.target.value);
            if (!isNaN(scale)) updateModelScale(scale);
        });
        document.getElementById('ar-scale-slider').addEventListener('input', (e) => {
            updateModelScale(parseFloat(e.target.value));
        });
        
        // function updateModelScale(scale, fromInput = true) {
            if (!modelLoaded || !appState.modelBounds) return;
            
            // Determinar qué modelo escalar
            const modelToScale = appState.surfaceMode ? appState.surfaceModel : arModel;
            if (!modelToScale) return;
            
            scale = Math.max(0.1, Math.min(scale, 10.0));
            
            const { width, height, length } = appState.modelBounds;
            if(width === 0 || height === 0 || length === 0) return; // Evitar división por cero
            
            // La escala se basa en la dimensión REAL deseada dividida por la dimensión ORIGINAL del GLB,
            // multiplicada por el slider (scale).
            const scaleX = (appState.realDimensions.width / width) * scale;
            const scaleY = (appState.realDimensions.height / height) * scale;
            const scaleZ = (appState.realDimensions.length / length) * scale;

            modelToScale.setAttribute('scale', `${scaleX} ${scaleY} ${scaleZ}`);

            document.getElementById('current-scale').textContent = scale.toFixed(1) + 'x';
            if(fromInput) {
                document.getElementById('scale-input').value = scale.toFixed(1);
                document.getElementById('ar-scale-slider').value = scale;
            }
            
            // Si las guías están activas, volver a dibujarlas con la nueva escala
            if(appState.showGuides) {
                showDistanceGuides();
            }
        }
        
        document.getElementById('toggle-guides-btn').addEventListener('click', () => {
            appState.showGuides = !appState.showGuides;
            document.getElementById('toggle-guides-btn').textContent = appState.showGuides ? 'Ocultar Guías' : 'Mostrar Guías';
            if (appState.showGuides) showDistanceGuides();
            else hideDistanceGuides();
        });

        // function showDistanceGuides() {
            if (!modelLoaded) return;
            hideDistanceGuides(); // Limpia guías anteriores

            // Determinar en qué modelo dibujar las guías
            const parentModel = appState.surfaceMode ? appState.surfaceModel : arModel;
            if (!parentModel) return;

            const { width, height, length } = appState.realDimensions;
            
            // 1. Crear el Bounding Box (caja de guías)
            const guideBox = document.createElement('a-box');
            guideBox.setAttribute('width', width);
            guideBox.setAttribute('height', height);
            guideBox.setAttribute('depth', length);
            guideBox.setAttribute('position', `0 ${height / 2} 0`); // Centrar la caja en el modelo
            guideBox.setAttribute('material', 'wireframe: true; color: #FFFFFF; wireframeLinewidth: 2;');
            
            parentModel.appendChild(guideBox);
            guideEntities.push(guideBox);

            // 2. Crear etiquetas de texto (A-Text)
            const textScaleVal = Math.max(width, height, length) * 0.2; // Escala de texto dinámica
            const textScale = `${textScaleVal} ${textScaleVal} ${textScaleVal}`;
            const textWidth = textScaleVal * 4; // Ancho del contenedor de texto

            // Etiqueta de LARGO (Eje Z, Rojo)
            const lengthLabel = document.createElement('a-text');
            const lengthInCm = (length * 100).toFixed(0);
            lengthLabel.setAttribute('value', `Largo: ${length.toFixed(2)}m (${lengthInCm}cm)`);
            lengthLabel.setAttribute('position', `0 ${height / 2} ${length / 2 + textScaleVal * 0.5}`); 
            lengthLabel.setAttribute('align', 'center');
            lengthLabel.setAttribute('color', '#FF5555');
            lengthLabel.setAttribute('width', textWidth);
            lengthLabel.setAttribute('scale', textScale);
            lengthLabel.setAttribute('look-at', '#ar-camera'); 
            
            parentModel.appendChild(lengthLabel);
            guideEntities.push(lengthLabel);

            // Etiqueta de ALTO (Eje Y, Verde)
            const heightLabel = document.createElement('a-text');
            const heightInCm = (height * 100).toFixed(0);
            heightLabel.setAttribute('value', `Alto: ${height.toFixed(2)}m (${heightInCm}cm)`);
            heightLabel.setAttribute('position', `0 ${height + textScaleVal * 0.5} 0`);
            heightLabel.setAttribute('align', 'center');
            heightLabel.setAttribute('color', '#55FF55');
            heightLabel.setAttribute('width', textWidth);
            heightLabel.setAttribute('scale', textScale);
            heightLabel.setAttribute('look-at', '#ar-camera');

            parentModel.appendChild(heightLabel);
            guideEntities.push(heightLabel);

            // Etiqueta de ANCHO (Eje X, Azul)
            const widthLabel = document.createElement('a-text');
            const widthInCm = (width * 100).toFixed(0);
            widthLabel.setAttribute('value', `Ancho: ${width.toFixed(2)}m (${widthInCm}cm)`);
            widthLabel.setAttribute('position', `${width / 2 + textScaleVal * 0.5} ${height / 2} 0`); 
            widthLabel.setAttribute('align', 'left');
            widthLabel.setAttribute('color', '#5555FF');
            widthLabel.setAttribute('width', textWidth);
            widthLabel.setAttribute('scale', textScale);
            widthLabel.setAttribute('look-at', '#ar-camera');

            parentModel.appendChild(widthLabel);
            guideEntities.push(widthLabel);
        }

        function hideDistanceGuides() {
            guideEntities.forEach(entity => {
                if(entity.parentNode) entity.parentNode.removeChild(entity)
            });
            guideEntities = [];
        }
        
        // document.getElementById('toggle-surface-mode-btn').addEventListener('click', () => {
            appState.surfaceMode = !appState.surfaceMode;
            cleanARScene(); // Limpiar la escena actual (GPS o WebXR)
            
            if (appState.surfaceMode) {
                // Iniciar modo superficie (WebXR)
                startSurfaceMode();
                document.getElementById('toggle-surface-mode-btn').textContent = 'Modo GPS';
                document.getElementById('gps-indicator').style.display = 'none'; // Ocultar UI de GPS
                document.getElementById('model-coords-panel').style.display = 'none';
            } else {
                // Volver a modo GPS (AR.js)
                initializeARScene(); // Reinicia la escena GPS
                document.getElementById('toggle-surface-mode-btn').textContent = 'Modo Superficie';
                document.getElementById('gps-indicator').style.display = 'flex'; // Mostrar UI de GPS
                document.getElementById('model-coords-panel').style.display = 'block';
            }
        });

        // async function startSurfaceMode() {
            const arSceneContainer = document.getElementById('ar-scene-container');
            arSceneContainer.innerHTML = ''; // Limpiar
            
            // Crear nueva escena para WebXR
            arSceneContainer.innerHTML = `
                <a-scene
                    id="ar-scene"
                    webxr="optionalFeatures: hit-test, local-floor, dom-overlay; overlayElement: #ar-page;"
                    renderer="logarithmicDepthBuffer: true; antialias: true; precision: high; alpha: true;"
                    style="background: transparent;"
                    webxr-tick> <a-camera id="ar-camera" position="0 1.6 0"></a-camera>

                    <a-entity
                        id="surface-model"
                        gltf-model="url(${appState.modelURL})"
                        scale="1 1 1"
                        visible="false">
                    </a-entity>
                    
                    <a-entity
                        id="reticle"
                        geometry="primitive: ring; radiusInner: 0.1; radiusOuter: 0.15;"
                        material="color: #4CAF50; shader: flat;"
                        rotation="-90 0 0"
                        visible="false">
                    </a-entity>

                    <a-light type="ambient" color="#FFF" intensity="1.5"></a-light>
                    <a-light type="directional" color="#FFF" intensity="0.8" position="-0.5 1 1"></a-light>
                </a-scene>
            `;

            arScene = document.getElementById('ar-scene');
            arCamera = document.getElementById('ar-camera');
            appState.surfaceModel = document.getElementById('surface-model'); // Modelo de superficie
            appState.reticle = document.getElementById('reticle');
            modelLoaded = true; // Asumimos que el modelo ya está cargado en caché

            showMessage('Modo Superficie. Mueve el teléfono para detectar el suelo y toca para colocar.', 5000);
            
            arScene.addEventListener('loaded', () => {
                // Forzar entrada a WebXR
                setTimeout(() => {
                    arScene.enterVR().catch(e => {
                        console.error("No se pudo entrar a WebXR:", e);
                        showMessage("Error: No se pudo iniciar el modo WebXR. ¿Tu navegador es compatible?", 5000);
                        // Revertir
                        appState.surfaceMode = false;
                        cleanARScene();
                        initializeARScene();
                        document.getElementById('toggle-surface-mode-btn').textContent = 'Modo Superficie';
                    });
                }, 500);
                
                arScene.addEventListener('enter-vr', onEnterWebXR);
                arScene.addEventListener('exit-vr', onExitWebXR);
            });
        }

        // function onEnterWebXR() {
            appState.arSession = arScene.renderer.xr.getSession();
            
            appState.arSession.requestReferenceSpace('local-floor').then((refSpace) => {
                appState.arSession.requestHitTestSource({ space: refSpace }).then((source) => {
                    appState.hitTestSource = source;
                });
            }).catch(e => {
                console.error("Error al obtener refSpace 'local-floor':", e);
                // Fallback a 'local' si 'local-floor' falla
                appState.arSession.requestReferenceSpace('local').then((refSpace) => {
                    appState.arSession.requestHitTestSource({ space: refSpace }).then((source) => {
                        appState.hitTestSource = source;
                    });
                });
            });

            // Tocar para colocar
            appState.arSession.addEventListener('select', onSelectWebXR);
        }

        function onExitWebXR() {
            if (appState.hitTestSource) appState.hitTestSource.cancel();
            appState.hitTestSource = null;
            appState.arSession = null;
            if (appState.reticle) appState.reticle.setAttribute('visible', 'false');
        }

        function onSelectWebXR() {
            if (appState.reticle && appState.reticle.getAttribute('visible') && appState.surfaceModel) {
                const model = appState.surfaceModel;
                model.setAttribute('visible', 'true');
                model.object3D.position.copy(appState.reticle.object3D.position);
                model.object3D.quaternion.copy(appState.reticle.object3D.quaternion);
                
                // Aplicar la escala real (usando la función que ya teníamos)
                updateModelScale(appState.initialARScale); 

                // Si las guías estaban activadas, dibujarlas en el nuevo modelo
                if (appState.showGuides) {
                    showDistanceGuides();
                }
            }
        }
        // document.getElementById('back-to-scale-btn').addEventListener('click', () => {
            cleanARScene();
            navigateTo('scale');
        });
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // in metres
        }
        
        function updateLoadingScreen(step, progress, status) {
            loadingProgressBar.style.width = `${progress}%`;
            loadingStatusText.textContent = status;
            
            const steps = ['step-libraries', 'step-permissions', 'step-camera', 'step-gps', 'step-model', 'step-complete'];
            const currentStepIndex = steps.indexOf(step);
            
            steps.forEach((stepId, index) => {
                const stepElement = document.getElementById(stepId);
                const iconElement = stepElement.querySelector('.step-icon');
                
                if (index < currentStepIndex) {
                    iconElement.textContent = '✅';
                    iconElement.className = 'step-icon completed';
                } else if (index === currentStepIndex) {
                    iconElement.textContent = '⏳';
                    iconElement.className = 'step-icon active';
                } else {
                    iconElement.textContent = '⏳';
                    iconElement.className = 'step-icon';
                }
            });
        }
        function loadScaleSettings() {
            document.getElementById('real-width-input').value = appState.realDimensions.width;
            document.getElementById('real-length-input').value = appState.realDimensions.length;
            document.getElementById('real-height-input').value = appState.realDimensions.height;
            document.getElementById('ground-height-input').value = appState.realDimensions.groundHeight;
            document.getElementById('initial-ar-scale-slider').value = appState.initialARScale;
            document.getElementById('initial-scale-value').textContent = `${appState.initialARScale.toFixed(1)}x`;
        }
         function saveScaleSettings() {
            appState.realDimensions.width = parseFloat(document.getElementById('real-width-input').value) || 10.0;
            appState.realDimensions.length = parseFloat(document.getElementById('real-length-input').value) || 15.0;
            appState.realDimensions.height = parseFloat(document.getElementById('real-height-input').value) || 3.0;
            appState.realDimensions.groundHeight = parseFloat(document.getElementById('ground-height-input').value) || 0.0;
            appState.initialARScale = parseFloat(document.getElementById('initial-ar-scale-slider').value) || 1.0;
            appState.modelHeight = appState.realDimensions.groundHeight;
        }
        function addEventListeners() {
            document.getElementById('load-data-btn').addEventListener('click', saveData);
            document.getElementById('goto-map-btn').addEventListener('click', () => navigateTo('map'));
            document.getElementById('clear-cache-btn').addEventListener('click', clearData);
            document.getElementById('use-location-btn').addEventListener('click', getCurrentLocation);
            document.getElementById('back-to-setup-from-map-btn').addEventListener('click', () => navigateTo('upload'));
            document.getElementById('apply-coords-btn').addEventListener('click', applyMapCoords);
            document.getElementById('goto-scale-btn').addEventListener('click', () => navigateTo('scale'));
            document.getElementById('jumpto-btn').addEventListener('click', jumpToCoords);
            document.getElementById('back-to-map-from-scale-btn').addEventListener('click', () => navigateTo('map'));
        }
        
        async function saveData() {
            const modelFile = document.getElementById('model-upload').files[0];
            const lat = parseFloat(document.getElementById('latitude-input').value);
            const lon = parseFloat(document.getElementById('longitude-input').value);
            if (!modelFile && !appState.modelURL) {
                 showMessage("Por favor, selecciona un modelo 3D.", 3000);
                return;
            }
            if (isNaN(lat) || isNaN(lon)) {
                showMessage("Por favor, especifica latitud y longitud válidas.", 3000);
                return;
            }
            
            if(modelFile) {
                 appState.modelURL = URL.createObjectURL(modelFile);
            }
            
            appState.coords = { latitude: lat, longitude: lon };

            document.getElementById('goto-map-btn').disabled = false;
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('status-section').classList.remove('hidden');
            showMessage("Datos cargados. ¡Listo para ver en el mapa!", 2000);
        }

        function clearData() {
            appState.modelURL = null;
            appState.coords = null;
            appState.arTargetCoords = null;
            
            document.getElementById('model-upload').value = '';
            document.getElementById('file-name-display').value = 'Ningún archivo seleccionado';
            document.getElementById('latitude-input').value = '';
            document.getElementById('longitude-input').value = '';
            
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('status-section').classList.add('hidden');
            document.getElementById('goto-map-btn').disabled = true;

            showMessage("Datos limpiados. La página se recargará.", 2000);
            setTimeout(() => window.location.reload(), 2000);
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showMessage("La geolocalización no es compatible con tu navegador.", 3000);
                return;
            }
            showMessage("Obteniendo ubicación...", 2000);
            navigator.geolocation.getCurrentPosition(position => {
                document.getElementById('latitude-input').value = position.coords.latitude.toFixed(6);
                document.getElementById('longitude-input').value = position.coords.longitude.toFixed(6);
                showMessage("Ubicación actual obtenida.", 2000);
            }, () => showMessage("No se pudo obtener la ubicación. Revisa los permisos.", 3000));
        }
        function applyMapCoords() {
            if(!map) return;
            const center = map.getCenter();
            appState.arTargetCoords = { latitude: center.lat, longitude: center.lng };
            showMessage(`Nuevas coordenadas aplicadas: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`, 3000);
        }
        function jumpToCoords() {
             const lat = parseFloat(document.getElementById('jumpto-lat').value);
            const lon = parseFloat(document.getElementById('jumpto-lon').value);
            if (!isNaN(lat) && !isNaN(lon) && map) map.setView([lat, lon], map.getZoom());
        }
        function initMapAndPreview() {
            if (map || !appState.modelURL || !appState.coords) return;
            
            const targetCoords = appState.arTargetCoords || appState.coords;
            map = L.map('map-canvas').setView([targetCoords.latitude, targetCoords.longitude], 18);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                 attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

             // Preview logic can be added here if needed
        }
        
        async function initializeApp() {
            document.getElementById('version-display').textContent = `v${APP_VERSION}`;
            addEventListeners();
        }

        initializeApp();

    </script>
</body>
</html>
