<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visor AR Arquitectura por Geolocalización</title>
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame y AR.js se cargarán dinámicamente -->
    <script>
        // Variable global para controlar cuándo cargar A-Frame y AR.js
        let arLibrariesLoaded = false;

        // Función para cargar las bibliotecas de AR dinámicamente
        function loadARLibraries() {
            if (arLibrariesLoaded) return Promise.resolve();
            
            return new Promise((resolve) => {
                const aframeScript = document.createElement('script');
                aframeScript.src = 'https://aframe.io/releases/1.3.0/aframe.min.js';
                document.head.appendChild(aframeScript);
                
                aframeScript.onload = () => {
                    const arjsScript = document.createElement('script');
                    arjsScript.src = 'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js';
                    document.head.appendChild(arjsScript);
                    
                    arjsScript.onload = () => {
                        arLibrariesLoaded = true;
                        resolve();
                    };
                };
            });
        }
    </script>
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
            }
        }
    </script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
        }
        .page {
            display: none;
            height: 100%;
            width: 100%;
            position: relative;
        }
        .page.active {
            display: block;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .control-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .control-button:hover {
            background-color: #45a049;
        }
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #message-box.show {
            opacity: 1;
        }
        #map-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }
        #map-canvas {
            width: 100%; height: 100%; z-index: 1;
        }
        #model-preview-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 401;
        }
        .map-ui-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 300px;
        }
        #map-controls {
            position: fixed;
            top: 70px; right: 20px; z-index: 402;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #map-crosshair {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 30px; height: 30px; border: 2px solid white;
            border-radius: 50%; box-shadow: 0 0 10px black;
            pointer-events: none; z-index: 402;
        }
        #coords-jumpto {
            position: fixed; top: 20px; left: 20px; z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px; border-radius: 8px;
            display: flex; gap: 5px; align-items: center;
        }
        a-scene {
            position: absolute !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important; z-index: 1 !important;
        }
        .arjs-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); color: white;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.5rem; z-index: 10000; text-align: center;
        }
        .permission-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; justify-content: center; align-items: center; z-index: 10001;
        }
        .permission-content {
            background-color: white; padding: 20px; border-radius: 10px;
            max-width: 80%; text-align: center;
        }
        .permission-button {
            background-color: #4CAF50; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px;
        }
        #ar-controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; display: flex; gap: 10px;
        }
        .ar-info-panel {
            position: fixed; top: 20px; left: 20px;
            background-color: rgba(0,0,0,0.7); color: white;
            padding: 10px; border-radius: 8px; font-size: 14px;
            z-index: 9998;
        }
        .ar-scale-control {
            position: fixed; top: 20px; right: 20px;
            background-color: rgba(0,0,0,0.7); color: white;
            padding: 10px; border-radius: 8px; z-index: 9998;
        }
        .ar-scale-slider { width: 150px; }
        
        /* Estilos para el indicador de proximidad */
        .proximity-indicator {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9997;
            text-align: center;
            display: none;
        }
        .proximity-indicator.active {
            display: block;
        }
        .proximity-indicator.far {
            background-color: rgba(244, 67, 54, 0.7);
        }
        .proximity-indicator.near {
            background-color: rgba(255, 193, 7, 0.7);
        }
        .proximity-indicator.very-near {
            background-color: rgba(76, 175, 80, 0.7);
        }
        
        /* Estilos para el portal de proximidad */
        .ar-portal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9996;
            display: none;
        }
        .ar-portal.active {
            display: block;
        }
        .ar-portal-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 2px dashed rgba(255, 255, 255, 0.8);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(0.95); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.05); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(0.95); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- PÁGINA 1: Carga de Archivos y Coordenadas -->
    <div id="upload-page" class="page active">
        <div class="flex items-center justify-center h-full bg-gray-100">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Configuración de Escena AR<span id="version-display" class="text-sm align-middle font-normal text-gray-400 ml-2"></span></h1>
                <div id="upload-section" class="space-y-4">
                    <div>
                        <label for="model-upload" class="block mb-2 text-sm font-medium text-gray-700">1. Subir Modelo 3D (.glb)</label>
                        <input type="file" id="model-upload" accept=".glb" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="latitude-input" class="block mb-2 text-sm font-medium text-gray-700">2. Latitud</label>
                            <input type="number" id="latitude-input" placeholder="Ej: 4.0950" step="any" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label for="longitude-input" class="block mb-2 text-sm font-medium text-gray-700">3. Longitud</label>
                            <input type="number" id="longitude-input" placeholder="Ej: -76.1950" step="any" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    <button id="use-location-btn" class="w-full text-sm text-blue-500 hover:underline text-left pt-1">Usar mi ubicación actual</button>
                </div>
                <div id="status-section" class="mt-6 text-center hidden">
                    <p id="status-text" class="text-lg font-semibold text-green-600">Modelo y ubicación cargados desde caché.</p>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
                    <button id="load-data-btn" class="control-button bg-green-500 hover:bg-green-600 w-full sm:w-auto">Cargar y Guardar</button>
                    <button id="goto-map-btn" class="control-button bg-indigo-500 hover:bg-indigo-600 w-full sm:w-auto" disabled>Ver en Mapa</button>
                </div>
                <div class="mt-4 text-center">
                    <button id="clear-cache-btn" class="text-sm text-red-500 hover:underline">Limpiar Caché y Recargar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PÁGINA 2: Vista de Mapa -->
    <div id="map-page" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <div id="map-crosshair"></div>
            <canvas id="model-preview-canvas"></canvas>
        </div>
        <div id="coords-jumpto">
            <input type="number" id="jumpto-lat" placeholder="Latitud" class="w-24 p-1 border rounded text-sm">
            <input type="number" id="jumpto-lon" placeholder="Longitud" class="w-24 p-1 border rounded text-sm">
            <button id="jumpto-btn" class="control-button bg-blue-500 hover:bg-blue-600 p-2 text-sm">Ir</button>
        </div>
        <div id="map-controls">
            <button id="back-to-setup-from-map-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver</button>
            <button id="goto-scale-btn" class="control-button bg-purple-500 hover:bg-purple-600">Configurar Escala</button>
        </div>
        <div class="map-ui-container">
            <div class="slider-container">
                <label for="map-zoom-slider" class="block text-sm font-medium text-gray-700">Zoom del Mapa</label>
                <input id="map-zoom-slider" type="range" min="1" max="22" value="18" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="slider-container">
                <label for="map-scale-slider" class="block text-sm font-medium text-gray-700">Escala Previsualización</label>
                <input id="map-scale-slider" type="range" min="1" max="200" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
    </div>

    <!-- PÁGINA 3: Configuración de Escala -->
    <div id="scale-page" class="page">
        <div class="flex items-center justify-center h-full bg-gray-100">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Configuración de Escala Real</h1>
                <div class="space-y-4">
                    <div class="scale-input-group">
                        <label class="scale-label">Ancho real (m):</label>
                        <input type="number" id="real-width-input" class="scale-input" placeholder="10.0" step="0.1" min="0.1">
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Largo real (m):</label>
                        <input type="number" id="real-length-input" class="scale-input" placeholder="15.0" step="0.1" min="0.1">
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Alto real (m):</label>
                        <input type="number" id="real-height-input" class="scale-input" placeholder="3.0" step="0.1" min="0.1">
                    </div>
                    <div class="scale-input-group">
                        <label class="scale-label">Altura sobre terreno (m):</label>
                        <input type="number" id="ground-height-input" class="scale-input" placeholder="0.0" step="0.1">
                    </div>
                    <!-- Nuevo control para la distancia de visualización -->
                    <div class="scale-input-group">
                        <label class="scale-label">Distancia de Visualización (m):</label>
                        <input type="number" id="ar-distance-input" class="scale-input" placeholder="20.0" step="5" min="5" max="100">
                    </div>
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-800">
                            <strong>Nota:</strong> "Distancia de Visualización" ajusta a qué distancia aparecerá el modelo 3D en la vista AR.
                        </p>
                    </div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
                    <button id="back-to-map-from-scale-btn" class="control-button bg-gray-500 hover:bg-gray-600 w-full sm:w-auto">Volver al Mapa</button>
                    <button id="goto-ar-from-scale-btn" class="control-button bg-green-500 hover:bg-green-600 w-full sm:w-auto">Iniciar AR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PÁGINA 4: Vista de Realidad Aumentada -->
    <div id="ar-page" class="page">
        <div class="arjs-loader">
            <div>
                <div class="loader"></div>
                <p id="ar-loading-text">Iniciando...</p>
            </div>
        </div>
        <div id="ar-scene-container"></div>
        <div class="ar-info-panel">
            <div><strong>GPS:</strong> <span id="gps-status">Buscando...</span></div>
            <div><strong>Precisión:</strong> <span id="gps-accuracy">--</span>m</div>
            <div><strong>Escala:</strong> <span id="current-scale">1.0</span>x</div>
            <div><strong>Distancia:</strong> <span id="current-distance">20</span>m</div>
        </div>
        <div class="ar-scale-control">
            <label for="ar-scale-slider" class="text-sm">Escala</label>
            <input id="ar-scale-slider" type="range" min="0.1" max="5" step="0.1" value="1" class="ar-scale-slider">
        </div>
        <div id="ar-controls">
            <button id="back-to-scale-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver</button>
            <button id="reset-position-btn" class="control-button bg-blue-500 hover:bg-blue-600">Resetear</button>
        </div>
        
        <!-- Indicador de proximidad -->
        <div id="proximity-indicator" class="proximity-indicator">
            <div id="proximity-text">Estás lejos del modelo</div>
            <div id="proximity-distance">Distancia: -- m</div>
        </div>
        
        <!-- Portal de proximidad -->
        <div id="ar-portal" class="ar-portal">
            <div class="ar-portal-circle"></div>
        </div>
    </div>

    <!-- Modal para solicitar permisos -->
    <div id="permission-modal" class="permission-modal">
        <div class="permission-content">
            <h2>Permisos necesarios</h2>
            <p>Esta aplicación necesita acceso a tu cámara y ubicación para la experiencia de Realidad Aumentada.</p>
            <button id="grant-permissions-btn" class="permission-button">Conceder Permisos</button>
        </div>
    </div>

    <div id="message-box"></div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        /*
         * =================================================================================
         * REGLA DE VERSIÓN - NO BORRAR
         * =================================================================================
         * Cada vez que se realice CUALQUIER cambio, corrección o mejora en este código,
         * es OBLIGATORIO incrementar el número de versión en la constante 'APP_VERSION'
         * que se encuentra más abajo.
         *
         * Ejemplo: Si la versión actual es '4.5', la siguiente versión debe ser '4.6'.
         *
         * Esto es crucial para el seguimiento de cambios, la depuración y para asegurar
         * que los usuarios siempre tengan la versión más actualizada y sin errores.
         * =================================================================================
         */
        const APP_VERSION = '4.6';
        const CACHE_NAME = 'geo-ar-cache-v26';
        let appState = {
            modelURL: null,
            coords: null,
            realDimensions: { width: 10.0, length: 15.0, height: 3.0, groundHeight: 0.0 },
            arDistance: 20.0, // Nueva propiedad para la distancia de visualización
            mapScale: 50
        };
        let map, modelPreview = {
            renderer: null,
            scene: null,
            camera: null,
            model: null,
            animationFrameId: null,
            isRotating: false,
            isTwoFingerRotating: false,
            previousMousePosition: { x: 0, y: 0 },
            previousTouchAngle: 0,
            maxSize: 1
        };

        // Variables para el control de la escena AR
        let arScene = null;
        let arCamera = null;
        let arModel = null;
        let gpsWatchId = null;
        let modelLoaded = false;
        let gpsInitialized = false;
        let userPosition = null; // Nueva variable para rastrear la posición del usuario

        const pages = {
            upload: document.getElementById('upload-page'),
            map: document.getElementById('map-page'),
            scale: document.getElementById('scale-page'),
            ar: document.getElementById('ar-page')
        };
        const messageBox = document.getElementById('message-box');
        const arLoader = document.querySelector('.arjs-loader');
        const permissionModal = document.getElementById('permission-modal');
        const arLoadingText = document.getElementById('ar-loading-text');
        const proximityIndicator = document.getElementById('proximity-indicator');
        const proximityText = document.getElementById('proximity-text');
        const proximityDistance = document.getElementById('proximity-distance');
        const arPortal = document.getElementById('ar-portal');

        function showMessage(msg, duration = 3000) {
            messageBox.textContent = msg;
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), duration);
        }

        function navigateTo(pageName) {
            Object.values(pages).forEach(p => p.classList.remove('active'));
            pages[pageName].classList.add('active');
            
            if (pageName === 'map') {
                setTimeout(() => {
                    initMapAndPreview();
                    if (map) map.invalidateSize();
                }, 100);
            } else if (pageName === 'scale') {
                loadScaleSettings();
            } else {
                if (map) { map.remove(); map = null; }
                if (modelPreview.animationFrameId) {
                    cancelAnimationFrame(modelPreview.animationFrameId);
                    modelPreview.animationFrameId = null;
                }
            }
        }

        async function startARFlow() {
            saveScaleSettings();
            navigateTo('ar');
            permissionModal.style.display = 'flex';
        }

        document.getElementById('grant-permissions-btn').onclick = async () => {
            permissionModal.style.display = 'none';
            arLoader.style.display = 'flex';
            arLoadingText.textContent = 'Cargando bibliotecas AR...';

            try {
                await loadARLibraries();
                arLoadingText.textContent = 'Solicitando permisos de cámara y GPS...';

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                stream.getTracks().forEach(track => track.stop());

                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { 
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                arLoadingText.textContent = 'Permisos concedidos. Iniciando AR...';
                initializeARScene();

            } catch (error) {
                console.error('Error al solicitar permisos:', error);
                arLoader.style.display = 'none';
                let userMessage = 'Error al solicitar permisos.';
                if (error.name === "NotFoundError" || error.name === "DevicesNotFoundError") {
                    userMessage = "No se encontró una cámara trasera.";
                } else if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
                    userMessage = "Acceso a cámara y GPS denegado. Habilítalos en los ajustes de tu navegador.";
                }
                showMessage(userMessage, 5000);
                navigateTo('scale');
            }
        };

        function initializeARScene() {
            const arSceneContainer = document.getElementById('ar-scene-container');
            arSceneContainer.innerHTML = `
                <a-scene id="ar-scene" embedded vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true;" arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;">
                    <a-camera gps-camera="minDistance: 1;" rotation-reader></a-camera>
                    <a-entity id="arch-model" gltf-model="url(${appState.modelURL})" gps-entity-place="latitude: ${appState.coords.latitude}; longitude: ${appState.coords.longitude};" position="0 ${appState.realDimensions.groundHeight} 0" scale="1 1 1"></a-entity>
                    <a-light type="ambient" color="#BBB"></a-light>
                    <a-light type="directional" color="#FFF" intensity="0.6" position="-0.5 1 1"></a-light>
                </a-scene>`;

            const sceneEl = document.querySelector('a-scene');
            sceneEl.addEventListener('loaded', () => {
                window.addEventListener('gps-camera-update-position', (event) => {
                    arLoader.style.display = 'none';
                    const pos = event.detail.position;
                    document.getElementById('gps-status').textContent = 'Activo';
                    document.getElementById('gps-accuracy').textContent = pos.accuracy.toFixed(1);
                    userPosition = { latitude: pos.latitude, longitude: pos.longitude };
                    updateProximityIndicator();
                    adjustModelScale();
                });
            });
        }
        
        function updateProximityIndicator() {
            if (!userPosition || !appState.coords) return;
            
            // Calcular distancia entre el usuario y el modelo
            const distance = calculateDistance(
                userPosition.latitude, userPosition.longitude,
                appState.coords.latitude, appState.coords.longitude
            );
            
            // Actualizar indicador de proximidad
            proximityDistance.textContent = `Distancia: ${distance.toFixed(1)}m`;
            
            // Mostrar portal si está cerca
            if (distance < appState.arDistance) {
                arPortal.classList.add('active');
                proximityIndicator.classList.add('active');
                
                if (distance < appState.arDistance * 0.5) {
                    proximityIndicator.classList.add('very-near');
                    proximityText.textContent = 'Estás muy cerca del modelo';
                } else if (distance < appState.arDistance * 0.8) {
                    proximityIndicator.classList.add('near');
                    proximityText.textContent = 'Estás cerca del modelo';
                } else {
                    proximityIndicator.classList.add('far');
                    proximityText.textContent = 'Estás cerca del modelo';
                }
            } else {
                arPortal.classList.remove('active');
                proximityIndicator.classList.remove('active');
                proximityText.textContent = 'Estás lejos del modelo';
            }
        }
        
        // Función para calcular la distancia entre dos coordenadas GPS
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function adjustModelScale() {
            const modelEntity = document.querySelector('#arch-model');
            if (!modelEntity) return;
            
            modelEntity.addEventListener('model-loaded', () => {
                const obj = modelEntity.getObject3D('mesh');
                if (!obj) return;

                const box = new THREE.Box3().setFromObject(obj);
                const size = new THREE.Vector3();
                box.getSize(size);

                if(size.x === 0 || size.y === 0 || size.z === 0) return;

                const scaleX = appState.realDimensions.width / size.x;
                const scaleY = appState.realDimensions.height / size.y;
                const scaleZ = appState.realDimensions.length / size.z;
                
                modelEntity.setAttribute('scale', `${scaleX} ${scaleY} ${scaleZ}`);
            });
        }

        function stopAR() {
            const arScene = document.getElementById('ar-scene');
            if (arScene) {
                arScene.pause();
                arScene.parentNode.removeChild(arScene);
            }
            navigateTo('scale');
        }

        function loadScaleSettings() {
            document.getElementById('real-width-input').value = appState.realDimensions.width;
            document.getElementById('real-length-input').value = appState.realDimensions.length;
            document.getElementById('real-height-input').value = appState.realDimensions.height;
            document.getElementById('ground-height-input').value = appState.realDimensions.groundHeight;
            document.getElementById('ar-distance-input').value = appState.arDistance;
        }

        function saveScaleSettings() {
            appState.realDimensions.width = parseFloat(document.getElementById('real-width-input').value) || 10.0;
            appState.realDimensions.length = parseFloat(document.getElementById('real-length-input').value) || 15.0;
            appState.realDimensions.height = parseFloat(document.getElementById('real-height-input').value) || 3.0;
            appState.realDimensions.groundHeight = parseFloat(document.getElementById('ground-height-input').value) || 0.0;
            appState.arDistance = parseFloat(document.getElementById('ar-distance-input').value) || 20.0;
            showMessage('Configuración de escala guardada', 2000);
        }

        async function saveDataToCache() {
            const modelFile = document.getElementById('model-upload').files[0];
            const lat = parseFloat(document.getElementById('latitude-input').value);
            const lon = parseFloat(document.getElementById('longitude-input').value);

            if (!modelFile || isNaN(lat) || isNaN(lon)) {
                showMessage('Por favor, sube un modelo y especifica las coordenadas.');
                return;
            }
            
            showMessage('Guardando datos...');
            appState.coords = { latitude: lat, longitude: lon };
            
            try {
                const cache = await caches.open(CACHE_NAME);
                await cache.put('cached-model.glb', new Response(modelFile));
                await cache.put('cached-coords.json', new Response(JSON.stringify(appState.coords)));
                await loadDataFromCache();
            } catch (error) {
                console.error('Error al guardar en caché:', error);
                showMessage('Error al guardar datos.');
            }
        }

        async function loadDataFromCache() {
            try {
                const cache = await caches.open(CACHE_NAME);
                const [modelRes, coordsRes] = await Promise.all([
                    cache.match('cached-model.glb'),
                    cache.match('cached-coords.json')
                ]);

                if (!modelRes || !coordsRes) return false;
                
                appState.coords = await coordsRes.json();
                const modelBlob = await modelRes.blob();
                appState.modelURL = URL.createObjectURL(modelBlob);
                
                document.getElementById('upload-section').classList.add('hidden');
                document.getElementById('status-section').classList.remove('hidden');
                document.getElementById('goto-map-btn').disabled = false;
                showMessage('Datos cargados desde el caché.');
                return true;
            } catch (error) {
                console.warn('No se encontraron datos en caché:', error);
                return false;
            }
        }
        
        function clearCacheAndReload() {
            caches.delete(CACHE_NAME).then(() => {
                showMessage('Caché limpiado.');
                setTimeout(() => window.location.reload(), 1000);
            });
        }
        
        function useCurrentLocation() {
            if (!navigator.geolocation) {
                showMessage("Geolocalización no es soportada por tu navegador.");
                return;
            }
            showMessage("Obteniendo ubicación...");
            navigator.geolocation.getCurrentPosition(
                position => {
                    document.getElementById('latitude-input').value = position.coords.latitude.toFixed(6);
                    document.getElementById('longitude-input').value = position.coords.longitude.toFixed(6);
                    showMessage("Ubicación obtenida.");
                },
                () => showMessage("No se pudo obtener la ubicación. Revisa los permisos."),
                { enableHighAccuracy: true }
            );
        }

        function initMapAndPreview() {
            if (map) return;
            map = L.map('map-canvas', { zoomControl: false }).setView([appState.coords.latitude, appState.coords.longitude], 18);
            L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                maxZoom: 20, attribution: 'Google Maps'
            }).addTo(map);

            map.on('moveend', () => {
                const newCoords = map.getCenter();
                appState.coords = { latitude: newCoords.lat, longitude: newCoords.lng };
            });
            initModelPreview();
        }

        async function initModelPreview() {
            const canvas = document.getElementById('model-preview-canvas');
            const container = document.getElementById('map-container');
            modelPreview.renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
            modelPreview.renderer.setSize(container.clientWidth, container.clientHeight);
            modelPreview.renderer.setPixelRatio(window.devicePixelRatio);
            modelPreview.scene = new THREE.Scene();
            modelPreview.camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            modelPreview.camera.position.set(0, 40, 30);
            modelPreview.camera.lookAt(0, 0, 0);
            modelPreview.scene.add(new THREE.AmbientLight(0xffffff, 1.5));
            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(5, 10, 7.5);
            modelPreview.scene.add(dirLight);

            const loader = new GLTFLoader();
            const gltf = await loader.loadAsync(appState.modelURL);
            modelPreview.model = gltf.scene;
            const box = new THREE.Box3().setFromObject(modelPreview.model);
            const size = box.getSize(new THREE.Vector3());
            modelPreview.maxSize = Math.max(size.x, size.y, size.z) || 1;
            modelPreview.model.position.sub(box.getCenter(new THREE.Vector3()));
            modelPreview.scene.add(modelPreview.model);
            animateModelPreview();
        }

        function animateModelPreview() {
            modelPreview.animationFrameId = requestAnimationFrame(animateModelPreview);
            if (modelPreview.model) {
                const scale = (appState.mapScale * 0.5) / modelPreview.maxSize;
                modelPreview.model.scale.set(scale, scale, scale);
            }
            if (modelPreview.renderer) {
                modelPreview.renderer.render(modelPreview.scene, modelPreview.camera);
            }
        }
        
        // --- Event Listeners ---
        document.getElementById('load-data-btn').addEventListener('click', saveDataToCache);
        document.getElementById('clear-cache-btn').addEventListener('click', clearCacheAndReload);
        document.getElementById('goto-map-btn').addEventListener('click', () => navigateTo('map'));
        document.getElementById('use-location-btn').addEventListener('click', useCurrentLocation);
        document.getElementById('back-to-setup-from-map-btn').addEventListener('click', () => navigateTo('upload'));
        document.getElementById('goto-scale-btn').addEventListener('click', () => navigateTo('scale'));
        document.getElementById('back-to-map-from-scale-btn').addEventListener('click', () => navigateTo('map'));
        document.getElementById('goto-ar-from-scale-btn').addEventListener('click', startARFlow);
        document.getElementById('back-to-scale-btn').addEventListener('click', stopAR);
        document.getElementById('map-scale-slider').addEventListener('input', (e) => { appState.mapScale = parseFloat(e.target.value); });
        document.getElementById('map-zoom-slider').addEventListener('input', (e) => { if(map) map.setZoom(parseFloat(e.target.value)); });
        
        function initializeApp() {
            document.getElementById('version-display').textContent = `v${APP_VERSION}`;
            loadDataFromCache();
        }

        initializeApp();
    </script>
</body>
</html>


