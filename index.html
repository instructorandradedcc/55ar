<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR Constructor Cloud</title>
    <link rel="icon" type="image/png" href="https://github.com/instructorandradedcc/55ar/raw/main/favicon3dAR.png">
    
    <!-- Dependencias -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Three.js & Model Viewer -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
                "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js",
                "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
            }
        }
    </script>
    <!-- Web Component para AR de Superficie -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        /* --- Sistema Base --- */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #f3f4f6; user-select: none; -webkit-user-select: none; }
        
        /* Vistas (SPA) */
        .view-section { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; flex-direction: column; background: #fff; }
        .view-section.active { display: flex; z-index: 10; }

        /* Componentes UI */
        .btn-primary { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; font-weight: 600; padding: 12px 20px; border-radius: 12px; shadow: 0 4px 6px rgba(37,99,235,0.2); transition: 0.2s; width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { background: #f3f4f6; color: #374151; font-weight: 600; padding: 12px 20px; border-radius: 12px; border: 1px solid #e5e7eb; width: 100%; }
        .input-field { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #e5e7eb; background: #f9fafb; outline: none; transition: 0.2s; }
        .input-field:focus { border-color: #2563eb; background: #fff; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* Dashboard Cards */
        .project-card { background: white; border: 1px solid #e5e7eb; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.2s; }
        .project-card:hover { border-color: #2563eb; transform: translateY(-2px); }
        .admin-badge { background: #fef3c7; color: #d97706; font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: bold; text-transform: uppercase; }

        /* Map & AR */
        #map-canvas { flex: 1; width: 100%; z-index: 1; }
        a-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; }
        model-viewer { width: 100%; height: 100%; background-color: #222; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.3s; }
        #loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Toast */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #1f2937; color: white; padding: 10px 20px; border-radius: 50px; font-size: 14px; z-index: 10000; transition: 0.3s; display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 15px rgba(0,0,0,0.2); }
        #toast.show { transform: translateX(-50%) translateY(0); }
        
        /* Calibraci√≥n */
        .cal-hud { position: fixed; bottom: 100px; right: 16px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 16px; z-index: 100; display: none; flex-direction: column; gap: 5px; }
        .cal-hud.active { display: flex; }
        .pad-btn { width: 45px; height: 45px; background: rgba(255,255,255,0.15); color: white; border-radius: 8px; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .pad-btn:active { background: #2563eb; }

        /* Version Display (MEJORADO) */
        .version-tag { 
            position: absolute; bottom: 15px; right: 15px; 
            font-size: 11px; color: #4b5563; /* Gris m√°s oscuro */
            font-family: monospace; font-weight: bold;
            pointer-events: none; 
            background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px;
        }
    </style>
</head>
<body>

    <!-- UI GLOBAL -->
    <div id="toast"><span>‚ÑπÔ∏è</span><span id="toast-msg"></span></div>
    <div id="loader" class="hidden"><div class="spinner mb-4"></div><p id="loader-text">Cargando...</p></div>

    <!-- VISTA 1: AUTH (Login/Registro) -->
    <div id="view-auth" class="view-section justify-center items-center p-6">
        <div class="w-full max-w-sm bg-white p-8 rounded-3xl shadow-xl relative">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl shadow-lg shadow-blue-200">üèóÔ∏è</div>
                <h1 class="text-2xl font-bold text-gray-900">AR Cloud Pro</h1>
                <p class="text-sm text-gray-500">Plataforma de Gesti√≥n AR</p>
            </div>

            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">CORREO ELECTR√ìNICO</label>
                    <input type="email" id="email" class="input-field" placeholder="ejemplo@empresa.com" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">CONTRASE√ëA</label>
                    <input type="password" id="password" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <button type="submit" id="login-btn" class="btn-primary">Iniciar Sesi√≥n</button>
                <button type="button" id="register-btn" class="btn-secondary">Crear Cuenta Nueva</button>
            </form>
            <div id="guest-link-container" class="mt-6 text-center border-t pt-4">
                 <p class="text-xs text-gray-400">¬øTienes un c√≥digo de proyecto?</p>
                 <button id="guest-btn" class="text-blue-600 text-sm font-bold mt-1">Entrar como Espectador</button>
            </div>
            
            <!-- Etiqueta de Versi√≥n -->
            <div class="version-tag" id="auth-version">v...</div>
        </div>
    </div>

    <!-- VISTA 2: DASHBOARD (Lista de Proyectos) -->
    <div id="view-dashboard" class="view-section bg-gray-50">
        <div class="bg-white px-6 py-4 shadow-sm flex justify-between items-center z-20 sticky top-0">
            <div>
                <h2 class="text-lg font-bold text-gray-800">Mis Proyectos</h2>
                <p id="user-role-display" class="text-xs text-gray-400">Cargando...</p>
            </div>
            <button onclick="app.logout()" class="text-sm text-red-500 font-medium">Salir</button>
        </div>

        <div class="p-4 overflow-y-auto flex-1" id="projects-list">
            <!-- Los proyectos se inyectan aqu√≠ -->
        </div>

        <div class="p-4 bg-white border-t border-gray-100 text-center">
            <button onclick="app.newProject()" class="btn-primary shadow-xl mb-2">
                <span>+</span> Nuevo Proyecto AR
            </button>
            <!-- Etiqueta de Versi√≥n Dashboard (Color oscuro) -->
            <span class="text-xs text-gray-500 font-mono font-bold" id="dash-version">v...</span>
        </div>
    </div>

    <!-- VISTA 3: EDITOR (Subida y Mapa) -->
    <div id="view-editor" class="view-section">
        <div class="absolute top-4 left-4 z-[500]">
            <button onclick="app.navTo('dashboard')" class="bg-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center font-bold text-gray-600">‚Üê</button>
        </div>

        <!-- Paso 1: Archivo -->
        <div id="upload-overlay" class="absolute inset-0 bg-white z-[400] flex flex-col items-center justify-center p-8">
            <div class="w-full max-w-md text-center space-y-6">
                <h2 class="text-xl font-bold">Nuevo Proyecto</h2>
                <input type="text" id="project-name" placeholder="Nombre del Proyecto" class="input-field text-center font-bold">
                
                <div class="border-2 border-dashed border-blue-200 bg-blue-50 rounded-2xl p-8 cursor-pointer relative hover:bg-blue-100 transition">
                    <input type="file" id="model-input" accept=".glb,.gltf" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer">
                    <div class="text-4xl mb-2">üìÇ</div>
                    <p class="text-sm text-blue-600 font-medium">Subir Modelo 3D (.glb)</p>
                    <p id="file-name" class="text-xs text-gray-400 mt-2">M√°x 50MB</p>
                </div>

                <button onclick="app.uploadAndStart()" class="btn-primary">Configurar Ubicaci√≥n ‚Üí</button>
            </div>
        </div>

        <!-- Paso 2: Mapa -->
        <div id="map-canvas"></div>
        
        <div class="absolute bottom-0 left-0 w-full bg-white p-4 rounded-t-3xl shadow-2xl z-[401]">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="font-bold text-gray-800">Ubicaci√≥n Geogr√°fica</h3>
                    <p class="text-xs text-gray-500">Arrastra el marcador al punto cero</p>
                </div>
                <button onclick="app.useGPS()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                    üìç GPS
                </button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <div class="bg-gray-100 p-2 rounded w-1/2">
                    <span class="text-[9px] text-gray-400 font-bold">LAT</span>
                    <span id="editor-lat" class="text-xs font-mono font-bold block">0.000000</span>
                </div>
                <div class="bg-gray-100 p-2 rounded w-1/2">
                    <span class="text-[9px] text-gray-400 font-bold">LON</span>
                    <span id="editor-lon" class="text-xs font-mono font-bold block">0.000000</span>
                </div>
            </div>

            <button onclick="app.saveProjectData()" class="btn-primary bg-green-600">
                üíæ Guardar y Publicar
            </button>
        </div>
    </div>

    <!-- VISTA 4: VISOR AR -->
    <div id="view-ar" class="view-section bg-black">
        <div id="ar-gps-container" class="w-full h-full absolute top-0 left-0"></div>
        
        <div id="ar-surface-container" class="w-full h-full absolute top-0 left-0 hidden bg-gray-900">
            <model-viewer id="viewer" src="" ar ar-modes="webxr scene-viewer quick-look" camera-controls shadow-intensity="1" auto-rotate touch-action="pan-y" ar-scale="fixed" ar-placement="floor" class="w-full h-full">
                <button slot="ar-button" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 z-50">
                    üì∑ ABRIR C√ÅMARA
                </button>
            </model-viewer>
            <button onclick="app.closeSurface()" class="absolute top-4 left-4 z-50 bg-white w-10 h-10 rounded-full shadow flex items-center justify-center">‚úï</button>
        </div>

        <div class="absolute top-4 left-4 flex gap-2 pointer-events-none z-50">
            <div id="gps-badge" class="bg-black/60 backdrop-blur text-white px-3 py-1 rounded-full border border-white/10">
                <span class="text-xs font-mono">GPS: <span id="gps-acc">--</span>m</span>
            </div>
        </div>

        <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-3 z-50 w-full px-4 max-w-md pointer-events-auto">
            <button onclick="app.exitAR()" class="bg-red-500/90 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-xl">‚úï</button>
            <button onclick="app.openSurface()" class="flex-1 bg-purple-600/90 text-white font-bold py-3 rounded-full shadow-lg backdrop-blur">üè† Interior</button>
            <button id="admin-save-btn" onclick="app.saveCalibration()" class="hidden flex-1 bg-blue-600/90 text-white font-bold py-3 rounded-full shadow-lg">üíæ Guardar Ajustes</button>
            <button onclick="app.toggleCal()" class="bg-gray-700/80 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-xl">üõ†Ô∏è</button>
        </div>

        <div id="cal-hud" class="cal-hud">
            <div class="grid grid-cols-3 gap-1">
                <div></div> <button class="pad-btn" ontouchstart="app.adj('z', -0.5)" onmousedown="app.adj('z', -0.5)">‚¨ÜÔ∏è</button> <div></div>
                <button class="pad-btn" ontouchstart="app.adj('x', -0.5)" onmousedown="app.adj('x', -0.5)">‚¨ÖÔ∏è</button>
                <button class="pad-btn" ontouchstart="app.adj('z', 0.5)" onmousedown="app.adj('z', 0.5)">‚¨áÔ∏è</button>
                <button class="pad-btn" ontouchstart="app.adj('x', 0.5)" onmousedown="app.adj('x', 0.5)">‚û°Ô∏è</button>
            </div>
            <div class="flex justify-center gap-2 mt-2">
                <button class="pad-btn text-sm" ontouchstart="app.adj('y', 0.5)" onmousedown="app.adj('y', 0.5)">‚è´</button>
                <button class="pad-btn text-sm" ontouchstart="app.adj('y', -0.5)" onmousedown="app.adj('y', -0.5)">‚è¨</button>
                <button class="pad-btn text-sm" ontouchstart="app.adj('r', -5)" onmousedown="app.adj('r', -5)">‚Ü∫</button>
                <button class="pad-btn text-sm" ontouchstart="app.adj('r', 5)" onmousedown="app.adj('r', 5)">‚Üª</button>
            </div>
        </div>
    </div>

    <!-- LOGICA -->
    <script type="module">
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'firebase/auth';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, updateDoc } from 'firebase/firestore';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'firebase/storage';
        import { getAnalytics } from 'firebase/analytics';

        // --- VERSI√ìN DE LA APP ---
        const APP_VERSION = "9.02"; // Versi√≥n actualizada

        // --- CONFIGURACI√ìN ---
        const firebaseConfig = {
            apiKey: "AIzaSyD25y6TynkWwwD72sPod5cOWmq0SYPIp6I",
            authDomain: "ar-constructor-v2.firebaseapp.com",
            projectId: "ar-constructor-v2",
            storageBucket: "ar-constructor-v2.firebasestorage.app",
            messagingSenderId: "916569604582",
            appId: "1:916569604582:web:5ad942651ce8269f895627",
            measurementId: "G-ZL6T8CGKP9"
        };

        // --- ADMIN ---
        const ADMIN_EMAIL = "instructor.andrade.dcc@gmail.com"; 

        const state = {
            user: null,
            isAdmin: false,
            currentProject: null,
            tempFile: null,
            calibration: { x:0, y:0, z:0, r:0 },
            map: null
        };

        class App {
            constructor() {
                this.displayVersion();
                this.initServiceWorker();
                try {
                    const app = initializeApp(firebaseConfig);
                    this.auth = getAuth(app);
                    this.db = getFirestore(app);
                    this.storage = getStorage(app);
                    try { getAnalytics(app); } catch(e) {}
                    this.initAuthListener();
                    this.checkUrlParams();
                } catch (e) {
                    console.error(e);
                    alert("Error config Firebase: Revisa la consola");
                }
            }

            displayVersion() {
                const vText = `v${APP_VERSION}`;
                const authEl = document.getElementById('auth-version');
                const dashEl = document.getElementById('dash-version');
                if(authEl) authEl.textContent = vText;
                if(dashEl) dashEl.textContent = vText;
                console.log("AR System Init - Version:", APP_VERSION);
            }

            initServiceWorker() {
                if ('serviceWorker' in navigator) {
                    const swCode = `
                        self.addEventListener('install', (event) => self.skipWaiting());
                        self.addEventListener('activate', (event) => event.waitUntil(clients.claim()));
                        self.addEventListener('fetch', (event) => {
                            const url = new URL(event.request.url);
                            if (url.pathname.endsWith('.glb') || url.pathname.endsWith('.gltf')) {
                                event.respondWith(
                                    caches.open('ar-models-v1').then(async (cache) => {
                                        const cached = await cache.match(event.request);
                                        if (cached) return cached;
                                        const net = await fetch(event.request);
                                        cache.put(event.request, net.clone());
                                        return net;
                                    })
                                );
                            }
                        });
                    `;
                    const blob = new Blob([swCode], {type: 'text/javascript'});
                    navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(e => console.warn(e));
                }
            }

            initAuthListener() {
                onAuthStateChanged(this.auth, (user) => {
                    state.user = user;
                    if (user) {
                        state.isAdmin = (user.email === ADMIN_EMAIL);
                        this.navTo('dashboard');
                        this.loadProjects();
                        document.getElementById('user-role-display').textContent = state.isAdmin ? `ADMINISTRADOR (${user.email})` : `CREADOR (${user.email})`;
                    } else {
                        if (!new URLSearchParams(window.location.search).has('id')) {
                            this.navTo('auth');
                        }
                    }
                });

                document.getElementById('auth-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
                document.getElementById('register-btn').addEventListener('click', () => this.handleRegister());
                document.getElementById('guest-btn').addEventListener('click', () => {
                    const id = prompt("Ingresa el ID del Proyecto:");
                    if(id) window.location.href = `?id=${id}`;
                });
            }

            async handleLogin() {
                const e = document.getElementById('email').value;
                const p = document.getElementById('password').value;
                this.loader(true, "Iniciando...");
                try { await signInWithEmailAndPassword(this.auth, e, p); } 
                catch (err) { this.toast("Error: " + err.message, "error"); }
                this.loader(false);
            }

            async handleRegister() {
                const e = document.getElementById('email').value;
                const p = document.getElementById('password').value;
                this.loader(true, "Registrando...");
                try { 
                    await createUserWithEmailAndPassword(this.auth, e, p);
                    this.toast("¬°Bienvenido!"); 
                } catch (err) { this.toast("Error: " + err.message, "error"); }
                this.loader(false);
            }

            logout() { signOut(this.auth); }

            async loadProjects() {
                const list = document.getElementById('projects-list');
                list.innerHTML = '<div class="text-center text-gray-400 mt-10">Cargando...</div>';
                try {
                    let q;
                    if (state.isAdmin) q = query(collection(this.db, "projects"));
                    else q = query(collection(this.db, "projects"), where("ownerId", "==", state.user.uid));

                    const snapshot = await getDocs(q);
                    list.innerHTML = '';
                    
                    if (snapshot.empty) {
                        list.innerHTML = '<div class="text-center text-gray-400 mt-10">No hay proyectos a√∫n.</div>';
                        return;
                    }

                    snapshot.forEach(docSnap => {
                        const p = docSnap.data();
                        const pid = docSnap.id;
                        const isOwner = (p.ownerId === state.user.uid);

                        const card = document.createElement('div');
                        card.className = 'project-card';
                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold text-gray-800">${p.name}</h3>
                                    <p class="text-xs text-gray-500 font-mono">ID: ${pid}</p>
                                </div>
                                <button onclick="app.shareProject('${pid}')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold">üîó Link</button>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="app.openProject('${pid}', 'view')" class="flex-1 bg-gray-800 text-white py-2 rounded-lg text-xs font-bold">Ver AR</button>
                                ${isOwner || state.isAdmin ? `<button onclick="app.openProject('${pid}', 'edit')" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 rounded-lg text-xs font-bold">Editar</button>` : ''}
                            </div>
                        `;
                        list.appendChild(card);
                    });
                } catch (e) {
                    console.error(e);
                    list.innerHTML = '<p class="text-red-500 text-center">Error cargando lista</p>';
                }
            }

            newProject() {
                state.currentProject = null;
                state.tempFile = null;
                document.getElementById('project-name').value = "";
                document.getElementById('file-name').textContent = "M√°x 50MB";
                document.getElementById('upload-overlay').classList.remove('hidden');
                this.navTo('editor');
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    state.tempFile = file;
                    document.getElementById('file-name').textContent = file.name;
                }
            }

            async uploadAndStart() {
                const name = document.getElementById('project-name').value;
                if (!name || !state.tempFile) return this.toast("Falta nombre o archivo", "error");
                this.loader(true, "Subiendo...");
                try {
                    const storageRef = ref(this.storage, `models/${state.user.uid}/${Date.now()}_${state.tempFile.name}`);
                    const snap = await uploadBytes(storageRef, state.tempFile);
                    const url = await getDownloadURL(snap.ref);
                    const newDoc = doc(collection(this.db, "projects"));
                    const projData = {
                        name: name, modelUrl: url, ownerId: state.user.uid, ownerEmail: state.user.email,
                        coords: { lat: 0, lon: 0 }, calibration: { x:0, y:0, z:0, r:0 },
                        createdAt: new Date().toISOString()
                    };
                    await setDoc(newDoc, projData);
                    state.currentProject = { id: newDoc.id, data: projData };
                    document.getElementById('upload-overlay').classList.add('hidden');
                    this.initMap(0, 0);
                } catch (e) {
                    console.error(e);
                    this.toast("Error al subir.", "error");
                }
                this.loader(false);
            }

            async saveProjectData() {
                if (!state.currentProject) return;
                const ll = state.map.getCenter();
                this.loader(true, "Guardando...");
                try {
                    await updateDoc(doc(this.db, "projects", state.currentProject.id), {
                        "coords.lat": ll.lat, "coords.lon": ll.lng
                    });
                    this.toast("¬°Guardado!");
                    this.navTo('dashboard');
                    this.loadProjects();
                } catch (e) { this.toast("Error guardando", "error"); }
                this.loader(false);
            }

            async checkUrlParams() {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (id) this.openProject(id, 'view');
            }

            async openProject(id, mode) {
                this.loader(true, "Cargando...");
                try {
                    const docSnap = await getDoc(doc(this.db, "projects", id));
                    if (!docSnap.exists()) throw new Error("No existe");
                    const data = docSnap.data();
                    state.currentProject = { id, data };
                    
                    if (mode === 'edit') {
                        document.getElementById('upload-overlay').classList.add('hidden');
                        this.navTo('editor');
                        this.initMap(data.coords.lat, data.coords.lon);
                    } else {
                        this.navTo('ar');
                        this.startARSession(data);
                    }
                } catch (e) {
                    this.toast(e.message, "error");
                    if(!state.user) this.navTo('auth'); else this.navTo('dashboard');
                }
                this.loader(false);
            }

            startARSession(data) {
                if (!window.AFRAME) {
                    this.loadScript('https://aframe.io/releases/1.3.0/aframe.min.js')
                        .then(() => this.loadScript('https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'))
                        .then(() => this.renderScene(data));
                } else {
                    this.renderScene(data);
                }
                const canEdit = state.user && (state.user.uid === data.ownerId || state.isAdmin);
                document.getElementById('admin-save-btn').classList.toggle('hidden', !canEdit);
            }

            renderScene(data) {
                const t = data.coords;
                const c = data.calibration || {x:0,y:0,z:0,r:0};
                state.calibration = c;
                const sceneHTML = `
                    <a-scene embedded vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true;" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
                        <a-camera gps-camera="minDistance: 1;" rotation-reader></a-camera>
                        <a-entity gps-entity-place="latitude: ${t.lat}; longitude: ${t.lon};">
                            <a-entity id="model-entity" position="${c.x} ${c.y} ${c.z}" rotation="0 ${c.r} 0" scale="1 1 1">
                                <a-entity gltf-model="${data.modelUrl}"></a-entity>
                            </a-entity>
                        </a-entity>
                        <a-light type="ambient" intensity="1.2"></a-light>
                        <a-light type="directional" position="-1 1 0" intensity="1.5"></a-light>
                    </a-scene>
                `;
                document.getElementById('ar-gps-container').innerHTML = sceneHTML;
                window.addEventListener('gps-camera-update-position', e => {
                    document.getElementById('gps-acc').textContent = e.detail.position.accuracy.toFixed(0);
                });
            }

            shareProject(id) {
                const url = `${window.location.origin}${window.location.pathname}?id=${id}`;
                navigator.clipboard.writeText(url);
                this.toast("¬°Link Copiado!");
            }

            async downloadJSON(id) {
                const docSnap = await getDoc(doc(this.db, "projects", id));
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(docSnap.data(), null, 2));
                const el = document.createElement('a');
                el.setAttribute("href", dataStr);
                el.setAttribute("download", `proyecto_${id}.json`);
                document.body.appendChild(el); el.click(); el.remove();
            }

            initMap(lat, lon) {
                const container = document.getElementById('map-canvas');
                if (state.map) state.map.remove();
                const center = (lat && lon) ? [lat, lon] : [4.6097, -74.0817];
                state.map = L.map(container, { layers: [L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 })], zoomControl: false }).setView(center, 18);
                const icon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41] });
                const marker = L.marker(center, { draggable: true, icon: icon }).addTo(state.map);
                const updateUI = (e) => {
                    const ll = e.target.getLatLng();
                    document.getElementById('editor-lat').textContent = ll.lat.toFixed(6);
                    document.getElementById('editor-lon').textContent = ll.lng.toFixed(6);
                };
                marker.on('drag', updateUI);
            }

            useGPS() {
                navigator.geolocation.getCurrentPosition(pos => {
                    if(state.map) {
                        const ll = [pos.coords.latitude, pos.coords.longitude];
                        state.map.setView(ll, 19);
                        state.map.eachLayer((layer) => { if(layer instanceof L.Marker) layer.setLatLng(ll); });
                        document.getElementById('editor-lat').textContent = ll[0].toFixed(6);
                        document.getElementById('editor-lon').textContent = ll[1].toFixed(6);
                    }
                });
            }

            toggleCal() { document.getElementById('cal-hud').classList.toggle('active'); }
            
            adj(axis, val) {
                const c = state.calibration;
                if (axis === 'r') c.r += val; else c[axis] += val;
                const el = document.getElementById('model-entity');
                if (el) {
                    el.setAttribute('position', `${c.x} ${c.y} ${c.z}`);
                    el.setAttribute('rotation', `0 ${c.r} 0`);
                    this.toast(`${axis.toUpperCase()}: ${val}`);
                }
            }

            async saveCalibration() {
                if (!state.currentProject) return;
                try {
                    await updateDoc(doc(this.db, "projects", state.currentProject.id), { calibration: state.calibration });
                    this.toast("¬°Calibraci√≥n Guardada!");
                } catch (e) { this.toast("Error guardando", "error"); }
            }
            
            openSurface() {
                const v = document.getElementById('viewer');
                v.src = state.currentProject.data.modelUrl;
                document.getElementById('ar-surface-container').classList.remove('hidden');
            }
            closeSurface() { document.getElementById('ar-surface-container').classList.add('hidden'); }
            
            exitAR() {
                if (window.location.search.includes('id')) window.location.reload();
                else { this.navTo('dashboard'); window.location.reload(); }
            }

            navTo(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById('view-' + viewId).classList.add('active');
                if(viewId === 'editor' && state.map) state.map.invalidateSize();
            }

            toast(msg, type) {
                const t = document.getElementById('toast');
                t.querySelector('#toast-msg').textContent = msg;
                t.style.background = type === 'error' ? '#ef4444' : '#1f2937';
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }

            loader(show, text) {
                const l = document.getElementById('loader');
                if(show) {
                    document.getElementById('loader-text').textContent = text;
                    l.classList.remove('hidden');
                } else l.classList.add('hidden');
            }
            
            loadScript(src) {
                return new Promise(r => { const s = document.createElement('script'); s.src = src; s.onload = r; document.head.appendChild(s); });
            }
        }

        document.getElementById('model-input').addEventListener('change', (e) => window.app.handleFileSelect(e));
        window.app = new App();
    </script>
</body>
</html>

