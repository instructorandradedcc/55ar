<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>AR Constructor Pro v1.0</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://github.com/instructorandradedcc/55ar/raw/main/favicon3dAR.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet (Mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* CORE STYLES */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; touch-action: manipulation; }
        body { background-color: #f3f4f6; font-family: ui-sans-serif, system-ui, sans-serif; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        
        /* PAGES SYSTEM */
        .page { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; overflow-y: auto; z-index: 10; background: #f3f4f6; }
        .page.active { display: flex; flex-direction: column; }
        .ui-layer { z-index: 50; position: relative; }
        
        /* SLIDERS */
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #fff; border: 2px solid #2563eb; margin-top: -10px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(200,200,200,0.5); border-radius: 2px; }
        
        /* NOTIFICATIONS */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(15,23,42,0.95); color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: 600; z-index: 10000; transition: 0.3s; pointer-events: none; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); white-space: nowrap; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        
        /* PERMISSION MODAL */
        .perm-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.98); z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; color: white; transition: opacity 0.3s; }
        .perm-overlay.hidden { opacity: 0; pointer-events: none; }
        
        /* AR FIXES */
        video { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; object-fit: cover !important; z-index: -2 !important; }
        a-scene { display: block; position: relative; height: 100%; width: 100%; z-index: 1; }
    </style>

    <script>
        // MOTOR DE CARGA INTELIGENTE
        let arLoaded = false;
        const loadAR = () => {
            if(arLoaded) return Promise.resolve();
            return new Promise((resolve, reject) => {
                console.log("Cargando motor AR...");
                const s1 = document.createElement('script'); 
                s1.src = 'https://aframe.io/releases/1.3.0/aframe.min.js';
                s1.onload = () => {
                    const s2 = document.createElement('script'); 
                    s2.src = 'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js';
                    s2.onload = () => { 
                        // Cargar extras para animaciones si es necesario
                        const s3 = document.createElement('script');
                        s3.src = 'https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js';
                        s3.onload = () => {
                            arLoaded = true; 
                            resolve(); 
                        };
                        document.head.appendChild(s3);
                    };
                    s2.onerror = reject; 
                    document.head.appendChild(s2);
                };
                s1.onerror = reject; 
                document.head.appendChild(s1);
            });
        };
    </script>
</head>
<body>

    <!-- UI GLOBAL -->
    <div id="toast" class="toast">Notificaci√≥n</div>

    <!-- MODAL DE PERMISOS (GATEKEEPER) -->
    <div id="perm-modal" class="perm-overlay hidden">
        <div class="bg-white text-slate-800 p-6 rounded-2xl max-w-sm w-full shadow-2xl transform transition-all">
            <div class="text-5xl mb-4 text-center">üîê</div>
            <h2 class="text-xl font-bold mb-2 text-center">Acceso Requerido</h2>
            <p class="text-sm text-slate-600 mb-6 text-center">Para anclar el modelo 3D en el mundo real, necesitamos acceso a:</p>
            <div class="space-y-3">
                <div class="flex justify-between bg-slate-50 p-3 rounded-lg border border-slate-100"><span class="text-sm font-bold">üìç GPS Preciso</span><span id="st-gps" class="text-xs font-bold text-orange-500">Pendiente</span></div>
                <div class="flex justify-between bg-slate-50 p-3 rounded-lg border border-slate-100"><span class="text-sm font-bold">üì∏ C√°mara AR</span><span id="st-cam" class="text-xs font-bold text-orange-500">Pendiente</span></div>
            </div>
            <button id="btn-grant" class="mt-6 w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition">CONTINUAR</button>
            <button onclick="app.modal(false)" class="mt-3 w-full text-slate-400 text-xs font-bold py-2">CANCELAR</button>
        </div>
    </div>

    <!-- 1. UPLOAD PAGE -->
    <div id="upload-page" class="page active items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-xl overflow-hidden ui-layer">
            <div class="bg-slate-50 p-6 text-center border-b border-slate-100">
                <img src="https://github.com/instructorandradedcc/55ar/raw/main/logofundaciontrasparencia.png" class="h-14 mx-auto mb-2 object-contain">
                <h1 class="text-lg font-bold text-slate-800">AR Constructor <span class="text-blue-600">Pro</span></h1>
                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">v1.0 Final</p>
            </div>
            <div class="p-6 space-y-5">
                <!-- File Input -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">1. Modelo 3D (.glb)</label>
                    <div class="relative mt-1 group">
                        <input type="file" id="model-in" accept=".glb" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center bg-slate-50 transition group-hover:border-blue-400">
                            <p id="file-lbl" class="text-sm font-medium text-slate-600 truncate">Toca para subir archivo</p>
                        </div>
                    </div>
                </div>
                <!-- Coordinates -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">2. Coordenadas</label>
                        <button id="gps-btn" class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-bold hover:bg-blue-200 flex gap-1">üìç Mi Ubicaci√≥n</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="lat-in" placeholder="Latitud" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="number" id="lng-in" placeholder="Longitud" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <!-- Buttons -->
                <button id="save-btn" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-emerald-700 active:scale-95 transition">üíæ Guardar Datos</button>
                <div class="grid grid-cols-2 gap-3">
                    <button id="btn-goto-map" class="bg-white border text-slate-700 py-3 rounded-xl font-bold text-sm hover:bg-slate-50 active:scale-95 transition">üó∫Ô∏è Mapa</button>
                    <button id="btn-goto-scale" class="bg-white border text-slate-700 py-3 rounded-xl font-bold text-sm hover:bg-slate-50 active:scale-95 transition">üìè Escala</button>
                </div>
                <div class="text-center pt-2"><button onclick="if(confirm('¬øReset?')) location.reload()" class="text-xs text-red-300 underline">Resetear App</button></div>
            </div>
        </div>
    </div>

    <!-- 2. MAP PAGE -->
    <div id="map-page" class="page">
        <div id="map-c" class="w-full h-full z-0"></div>
        <div class="absolute top-4 left-4 z-20">
            <button onclick="app.nav('upload')" class="bg-white/90 backdrop-blur px-4 py-2 rounded-lg shadow font-bold text-xs text-slate-700 active:scale-95 transition">‚Üê Volver</button>
        </div>
        <div class="absolute bottom-8 left-0 w-full px-6 z-20 pointer-events-none">
            <div class="bg-white/95 backdrop-blur p-4 rounded-2xl shadow-2xl pointer-events-auto text-center max-w-sm mx-auto">
                <p class="text-xs text-slate-500 mb-3 font-medium">Mueve el mapa para ajustar el objetivo</p>
                <div class="flex gap-2">
                    <button id="map-set" class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold text-xs shadow active:scale-95 transition">FIJAR AQU√ç</button>
                    <button onclick="app.preStartAR()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold text-xs shadow active:scale-95 transition">INICIAR AR üöÄ</button>
                </div>
            </div>
        </div>
        <!-- Crosshair -->
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none z-10">
            <div class="w-8 h-8 border-2 border-white rounded-full shadow-lg"></div>
            <div class="w-1 h-1 bg-red-500 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 rounded-full"></div>
        </div>
    </div>

    <!-- 3. SCALE PAGE -->
    <div id="scale-page" class="page items-center justify-center p-4 bg-white">
        <div class="w-full max-w-md space-y-5">
            <h2 class="text-xl font-bold text-center text-slate-800">Dimensiones Reales (m)</h2>
            <div class="space-y-3">
                <div><label class="text-[10px] font-bold text-slate-400">ANCHO (X)</label><input id="d-w" type="number" class="w-full bg-slate-50 border p-3 rounded-xl font-mono font-bold" value="10"></div>
                <div><label class="text-[10px] font-bold text-slate-400">ALTO (Y)</label><input id="d-h" type="number" class="w-full bg-slate-50 border p-3 rounded-xl font-mono font-bold" value="3"></div>
                <div><label class="text-[10px] font-bold text-slate-400">FONDO (Z)</label><input id="d-d" type="number" class="w-full bg-slate-50 border p-3 rounded-xl font-mono font-bold" value="10"></div>
                <div class="pt-4 border-t">
                    <label class="text-[10px] font-bold text-slate-400 flex justify-between"><span>DISTANCIA VISIBLE</span><span id="dist-txt" class="text-blue-600">100m</span></label>
                    <input id="d-dist" type="range" min="10" max="500" value="100" class="w-full mt-2">
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="app.nav('upload')" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold active:scale-95 transition">Cancelar</button>
                <button id="save-dims" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow active:scale-95 transition">Guardar</button>
            </div>
        </div>
    </div>

    <!-- 4. AR PAGE -->
    <div id="ar-page" class="page bg-black">
        <div id="ar-c"></div>
        
        <!-- AR UI Layer -->
        <div class="absolute inset-0 pointer-events-none z-50 flex flex-col justify-between p-4">
            <!-- Top Bar -->
            <div class="flex justify-between items-start pointer-events-auto">
                <div class="bg-black/60 backdrop-blur text-white px-3 py-1 rounded-full text-xs font-mono border border-white/10 shadow-lg">
                    GPS: <span id="ar-gps" class="text-yellow-400">...</span>
                </div>
                <button onclick="$('adj-p').classList.toggle('hidden')" class="bg-black/60 backdrop-blur p-2 rounded-lg text-white border border-white/10 shadow-lg active:scale-95 transition">‚öôÔ∏è Ajustes</button>
            </div>
            
            <!-- Adjustment Panel -->
            <div id="adj-p" class="absolute top-14 right-4 w-64 bg-black/80 backdrop-blur p-4 rounded-2xl border border-white/10 text-white pointer-events-auto hidden transition-all">
                <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-3 border-b border-white/10 pb-2">Calibraci√≥n en Sitio</h4>
                <div class="space-y-4">
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Rayos X (Opacidad)</span><span id="l-op" class="text-blue-400">100%</span></div><input type="range" id="s-op" min="0" max="1" step="0.1" value="1"></div>
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Altura Suelo</span><span id="l-h" class="text-blue-400">0m</span></div><input type="range" id="s-h" min="-10" max="10" step="0.5" value="0"></div>
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Escala</span><span id="l-s" class="text-blue-400">1.0x</span></div><input type="range" id="s-s" min="0.1" max="3" step="0.05" value="1"></div>
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Rotaci√≥n</span><span id="l-r" class="text-blue-400">0¬∞</span></div><input type="range" id="s-r" min="0" max="360" step="5" value="0"></div>
                </div>
            </div>

            <!-- Bottom Buttons -->
            <div class="flex justify-center pointer-events-auto pb-8">
                <button onclick="location.reload()" class="bg-red-500/90 backdrop-blur text-white px-8 py-3 rounded-full font-bold shadow-xl hover:bg-red-600 active:scale-95 transition text-sm flex items-center gap-2">
                    ‚ùå SALIR
                </button>
            </div>
        </div>

        <!-- Loader -->
        <div id="ar-load" class="perm-overlay hidden">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-lg font-bold">Iniciando Motor AR...</p>
            <p class="text-xs text-slate-400 mt-2">Esto puede tomar unos segundos</p>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        
        // UTILIDADES DOM
        const $ = id => document.getElementById(id);
        const toast = msg => { 
            const t = $('toast'); 
            t.textContent = msg; 
            t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 3000); 
        };

        // ESTADO GLOBAL
        const st = { 
            url: null, 
            lat: 0, 
            lng: 0, 
            adj: { h: 0, s: 1, r: 0, op: 1 } 
        };
        
        let map, mk, arEnt;

        // --- LOGICA DE PERMISOS ---
        const perms = {
            req: async () => {
                // 1. GPS
                $('st-gps').textContent = "Solicitando...";
                try {
                    await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 10000 }));
                    $('st-gps').innerHTML = "‚úÖ OK"; $('st-gps').className = "text-xs font-bold text-emerald-500";
                } catch(e) { 
                    alert("GPS Requerido. Por favor act√≠valo."); 
                    $('st-gps').textContent = "‚ùå Error";
                    return; 
                }

                // 2. CAMARA
                $('st-cam').textContent = "Solicitando...";
                try {
                    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    s.getTracks().forEach(t => t.stop()); // Liberar inmediatamente
                    $('st-cam').innerHTML = "‚úÖ OK"; $('st-cam').className = "text-xs font-bold text-emerald-500";
                } catch(e) { 
                    alert("C√°mara Requerida."); 
                    $('st-cam').textContent = "‚ùå Error";
                    return; 
                }

                // 3. LANZAR
                setTimeout(() => { 
                    app.modal(false); 
                    app.runAR(); 
                }, 800);
            }
        };

        // --- LOGICA APP ---
        const app = {
            nav: p => { 
                document.querySelectorAll('.page').forEach(x => x.classList.remove('active')); 
                $(p + '-page').classList.add('active'); 
                if(p === 'map') initMap(); 
            },
            
            modal: show => {
                const m = $('perm-modal');
                if(show) m.classList.remove('hidden');
                else m.classList.add('hidden');
            },

            file: e => { 
                const f = e.target.files[0]; 
                if(f){ 
                    st.url = URL.createObjectURL(f); 
                    $('file-lbl').textContent = "‚úÖ " + f.name; 
                    $('drop-zone').classList.add('bg-blue-50','border-blue-500'); 
                    toast("Modelo cargado en memoria");
                } 
            },
            
            gps: () => {
                toast("Obteniendo GPS...");
                navigator.geolocation.getCurrentPosition(p => {
                    $('lat-in').value = p.coords.latitude.toFixed(6); 
                    $('lng-in').value = p.coords.longitude.toFixed(6); 
                    toast("Ubicaci√≥n actualizada");
                }, e => alert("Error GPS: " + e.message), { enableHighAccuracy: true });
            },
            
            save: () => {
                st.lat = parseFloat($('lat-in').value); 
                st.lng = parseFloat($('lng-in').value);
                if(!st.url) return toast("‚ö†Ô∏è Falta subir el Modelo 3D"); 
                if(isNaN(st.lat)) return toast("‚ö†Ô∏è Faltan Coordenadas");
                
                // Persistencia simple
                localStorage.setItem('ardata', JSON.stringify({lat:st.lat, lng:st.lng})); 
                toast("Datos Guardados Correctamente"); 
                app.nav('map');
            },
            
            preStartAR: () => { 
                if(!st.url) return toast("‚ö†Ô∏è No hay modelo cargado"); 
                app.modal(true); 
            },
            
            runAR: async () => {
                app.nav('ar'); 
                $('ar-load').classList.remove('hidden');
                try { 
                    await loadAR(); 
                    initScene(); 
                } catch(e) { 
                    alert("Error Fatal: " + e); 
                    location.reload(); 
                }
            }
        };

        // --- MAPA ---
        function initMap() {
            setTimeout(() => {
                if(!map) {
                    map = L.map('map-c').setView([st.lat||0, st.lng||0], 18);
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Esri'}).addTo(map);
                } else map.invalidateSize();
                
                const pos = [parseFloat($('lat-in').value)||0, parseFloat($('lng-in').value)||0];
                if(pos[0] !== 0){ 
                    if(mk) mk.setLatLng(pos); 
                    else mk = L.marker(pos).addTo(map); 
                    map.setView(pos, 18); 
                }
            }, 200);
        }

        // --- AR SCENE ---
        function initScene() {
            // Limpieza
            $('ar-c').innerHTML = '';
            
            // Inyecci√≥n HTML A-Frame
            const html = `
                <a-scene 
                    embedded 
                    vr-mode-ui="enabled: false" 
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;" 
                    renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: true;">
                    
                    <a-camera gps-camera="minDistance: 2;" rotation-reader near="0.1" far="10000"></a-camera>
                    
                    <a-light type="ambient" intensity="1"></a-light>
                    <a-light type="directional" intensity="1.5" position="-1 1 0"></a-light>
                    
                    <a-entity 
                        id="ent" 
                        gps-entity-place="latitude: ${st.lat}; longitude: ${st.lng};" 
                        position="0 0 0" 
                        scale="1 1 1" 
                        gltf-model="${st.url}" 
                        visible="false">
                    </a-entity>
                </a-scene>
            `;
            $('ar-c').innerHTML = html;
            
            const el = document.querySelector('#ent'); 
            arEnt = el;

            // Evento Carga Exitosa
            el.addEventListener('model-loaded', () => {
                // Truco Doble Cara (Ver Interiores)
                const mesh = el.getObject3D('mesh');
                if(mesh) {
                    mesh.traverse(n => { 
                        if(n.isMesh){ 
                            n.material.side = THREE.DoubleSide; 
                            n.material.transparent = true; 
                            n.material.needsUpdate = true; 
                        }
                    });
                }
                el.setAttribute('visible', 'true'); 
                $('ar-load').classList.add('hidden'); 
                toast("‚úÖ Modelo Anclado en el Mundo Real");
            });
            
            // Evento Error
            el.addEventListener('model-error', (e) => {
                $('ar-load').classList.add('hidden');
                alert("Error en el archivo GLB: " + e.detail);
                app.nav('upload');
            });

            // GPS Monitor
            window.addEventListener('gps-camera-update-position', e => {
                const acc = Math.round(e.detail.position.accuracy);
                const txt = $('ar-gps');
                txt.textContent = `¬±${acc}m`; 
                txt.className = acc < 10 ? "text-emerald-400 font-bold" : "text-red-400 font-bold";
            });
        }

        // --- INICIALIZACI√ìN ---
        window.addEventListener('DOMContentLoaded', () => {
            // Listeners Botones Principales
            $('model-in').addEventListener('change', app.file);
            $('gps-btn').addEventListener('click', app.gps);
            $('save-btn').addEventListener('click', app.save);
            $('btn-goto-map').addEventListener('click', () => app.nav('map'));
            $('btn-goto-scale').addEventListener('click', () => app.nav('scale'));
            
            // Mapa
            $('map-set').addEventListener('click', () => { 
                const c = map.getCenter(); 
                $('lat-in').value = c.lat.toFixed(6); 
                $('lng-in').value = c.lng.toFixed(6); 
                st.lat = c.lat; st.lng = c.lng; 
                if(mk) mk.setLatLng(c); else mk = L.marker(c).addTo(map); 
                toast("üìç Ubicaci√≥n Fijada"); 
            });

            // Escala
            $('save-dims').addEventListener('click', () => { 
                toast("Dimensiones Guardadas"); 
                app.nav('upload'); 
            });
            
            // Permisos
            $('btn-grant').addEventListener('click', perms.req);
            
            // Sliders Tiempo Real
            const upd = () => {
                if(!arEnt) return;
                arEnt.setAttribute('position', `0 ${st.adj.h} 0`); 
                arEnt.setAttribute('scale', `${st.adj.s} ${st.adj.s} ${st.adj.s}`); 
                arEnt.setAttribute('rotation', `0 ${st.adj.r} 0`);
                const m = arEnt.getObject3D('mesh');
                if(m) m.traverse(n => { if(n.isMesh) n.material.opacity = st.adj.op; });
            };
            
            $('s-op').oninput = e => { st.adj.op = parseFloat(e.target.value); $('l-op').textContent=Math.round(st.adj.op*100)+'%'; upd(); };
            $('s-h').oninput = e => { st.adj.h = parseFloat(e.target.value); $('l-h').textContent=st.adj.h+'m'; upd(); };
            $('s-s').oninput = e => { st.adj.s = parseFloat(e.target.value); $('l-s').textContent=st.adj.s+'x'; upd(); };
            $('s-r').oninput = e => { st.adj.r = parseFloat(e.target.value); $('l-r').textContent=st.adj.r+'¬∞'; upd(); };
            $('d-dist').oninput = e => $('dist-txt').textContent = e.target.value+'m';

            // Exponer app globalmente
            window.app = app;
        });
    </script>
</body>
</html>


